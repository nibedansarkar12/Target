<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Target Zone ‚Äî Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{ --bg:#0a0f1a; --panel: rgba(255,255,255,0.05); --border: rgba(255,255,255,0.08); --muted:#a5b4fc; }
    html,body{ margin:0; padding:0; background: radial-gradient(1200px 800px at 10% -10%, rgba(34,211,238,.14), transparent), radial-gradient(900px 700px at 120% 0, rgba(99,102,241,.18), transparent), var(--bg); color:#e5e7eb; font-family:Inter, system-ui, Segoe UI, Roboto, Arial; }
    .container{ max-width:1200px; margin:0 auto; padding:18px; }
    .nav{ display:flex; gap:10px; flex-wrap:wrap; }
    .nav button{ border:none; padding:8px 12px; border-radius:10px; background:var(--panel); color:#fff; cursor:pointer; border:1px solid var(--border); }
    .nav button.active{ outline:2px solid #22d3ee; }
    .panel{ background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); padding:16px; border-radius:14px; border:1px solid var(--border); box-shadow: 0 14px 40px rgba(2,6,23,.45); }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .col{ flex:1 1 360px; }
    input, select, textarea, button{ font-family:inherit; }
    input, select, textarea{ background: rgba(255,255,255,0.06); border:1px solid var(--border); color:#fff; padding:10px 12px; border-radius:10px; width:100%; }
    label{ font-weight:700; font-size:.95rem; color:#fff; display:block; margin:2px 0 6px; }
    .btn{ border:none; border-radius:10px; padding:10px 12px; background:#16a34a; color:white; font-weight:800; cursor:pointer; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ border-bottom:1px solid var(--border); padding:10px; text-align:left; }
    .muted{ color:var(--muted); }
    .chip{ padding:4px 8px; border-radius:8px; background: rgba(255,255,255,0.06); border:1px solid var(--border); font-weight:800; font-size:.8rem; }
  </style>
</head>
<body>
  <div class="container">
    <header style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <h1 style="margin:0; font-weight:900;">üéØ Target Zone ‚Äî Admin Panel</h1>
      <div>
        <button id="logout-btn" class="btn" style="background:#ef4444;">Logout</button>
      </div>
    </header>

    <nav class="nav" style="margin-top:12px;">
      <button onclick="showSection('add')" class="active">Add Questions</button>
      <button onclick="showSection('results')">Results</button>
      <button onclick="showSection('users')">Users</button>
      <button onclick="showSection('extras')">Payments & Forms</button>
      <button onclick="showSection('analytics')">Analytics</button>
    </nav>

    <!-- ========== ADD QUESTIONS ========== -->
    <section id="section-add" class="panel" style="margin-top:14px;">
      <div class="row">
        <div class="col">
          <label>‡¶Æ‡ßá‡¶á‡¶® ‡¶ü‡¶™‡¶ø‡¶ï (Exam)</label>
          <select id="category" onchange="handleCategoryChange(this.value)">
            <option value="">‚Äî Select ‚Äî</option>
            <option value="ssc">SSC</option>
            <option value="railways">Railways</option>
            <option value="tet">TET</option>
            <option value="wbset">WB SET</option>
            <option value="wbjee">WBJEE</option>
            <option value="madhyamik">Madhyamik</option>
          </select>
        </div>
        <div class="col">
          <label>Topic</label>
          <input id="topic" placeholder="e.g. Polity / Mensuration" />
        </div>
      </div>

      <!-- Set Manager (NEW) -->
      <div id="set-manager" class="panel" style="margin-top:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <strong>Set Manager</strong>
          <div id="active-set-wrap" class="chip" style="display:none; align-items:center; gap:8px;">Active Set: <span id="active-set-name">‚Äî</span> <button id="clear-set" class="btn" style="background:#ef4444;padding:4px 8px;">Clear</button></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="col">
            <label>‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßá‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
            <div style="display:flex; gap:8px;">
              <input id="set-name-input" placeholder="e.g. SET-A (Jan 2025)" />
              <button class="btn" onclick="useOrCreateSet()">Create / Use</button>
            </div>
            <div class="muted" style="margin-top:6px;">‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßá <b>Create / Use</b> ‡¶ö‡¶æ‡¶™‡¶≤‡ßá ‡¶∏‡ßá‡¶ü‡¶ø Active ‡¶π‡¶¨‡ßá‡•§ ‡¶≤‡ßã‡¶° ‡¶®‡ßá‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶æ‡¶Æ‡¶ü‡¶ø ‡¶¨‡¶¶‡¶≤‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‚Äî‡¶Ü‡¶™‡¶®‡¶ø ‡¶®‡¶ø‡¶ú‡ßá Clear ‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§</div>
          </div>
          <div class="col">
            <label>‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶∏‡ßá‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶æ‡¶õ‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®</label>
            <details id="sets-chooser">
              <summary style="cursor:pointer; user-select:none;">Click to open list</summary>
              <div id="existing-sets" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap:8px; margin-top:8px;"></div>
            </details>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="col">
          <label>Question</label>
          <textarea id="question" rows="3" placeholder="Write the question text..."></textarea>
        </div>
        <div class="col">
          <label>Image (optional)</label>
          <input type="file" id="image" accept="image/*" />
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="col"><label>Option A</label><input id="optionA"></div>
        <div class="col"><label>Option B</label><input id="optionB"></div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="col"><label>Option C</label><input id="optionC"></div>
        <div class="col"><label>Option D</label><input id="optionD"></div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="col">
          <label>Correct Answer</label>
          <select id="correct">
            <option value="">‚Äî Select ‚Äî</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
          </select>
        </div>
        <div class="col">
          <label>Difficulty</label>
          <select id="difficulty">
            <option>Easy</option>
            <option>Medium</option>
            <option>Hard</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; gap:8px;">
        <button class="btn" onclick="addQuestion()">Save Question</button>
        <button class="btn" style="background:#0ea5e9;" onclick="loadQuestions(document.getElementById('category').value)">Reload Questions</button>
      </div>

      <div style="margin-top:16px;">
        <h3 style="margin:0 0 8px 0; font-weight:900;">Questions in <span class="chip" id="q-cat">‚Äî</span> <span id="q-set-badge" class="chip" style="display:none;">Set: <span id="q-set"></span></span></h3>
        <table>
          <thead><tr><th>#</th><th>Question</th><th>Answer</th><th>Topic</th><th>Actions</th></tr></thead>
          <tbody id="questions-body"><tr><td colspan="5" class="muted">No data</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- ========== RESULTS ========== -->
    <section id="section-results" class="panel hidden" style="margin-top:14px;">
      <h3 style="margin:0 0 10px 0; font-weight:900;">Results</h3>
      <div class="row">
        <div class="col">
          <canvas id="results-chart" height="240"></canvas>
        </div>
        <div class="col">
          <table>
            <thead><tr><th>User</th><th>Exam</th><th>Score</th><th>Total</th><th>Date</th></tr></thead>
            <tbody id="results-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ========== USERS ========== -->
    <section id="section-users" class="panel hidden" style="margin-top:14px;">
      <h3 style="margin:0 0 10px 0; font-weight:900;">Users</h3>
      <table>
        <thead><tr><th>Name</th><th>Email</th><th>Created</th></tr></thead>
        <tbody id="users-body"></tbody>
      </table>
    </section>

    <!-- ========== EXTRAS ========== -->
    <section id="section-extras" class="panel hidden" style="margin-top:14px;">
      <h3 style="margin:0 0 10px 0; font-weight:900;">Payments & Forms</h3>
      <div class="row">
        <div class="col">
          <div class="panel">
            <strong>Form Submissions</strong>
            <table style="margin-top:10px;">
              <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Message</th><th>Time</th></tr></thead>
              <tbody id="submissions-body"><tr><td colspan="5" class="muted">No data</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== ANALYTICS (placeholder) ========== -->
    <section id="section-analytics" class="panel hidden" style="margin-top:14px;">
      <h3 style="margin:0 0 10px 0; font-weight:900;">Analytics</h3>
      <div class="muted">Overview graphs & counters can be placed here.</div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, doc, deleteDoc, setDoc, query, orderBy, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCR5rqthBh0vX0yLOcOG3b9xJiKbYtzdxU",
      authDomain: "target-zone-8fffd.firebaseapp.com",
      projectId: "target-zone-8fffd",
      storageBucket: "target-zone-8fffd.appspot.com",
      messagingSenderId: "667579216123",
      appId: "1:667579216123:web:37bb1fcc724743073d005e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    try{ enableIndexedDbPersistence(db); }catch(e){ console.warn('persistence', e.message) }

    // ====== Navigation ======
    function showSection(key){
      const map = { add:'section-add', results:'section-results', users:'section-users', extras:'section-extras', analytics:'section-analytics' };
      Object.values(map).forEach(id=> document.getElementById(id).classList.add('hidden'));
      document.getElementById(map[key]).classList.remove('hidden');
      document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
      const idx = ['add','results','users','extras','analytics'].indexOf(key);
      if(idx>-1) document.querySelectorAll('.nav button')[idx].classList.add('active');
    }
    window.showSection = showSection;

    document.getElementById('logout-btn').onclick = ()=> signOut(auth);

    onAuthStateChanged(auth, (user)=>{
      if(!user){ alert('Please login to access admin.'); location.href = '/'; return; }
      // initial list loads
      loadResults(); loadUsers();
    });

    // ====== Set Manager State ======
    let currentCategory = '';
    const activeSets = JSON.parse(localStorage.getItem('tz_active_sets') || '{}');
    function persistActive(){ localStorage.setItem('tz_active_sets', JSON.stringify(activeSets)); }

    window.handleCategoryChange = (cat)=>{
      currentCategory = cat || '';
      document.getElementById('q-cat').textContent = currentCategory || '‚Äî';
      renderActiveSetBadge();
      loadSets(currentCategory);
      loadQuestions(currentCategory);
    }

    function renderActiveSetBadge(){
      const wrap = document.getElementById('active-set-wrap');
      const nameEl = document.getElementById('active-set-name');
      const qBadge = document.getElementById('q-set-badge');
      const qName = document.getElementById('q-set');
      const v = currentCategory && activeSets[currentCategory];
      if (v){ wrap.style.display='inline-flex'; nameEl.textContent = v; qBadge.style.display='inline-flex'; qName.textContent = v; }
      else { wrap.style.display='none'; qBadge.style.display='none'; qName.textContent = ''; }
    }

    document.getElementById('clear-set').onclick = ()=>{ if(!currentCategory) return; delete activeSets[currentCategory]; persistActive(); renderActiveSetBadge(); loadQuestions(currentCategory); };

    async function loadSets(cat){
      const box = document.getElementById('existing-sets');
      box.innerHTML = '<div class="muted">Loading‚Ä¶</div>';
      if(!cat){ box.innerHTML = '<div class="muted">Select a category</div>'; return; }
      try{
        const snap = await getDocs(collection(db,'exams',cat,'sets'));
        if (snap.empty){ box.innerHTML = '<div class="muted">No sets yet</div>'; return; }
        box.innerHTML = '';
        snap.forEach(d=>{
          const data = d.data(); const name = data.name || d.id; const el = document.createElement('button');
          el.className = 'chip'; el.style.cssText = 'text-align:left; padding:8px;'; el.textContent = name; el.title = 'Click to make active & load questions';
          el.onclick = ()=>{ activeSets[cat] = name; persistActive(); renderActiveSetBadge(); loadQuestions(cat); };
          box.appendChild(el);
        });
      }catch(e){ box.innerHTML = `<div class="muted">Error: ${e.message}</div>`; }
    }

    window.useOrCreateSet = async function(){
      const cat = currentCategory || document.getElementById('category').value;
      const name = (document.getElementById('set-name-input').value||'').trim();
      if(!cat){ alert('‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶ó‡¶∞‡¶ø ‡¶¨‡¶æ‡¶õ‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®'); return; }
      if(!name){ alert('‡¶∏‡ßá‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®'); return; }
      try{
        await setDoc(doc(db,'exams',cat,'sets',name), { name, createdAt: new Date() }, { merge:true });
        activeSets[cat] = name; persistActive(); renderActiveSetBadge();
        loadSets(cat); // refresh list
        // do NOT clear the input automatically (admin requested persistence)
        loadQuestions(cat); // only questions table reloads
      }catch(e){ alert(e.message); }
    }

    // ====== Question CRUD (with nested path if a Set is active) ======
    window.addQuestion = async function(){
      const cat = currentCategory || document.getElementById('category').value;
      if(!cat){ alert('‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶ó‡¶∞‡¶ø ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá'); return; }

      const topic = (document.getElementById('topic').value||'').trim() || 'General';
      const qText = (document.getElementById('question').value||'').trim();
      const A = document.getElementById('optionA').value||'';
      const B = document.getElementById('optionB').value||'';
      const C = document.getElementById('optionC').value||'';
      const D = document.getElementById('optionD').value||'';
      const correct = document.getElementById('correct').value||'';
      const difficulty = document.getElementById('difficulty').value||'Easy';
      if(!qText || !correct){ alert('Question & Correct answer required'); return; }

      // optional image upload
      let imageUrl = null; const file = document.getElementById('image').files[0];
      if(file){ const r = sRef(storage, `questions/${Date.now()}_${file.name}`); await uploadBytes(r, file); imageUrl = await getDownloadURL(r); }

      const docData = {
        id: Date.now(), question: qText, options: [A,B,C,D], answer: { 'A':A, 'B':B, 'C':C, 'D':D }[correct] || correct,
        correctOption: correct, topic, difficulty, imageUrl, createdAt: new Date()
      };

      try{
        const active = activeSets[cat];
        if(active){
          await addDoc(collection(db, 'exams', cat, 'sets', active, 'questions'), docData);
        } else {
          // backward compatibility: old flat collection
          await addDoc(collection(db, cat), docData);
        }
        alert('Saved');
        loadQuestions(cat); // only table reloads; set name persists
      }catch(e){ alert(e.message); }
    }

    window.loadQuestions = async function(cat){
      if(!cat){ document.getElementById('questions-body').innerHTML = '<tr><td colspan="5" class="muted">Select a category</td></tr>'; return; }
      document.getElementById('q-cat').textContent = cat;
      renderActiveSetBadge();
      const tbody = document.getElementById('questions-body');
      tbody.innerHTML = '<tr><td colspan="5" class="muted">Loading‚Ä¶</td></tr>';
      try{
        const active = activeSets[cat];
        let snap;
        if(active){ snap = await getDocs(query(collection(db,'exams',cat,'sets',active,'questions'), orderBy('id'))); }
        else { snap = await getDocs(query(collection(db,cat), orderBy('id'))); }
        let i=0; tbody.innerHTML = '';
        snap.forEach(d=>{
          const q = d.data();
          const tr = document.createElement('tr');
          const ans = (q.correctOption) ? q.correctOption : (Array.isArray(q.options) ? ['A','B','C','D'][q.options.findIndex(x=>x===q.answer)] : q.answer);
          tr.innerHTML = `<td>${++i}</td><td>${q.question||''}</td><td>${ans||''}</td><td>${q.topic||''}</td><td><button class="btn" style="background:#ef4444" data-del="${d.id}">Delete</button></td>`;
          tbody.appendChild(tr);
        });
        if(!tbody.children.length) tbody.innerHTML = '<tr><td colspan="5" class="muted">No questions</td></tr>';
        // bind deletes
        tbody.querySelectorAll('[data-del]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            if(!confirm('Delete this question?')) return;
            try{
              const active = activeSets[cat];
              if(active){ await deleteDoc(doc(db,'exams',cat,'sets',active,'questions', btn.getAttribute('data-del'))); }
              else { await deleteDoc(doc(db,cat, btn.getAttribute('data-del'))); }
              loadQuestions(cat);
            }catch(e){ alert(e.message); }
          });
        });
      }catch(e){ tbody.innerHTML = `<tr><td colspan="5" class="muted">Error: ${e.message}</td></tr>`; }
    }

    // ====== RESULTS LIST & CHART ======
    async function loadResults(){
      const tbody = document.getElementById('results-body');
      tbody.innerHTML = '<tr><td colspan="5" class="muted">Loading‚Ä¶</td></tr>';
      try{
        const snap = await getDocs(query(collection(db,'results'), orderBy('submittedAt','desc')));
        const data = []; tbody.innerHTML = '';
        snap.forEach(d=>{ const r=d.data(); data.push(r); const tr=document.createElement('tr'); tr.innerHTML = `<td>${r.displayName||r.email||'User'}</td><td>${r.exam}</td><td>${r.score}</td><td>${r.total}</td><td>${(r.submittedAt && r.submittedAt.toDate) ? r.submittedAt.toDate().toLocaleString() : ''}</td>`; tbody.appendChild(tr); });
        renderResultsChart(data);
      }catch(e){ tbody.innerHTML = `<tr><td colspan="5" class="muted">Error: ${e.message}</td></tr>`; }
    }

    function renderResultsChart(rows){
      const ctx = document.getElementById('results-chart').getContext('2d');
      const byExam = {};
      rows.forEach(r=>{ byExam[r.exam] = (byExam[r.exam]||0) + (r.score||0); });
      const labels = Object.keys(byExam); const values = Object.values(byExam);
      new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Total Correct (sum)', data:values }] }, options:{ plugins:{ legend:{ labels:{ color:'#fff' } } }, scales:{ x:{ ticks:{ color:'#fff' } }, y:{ ticks:{ color:'#fff' } } } } });
    }

    // ====== USERS ======
    async function loadUsers(){
      const tbody = document.getElementById('users-body');
      tbody.innerHTML = '<tr><td colspan="3" class="muted">Loading‚Ä¶</td></tr>';
      try{
        const snap = await getDocs(query(collection(db,'users'), orderBy('createdAt','desc')));
        tbody.innerHTML = '';
        snap.forEach(d=>{ const u=d.data(); const tr=document.createElement('tr'); tr.innerHTML = `<td>${u.displayName||'-'}</td><td>${u.email||''}</td><td>${(u.createdAt && u.createdAt.toDate)? u.createdAt.toDate().toLocaleString(): ''}</td>`; tbody.appendChild(tr); });
        if(!tbody.children.length) tbody.innerHTML = '<tr><td colspan="3" class="muted">No users</td></tr>';
      }catch(e){ tbody.innerHTML = `<tr><td colspan="3" class="muted">Error: ${e.message}</td></tr>`; }
    }

    // ====== EXTRAS: FORM SUBMISSIONS ======
    async function loadSubmissions(){
      const tbody = document.getElementById('submissions-body');
      tbody.innerHTML = '<tr><td colspan="5" class="muted">Loading‚Ä¶</td></tr>';
      try{ const snap = await getDocs(query(collection(db,'submissions'), orderBy('createdAt','desc'))); tbody.innerHTML=''; snap.forEach(d=>{ const s=d.data(); const tr=document.createElement('tr'); tr.innerHTML = `<td>${s.name||''}</td><td>${s.email||''}</td><td>${s.phone||''}</td><td>${s.message||''}</td><td>${(s.createdAt && s.createdAt.toDate)? s.createdAt.toDate().toLocaleString(): ''}</td>`; tbody.appendChild(tr); }); if(!tbody.children.length) tbody.innerHTML = '<tr><td colspan="5" class="muted">No data</td></tr>'; }catch(e){ tbody.innerHTML = `<tr><td colspan="5" class="muted">Error: ${e.message}</td></tr>`; }
    }

    // initial
    loadSubmissions();
  </script>
</body>
</html>
