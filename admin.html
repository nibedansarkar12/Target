<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <title>Target Zone - Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: linear-gradient(135deg,#0f2027,#203a43,#2c5364); color:white; font-family:'Segoe UI',sans-serif; overflow:hidden; }
    .sidebar { background: linear-gradient(180deg,#1e3c72,#2a5298); transition: transform 0.4s ease; }
    .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); color:black; animation: glow 4s infinite alternate; }
    @keyframes glow { from {box-shadow:0 0 5px #6a11cb;} to {box-shadow:0 0 25px #2575fc;} }
    .rainbow { background: linear-gradient(90deg,#ff7e5f,#feb47b,#ff6a00,#ee0979,#6a11cb,#2575fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight:bold; }
    .nav-btn { display:flex; align-items:center; gap:10px; transition:all 0.3s; background:rgba(255,255,255,0.1); }
    .nav-btn:hover { background:linear-gradient(90deg,#ff7e5f,#feb47b,#6a11cb); color:white; transform:translateX(5px); }
    .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:999; }
    .modal img { max-width:90%; max-height:90%; border:5px solid white; border-radius:10px; }
    .finance-bg {
  background: linear-gradient(135deg, #ff7e5f, #feb47b, #6a11cb, #2575fc);
  animation: gradientShift 10s ease infinite;
}
@keyframes gradientShift {
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}
  </style>
</head>
<body class="h-screen flex overflow-hidden">
  <!-- Background Animation -->
  <canvas id="bg-canvas" class="fixed top-0 left-0 w-full h-full -z-10"></canvas>

  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar fixed md:static w-64 h-full text-white z-50 hidden md:flex flex-col">
    <div class="p-5 flex justify-between items-center border-b border-white/20">
      <div>
        <h1 class="rainbow text-2xl">ğŸŒˆ Target Zone</h1>
        <p id="admin-email" class="text-sm"></p>
      </div>
      <button id="close-sidebar" class="md:hidden text-xl">âŒ</button>
    </div>
    <nav class="p-4 space-y-3 flex-1">
      <button onclick="showSection('add')" class="nav-btn w-full py-2 px-3 rounded">â• Add Question</button>
      <button onclick="showSection('results')" class="nav-btn w-full py-2 px-3 rounded">ğŸ“Š View Results</button>
      <button onclick="showSection('users')" class="nav-btn w-full py-2 px-3 rounded">ğŸ‘¥ Manage Users</button>
      <button onclick="showSection('finance')" class="nav-btn w-full py-2 px-3 rounded">ğŸ’¼ Salary & More</button>
        <button onclick="showSection('submissions')" class="nav-btn w-full py-2 px-3 rounded">ğŸ’° Payments & Forms</button>
  </nav>
    <div class="p-4 border-t border-white/20">
      <button onclick="logout()" class="w-full bg-red-600 py-2 rounded">ğŸšª Logout</button>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-6 overflow-y-auto">
    <div class="flex justify-between items-center mb-6">
      <button id="menu-btn" class="md:hidden bg-yellow-400 px-3 py-2 rounded">â˜°</button>
      <h2 class="rainbow text-3xl">ğŸ› ï¸ Admin Panel</h2>
      <div class="flex items-center gap-3">
    </div>

    <!-- Add Question -->
    <section id="section-add" class="glass p-6 rounded-lg shadow-lg hidden">
      <form id="question-form">
        <h3 class="text-xl font-bold mb-4">â• Add New Question</h3>
        <select id="category" class="w-full border rounded px-3 py-2 mb-3" onchange="loadSubcategories(this.value)">
  <option value="">--Select Category--</option>
  <option value="ssc">SSC</option>
  <option value="railways">Railways</option>
  <option value="tet">TET</option>
</select>

<!-- à¦¨à¦¤à§à¦¨ Subcategory dropdown -->
<div class="flex gap-2 mb-3">
  <select id="subcategory" class="w-full border rounded px-3 py-2"></select>
  <input type="text" id="new-subcat" placeholder="â• New Subcategory" class="border rounded px-3 py-2">
  <button type="button" onclick="addSubcategory()" class="bg-green-500 text-white px-3 rounded">Add</button>
</div>
        <textarea id="question" rows="3" class="w-full border rounded px-3 py-2 mb-3" placeholder="à¦ªà§à¦°à¦¶à§à¦¨ à¦²à¦¿à¦–à§à¦¨..."></textarea>
        <input type="file" id="photo" accept="image/*" class="w-full mb-3">
        <div class="grid grid-cols-2 gap-3">
          <label><input type="radio" name="correct" value="0"> <input id="option1" class="w-full border rounded px-3 py-2" placeholder="Option A"></label>
          <label><input type="radio" name="correct" value="1"> <input id="option2" class="w-full border rounded px-3 py-2" placeholder="Option B"></label>
          <label><input type="radio" name="correct" value="2"> <input id="option3" class="w-full border rounded px-3 py-2" placeholder="Option C"></label>
          <label><input type="radio" name="correct" value="3"> <input id="option4" class="w-full border rounded px-3 py-2" placeholder="Option D"></label>
        </div>
  <button type="button" onclick="addQuestion()" class="bg-blue-500 text-white px-4 py-2 rounded">Add</button>
      </form>
      <h3 class="text-lg font-semibold mt-6">ğŸ“‹ Added Questions</h3>
<div class="max-h-64 overflow-y-auto border rounded mt-3"> 
  <table class="w-full text-left border">
    <thead><tr><th>Question</th><th>Answer</th><th>Delete</th></tr></thead>
    <tbody id="questions-list"></tbody>
  </table>
</div>
    </section>

    <!-- Results -->
    <section id="section-results" class="glass p-6 rounded-lg shadow-lg hidden">
      <h3 class="text-xl font-bold mb-4">ğŸ“Š View Results</h3>
      <canvas id="resultsChart" class="mb-6"></canvas>
      <table class="w-full text-left border">
        <thead><tr><th>Email</th><th>Exam</th><th>Score</th><th>Submitted</th></tr></thead>
        <tbody id="results-list"></tbody>
      </table>
    </section>

    <!-- Users -->
    <section id="section-users" class="glass p-6 rounded-lg shadow-lg hidden">
      <h3 class="text-xl font-bold mb-4">ğŸ‘¥ Manage Users</h3>
      <table class="w-full text-left border">
        <thead><tr><th>Name</th><th>Email</th><th>WhatsApp</th><th>Education</th><th>Status</th></tr></thead>
        <tbody id="users-list"></tbody>
      </table>
    </section>
  
    <!-- Payments & Forms Section -->
    <section id="section-submissions" class="glass p-6 rounded-lg shadow-lg hidden">
      <h3 class="text-xl font-bold mb-4 flex items-center gap-2">ğŸ’° Payment Proofs</h3>
      <table class="w-full text-left border mb-6">
        <thead class="bg-gray-200">
          <tr><th class="p-2">Name</th><th>Phone</th><th>Proof</th><th>Date</th></tr>
        </thead>
        <tbody id="payments-list"></tbody>
      </table>

      <h3 class="text-xl font-bold mb-4 flex items-center gap-2">ğŸ“„ Admission Forms</h3>
      <table class="w-full text-left border">
        <thead class="bg-gray-200">
          <tr><th class="p-2">Name</th><th>Phone</th><th>Course</th><th>Address</th><th>Message</th><th>Date</th></tr>
        </thead>
        <tbody id="admissions-list"></tbody>
      </table>
    </section>
    <!-- Finance Section -->
<section id="section-finance" class="glass p-6 rounded-lg shadow-lg hidden">
  <h3 class="text-2xl font-bold rainbow mb-6">ğŸ’¼ Salary, Birthdays & More</h3>
  
  <!-- Card Grid -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
    
    <!-- Salary Card -->
    <div onclick="openSalary()" class="cursor-pointer p-6 bg-white/20 rounded-2xl shadow-lg hover:scale-105 transition">
      <h4 class="text-xl font-bold">ğŸª™ Salary</h4>
      <p>Track payments, dues & yearly records</p>
    </div>
    
    <!-- Birthday Card -->
    <div onclick="openBirthday()" class="cursor-pointer p-6 bg-white/20 rounded-2xl shadow-lg hover:scale-105 transition">
      <h4 class="text-xl font-bold">ğŸ‰ Birthdays</h4>
      <p>Todayâ€™s wishes & WhatsApp/SMS</p>
    </div>

    <!-- Attendance Card -->
    <div onclick="openAttendance()" class="cursor-pointer p-6 bg-white/20 rounded-2xl shadow-lg hover:scale-105 transition">
      <h4 class="text-xl font-bold">ğŸ“… Attendance</h4>
      <p>Mark daily presence & view reports</p>
    </div>

    <!-- Reports Card -->
    <div onclick="openReports()" class="cursor-pointer p-6 bg-gray-400/20 rounded-2xl shadow-lg line-through">
      <h4 class="text-xl font-bold">ğŸ“Š Reports</h4>
      <p>Coming soon</p>
    </div>
  </div>

  <!-- Dynamic Panels -->
  <div id="salary-panel" class="hidden mt-8"></div>
  <div id="birthday-panel" class="hidden mt-8"></div>
  <div id="attendance-panel" class="hidden mt-8"></div>
  <div id="reports-panel" class="hidden mt-8"></div>
          </section>

</main>

  <!-- Firebase & Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
    import { getDatabase, ref as dbRef, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCR5rqthBh0vX0yLOcOG3b9xJiKbYtzdxU",
      authDomain: "target-zone-8fffd.firebaseapp.com",
      projectId: "target-zone-8fffd",
      storageBucket: "target-zone-8fffd.appspot.com",
      messagingSenderId: "667579216123",
      appId: "1:667579216123:web:37bb1fcc724743073d005e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const rtdb = getDatabase(app);

    let currentCategory="";

    onAuthStateChanged(auth,user=>{
      if(!user){ window.location.href="index.html"; }
      else{ document.getElementById("admin-email").textContent="ğŸ‘¤ "+user.email; }
    });

    window.logout=async()=>{ await signOut(auth); window.location.href="index.html"; };

    

    // Load Questions
    
// --- à¦ªà§à¦°à¦¤à¦¿à¦¸à§à¦¥à¦¾à¦ªà¦¨ à¦•à¦°à§à¦¨: window.loadQuestions = async (...) {...} ---
window.loadQuestions = async (categoryOrColl) => {
  if (!categoryOrColl) return;
  const table = document.getElementById("questions-list");
  table.innerHTML = "<tr><td colspan='3'>à¦²à§‹à¦¡ à¦¹à¦šà§à¦›à§‡...</td></tr>";

  // à¦¨à§‹à¦Ÿ: caller à¦•à¦–à¦¨à¦“ base category (e.g. "ssc"), à¦•à¦–à¦¨à¦“ composite (e.g. "ssc__math") à¦ªà¦¾à¦ à¦¾à¦¤à§‡ à¦ªà¦¾à¦°à§‡
  let collToQuery = categoryOrColl;

  if (typeof categoryOrColl === "string" && categoryOrColl.includes("__")) {
    // composite à¦à¦¸à§‡à¦›à§‡: split à¦•à¦°à§‡ globals sync à¦•à¦°à§‡ à¦¨à¦¾à¦“
    const parts = categoryOrColl.split("__");
    currentCategory = parts[0] || "";
    currentSubcategory = parts[1] || "";
    collToQuery = categoryOrColl;
    const subSelect = document.getElementById("subcategory");
    if (subSelect) subSelect.value = currentSubcategory;
    const catSelect = document.getElementById("category");
    if (catSelect) catSelect.value = currentCategory;
  } else {
    // base category à¦à¦¸à§‡à¦›à§‡
    currentCategory = categoryOrColl;
    // à¦¯à¦¦à¦¿ à¦†à¦—à§‡ à¦¥à§‡à¦•à§‡ currentSubcategory à¦¥à¦¾à¦•à§‡, à¦¤à¦–à¦¨ composite collection à¦¥à§‡à¦•à§‡ à¦²à§‹à¦¡ à¦•à¦°à§‹
    if (currentSubcategory) {
      collToQuery = `${currentCategory}__${currentSubcategory}`;
    } else {
      collToQuery = currentCategory;
    }
    const catSelect = document.getElementById("category");
    if (catSelect) catSelect.value = currentCategory;
  }

  try {
    const snapshot = await getDocs(collection(db, collToQuery));
    let rows = "";
    snapshot.forEach(docSnap => {
      const q = docSnap.data();
      rows += `
        <tr>
          <td>${q.question || ""}${q.photo?`<br><img src="${q.photo}" class="w-20 cursor-pointer" onclick="openModal('${q.photo}')">`:""}</td>
          <td>${q.answer || ""}</td>
          <td><button onclick="deleteQuestion('${collToQuery}','${docSnap.id}')" class="bg-red-500 text-white px-2 py-1 rounded">ğŸ—‘</button></td>
        </tr>
      `;
    });
    table.innerHTML = rows || "<tr><td colspan='3'>à¦•à§‹à¦¨à§‹ à¦ªà§à¦°à¦¶à§à¦¨ à¦¨à§‡à¦‡</td></tr>";
  } catch (err) {
    console.error("loadQuestions error:", err);
    table.innerHTML = `<tr><td colspan='3'>à¦²à§‹à¦¡à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾: ${err.message || err}</td></tr>`;
  }
};
// --- end loadQuestions replacement ---
    // Delete Question
    window.deleteQuestion=async(cat,id)=>{ await deleteDoc(doc(db,cat,id)); loadQuestions(cat); };

    // Modal Preview
    window.openModal=(url)=>{
      const modal=document.createElement("div");
      modal.className="modal";
      modal.innerHTML=`<img src="${url}" onclick="this.parentElement.remove()">`;
      document.body.appendChild(modal);
    }

    // Show Section
    window.showSection=async(id)=>{
      document.querySelectorAll("section").forEach(sec=>sec.classList.add("hidden"));
      document.getElementById("section-"+id).classList.remove("hidden");
      if(id==="results") loadResults();
      if(id==="users") loadUsers();
      if(id==="submissions") loadSubmissions();
      if(id==="users") loadUsers();
    }

    // Load Results with Pie Chart
    async function loadResults(){
      const table=document.getElementById("results-list");
      table.innerHTML="<tr><td colspan='4'>à¦²à§‹à¦¡ à¦¹à¦šà§à¦›à§‡...</td></tr>";
      const q=query(collection(db,"results"),orderBy("submittedAt","desc"));
      const snapshot=await getDocs(q);
      let rows="",correct=0,wrong=0,unattempted=0;
      snapshot.forEach(docSnap=>{
        const r=docSnap.data();
        correct+=r.correct||0;
        wrong+=r.wrong||0;
        unattempted+=r.unattempted||0;
        rows+=`<tr><td>${r.email}</td><td>${r.exam}</td><td>${r.score}/${r.total}</td><td>${r.submittedAt ? new Date(r.submittedAt.seconds*1000).toLocaleString():"N/A"}</td></tr>`;
      });
      table.innerHTML=rows||"<tr><td colspan='4'>à¦•à§‹à¦¨à§‹ à¦°à§‡à¦œà¦¾à¦²à§à¦Ÿ à¦¨à§‡à¦‡</td></tr>";
      new Chart(document.getElementById("resultsChart"),{
        type:"pie",
        data:{labels:["Correct","Wrong","Unattempted"],datasets:[{data:[correct,wrong,unattempted],backgroundColor:["#4caf50","#f44336","#9e9e9e"]}]}
      });
    }

    // Load Users
    
    
      

    // Music Toggle
    const music=document.getElementById("bg-music");
    const musicBtn=document.getElementById("music-btn");
    musicBtn.addEventListener("click",()=>{
      if(music.muted){ music.muted=false; music.play(); musicBtn.textContent="ğŸ”‡ Mute Sound"; }
      else{ music.muted=true; musicBtn.textContent="ğŸ”Š Play Sound"; }
    });
  
    



    // ---- Admin additions: clean loadUsers & loadSubmissions ----
    async function loadUsers(){
      const table = document.getElementById("users-list");
      if(!table) return;
      table.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
      try {
        const querySnapshot = await getDocs(collection(db, "users"));
        let rows = "";
        querySnapshot.forEach(docSnap => {
          const d = docSnap.data() || {};
          rows += `<tr>
            <td>${d.name || ""}</td>
            <td>${d.email || ""}</td>
            <td>${d.whatsapp || ""}</td>
            <td>${d.education || ""}</td>
            <td>${d.status || ""}</td>
          </tr>`;
        });
        table.innerHTML = rows || "<tr><td colspan='5'>No users found</td></tr>";
      } catch (error) {
        console.error("Error loading users: ", error);
        table.innerHTML = "<tr><td colspan='5'>Error loading users</td></tr>";
      }
    }

    function formatTimestamp(ts){
      if(!ts) return "";
      try{
        if(typeof ts === 'number') return new Date(ts).toLocaleString();
        if(ts.seconds) return new Date(ts.seconds*1000).toLocaleString();
        return new Date(ts).toLocaleString();
      }catch(e){
        return "";
      }
    }

    async function loadSubmissions(){
      const paymentsTable = document.getElementById("payments-list");
      const admissionsTable = document.getElementById("admissions-list");
      if(paymentsTable) paymentsTable.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";
      if(admissionsTable) admissionsTable.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";

      try{
        const paySnap = await get(dbRef(rtdb, "paymentProofs"));
        let payRows = "";
        if(paySnap.exists && paySnap.exists()){
          paySnap.forEach(item=>{
            const d = item.val() || {};
            payRows += `<tr>
              <td>${d.name || ""}</td>
              <td>${d.phone || ""}</td>
              <td><img src="${d.url || ""}" class="w-16 h-16 object-cover cursor-pointer" onclick="openModal('${d.url || ""}')"></td>
              <td>${formatTimestamp(d.createdAt)}</td>
            </tr>`;
          });
        } else {
          payRows = "<tr><td colspan='4'>No Data</td></tr>";
        }
        if(paymentsTable) paymentsTable.innerHTML = payRows;
      }catch(e){
        console.error("Error loading payments:", e);
        if(paymentsTable) paymentsTable.innerHTML = "<tr><td colspan='4'>Error loading payments</td></tr>";
      }

      try{
        const admSnap = await get(dbRef(rtdb, "admissions"));
        let admRows = "";
        if(admSnap.exists && admSnap.exists()){
          admSnap.forEach(item=>{
            const d = item.val() || {};
            admRows += `<tr>
              <td>${d.name || ""}</td>
              <td>${d.phone || ""}</td>
              <td>${d.course || ""}</td>
              <td>${d.address||""}</td>
              <td>${d.message||""}</td>
              <td>${formatTimestamp(d.createdAt)}</td>
            </tr>`;
          });
        } else {
          admRows = "<tr><td colspan='6'>No Data</td></tr>";
        }
        if(admissionsTable) admissionsTable.innerHTML = admRows;
      }catch(e){
        console.error("Error loading admissions:", e);
        if(admissionsTable) admissionsTable.innerHTML = "<tr><td colspan='6'>Error loading admissions</td></tr>";
      }
    }
    // === Finance Section Logic ===

// Salary
window.openSalary = async () => {
  hideFinancePanels();
  const panel = document.getElementById("salary-panel");
  panel.classList.remove("hidden");
  panel.innerHTML = `
    <h3 class="text-xl font-bold mb-4">ğŸª™ Salary Management</h3>
    <div id="batch-list" class="space-y-2"></div>
  `;
  // Load batches dynamically (demo)
  const batchList = document.getElementById("batch-list");
  batchList.innerHTML = `
    <button onclick="loadStudents('Batch A')" class="bg-blue-500 text-white px-3 py-2 rounded">Batch A</button>
    <button onclick="loadStudents('Batch B')" class="bg-blue-500 text-white px-3 py-2 rounded">Batch B</button>
  `;
};

window.loadStudents = async (batch) => {
  const panel = document.getElementById("salary-panel");
  panel.innerHTML = `<h4 class="text-lg font-semibold mb-3">${batch} - Students</h4>
    <ul class="space-y-2">
      <li><button onclick="openStudentFinance('S1','Student One')" class="underline text-blue-200">Student One</button></li>
      <li><button onclick="openStudentFinance('S2','Student Two')" class="underline text-blue-200">Student Two</button></li>
    </ul>`;
};

window.openStudentFinance = async (id,name) => {
  const panel = document.getElementById("salary-panel");
  panel.innerHTML = `
    <h4 class="text-lg font-bold mb-4">ğŸ’° Finance Record - ${name}</h4>
    <table class="w-full border mb-4">
      <thead><tr><th>Month</th><th>Paid</th><th>Due</th></tr></thead>
      <tbody id="finance-rows"></tbody>
    </table>
    <div class="flex gap-3">
      <input id="amount" type="number" placeholder="Enter Amount" class="border rounded px-2 py-1">
      <button onclick="addPayment('${id}')" class="bg-green-500 px-3 py-1 rounded">â• Add Payment</button>
    </div>
  `;
  // Dummy data
  document.getElementById("finance-rows").innerHTML = `
    <tr><td>January</td><td>500</td><td>200</td></tr>
    <tr><td>February</td><td>700</td><td>0</td></tr>
  `;
};

window.addPayment = async (studentId) => {
  const amount = document.getElementById("amount").value;
  alert(`Payment of â‚¹${amount} added for ${studentId} âœ…`);
  // TODO: Save to Firebase salaries collection
};

// Birthday
window.openBirthday = async () => {
  hideFinancePanels();
  const panel = document.getElementById("birthday-panel");
  panel.classList.remove("hidden");
  const today = new Date().toISOString().slice(5,10); // MM-DD
  // Demo birthday list
  const students = [
    {name:"Student One",dob:"08-17",phone:"1234567890"},
    {name:"Student Two",dob:"12-25",phone:"9876543210"}
  ];
  let html = `<h3 class="text-xl font-bold mb-4">ğŸ‰ Todayâ€™s Birthdays</h3>`;
  const todays = students.filter(s=>s.dob===today);
  if(todays.length===0) html += `<p>No birthdays today</p>`;
  todays.forEach(s=>{
    const msg = `à¦¶à§à¦­ à¦œà¦¨à§à¦®à¦¦à¦¿à¦¨ ${s.name}! ğŸ‰ à¦¤à§‹à¦®à¦¾à¦° à¦œà§€à¦¬à¦¨ à¦†à¦¨à¦¨à§à¦¦à§‡ à¦­à¦°à§‡ à¦‰à¦ à§à¦•à¥¤`;
    html += `
      <div class="p-4 bg-pink-200 rounded mb-3 text-black">
        ğŸ‚ ${s.name} 
        <div class="mt-2 flex gap-3">
          <a href="https://wa.me/${s.phone}?text=${encodeURIComponent(msg)}" target="_blank" class="bg-green-500 text-white px-3 py-1 rounded">WhatsApp</a>
          <a href="sms:${s.phone}?body=${encodeURIComponent(msg)}" class="bg-blue-500 text-white px-3 py-1 rounded">SMS</a>
        </div>
      </div>
    `;
  });
  panel.innerHTML = html;
};

// Attendance
window.openAttendance = async () => {
  hideFinancePanels();
  const panel = document.getElementById("attendance-panel");
  panel.classList.remove("hidden");
  panel.innerHTML = `
    <h3 class="text-xl font-bold mb-4">ğŸ“… Attendance</h3>
    <table class="w-full border">
      <thead><tr><th>Name</th><th>Status</th></tr></thead>
      <tbody>
        <tr><td>Student One</td><td><button class="bg-green-500 px-2 py-1 rounded">Present</button></td></tr>
        <tr><td>Student Two</td><td><button class="bg-red-500 px-2 py-1 rounded">Absent</button></td></tr>
      </tbody>
    </table>
  `;
};

// Reports (future)
window.openReports = async () => {
  hideFinancePanels();
  const panel = document.getElementById("reports-panel");
  panel.classList.remove("hidden");
  panel.innerHTML = `<h3 class="text-xl">ğŸ“Š Reports Coming Soon</h3>`;
};

// Helper to hide all
function hideFinancePanels(){
  ["salary-panel","birthday-panel","attendance-panel","reports-panel"]
  .forEach(id=>document.getElementById(id).classList.add("hidden"));
}
    let currentSubcategory = "";

// à¦¸à¦¾à¦¬à¦•à§à¦¯à¦¾à¦Ÿà¦¾à¦—à¦°à¦¿ à¦²à§‹à¦¡
window.loadSubcategories = async (category) => {
  currentCategory = category;
  const subSelect = document.getElementById("subcategory");
  subSelect.innerHTML = "<option value=''>--Select Subcategory--</option>";
  if (!category) return;

  const q = query(collection(db, "subcategories"), where("category", "==", category));
  const snapshot = await getDocs(q);

  snapshot.forEach(docSnap => {
    const sub = docSnap.data();
    const opt = document.createElement("option");
    opt.value = sub.id;          // âœ… à¦¸à¦¾à¦¬à¦•à§à¦¯à¦¾à¦Ÿà¦¾à¦—à¦°à¦¿à¦° id à¦¹à¦¬à§‡ à¦•à¦¾à¦²à§‡à¦•à¦¶à¦¨ à¦¨à¦¾à¦®
    opt.textContent = sub.name;
    subSelect.appendChild(opt);
  });
};

// à¦¨à¦¤à§à¦¨ à¦¸à¦¾à¦¬à¦•à§à¦¯à¦¾à¦Ÿà¦¾à¦—à¦°à¦¿ à¦¯à§‹à¦—
window.addSubcategory = async () => {
  const name = document.getElementById("new-subcat").value.trim();
  if (!name || !currentCategory) {
    return alert("âš ï¸ à¦•à§à¦¯à¦¾à¦Ÿà¦¾à¦—à¦°à¦¿ à¦“ à¦¸à¦¾à¦¬à¦•à§à¦¯à¦¾à¦Ÿà¦¾à¦—à¦°à¦¿ à¦¨à¦¾à¦® à¦¦à¦¿à¦¨!");
  }

  const id = name.toLowerCase().replace(/\s+/g, "_");

  await addDoc(collection(db, "subcategories"), { 
    id, 
    name, 
    category: currentCategory 
  });

  alert("âœ… à¦¸à¦¾à¦¬à¦•à§à¦¯à¦¾à¦Ÿà¦¾à¦—à¦°à¦¿ à¦¤à§ˆà¦°à¦¿ à¦¹à¦¯à¦¼à§‡à¦›à§‡!");
  document.getElementById("new-subcat").value = "";
  await loadSubcategories(currentCategory);

  // auto-select
  // auto-select the new subcategory and immediately load its questions
  document.getElementById("subcategory").value = id;
  currentSubcategory = id;
  // load questions for the newly created subcategory
  loadQuestions(`${currentCategory}__${currentSubcategory}`);
}

// à¦¸à¦¾à¦¬à¦•à§à¦¯à¦¾à¦Ÿà¦¾à¦—à¦°à¦¿ à¦¸à¦¿à¦²à§‡à¦•à§à¦Ÿ à¦•à¦°à¦²à§‡ à¦®à¦¨à§‡ à¦°à¦¾à¦–à¦¾
document.getElementById("subcategory").addEventListener("change", (e) => {
  currentSubcategory = e.target.value;
  if (!currentCategory || !currentSubcategory) return;

  // à¦¨à¦¤à§à¦¨ à¦•à¦®à§à¦ªà§‹à¦œà¦¿à¦Ÿ à¦•à¦¾à¦²à§‡à¦•à¦¶à¦¨ à¦¨à¦¾à¦® à¦¬à¦¾à¦¨à¦¾à¦“
  const collName = `${currentCategory}__${currentSubcategory}`;
  
  // à¦à¦–à¦¨ à¦“à¦‡ à¦•à¦®à§à¦ªà§‹à¦œà¦¿à¦Ÿ à¦•à¦¾à¦²à§‡à¦•à¦¶à¦¨ à¦¥à§‡à¦•à§‡ à¦ªà§à¦°à¦¶à§à¦¨ à¦²à§‹à¦¡ à¦¹à¦¬à§‡
  loadQuestions(collName);
});

// à¦ªà§à¦°à¦¶à§à¦¨ à¦¯à§‹à¦— à¦•à¦°à¦¾ (à¦¸à¦°à¦¾à¦¸à¦°à¦¿ à¦¸à¦¾à¦¬à¦•à§à¦¯à¦¾à¦Ÿà¦¾à¦—à¦°à¦¿ à¦•à¦¾à¦²à§‡à¦•à¦¶à¦¨à§‡ à¦¯à¦¾à¦¬à§‡)
window.addQuestion = async () => {
  if (!currentCategory || !currentSubcategory) {
    return alert("âš ï¸ à¦†à¦—à§‡ à¦•à§à¦¯à¦¾à¦Ÿà¦¾à¦—à¦°à¦¿ à¦“ à¦¸à¦¾à¦¬à¦•à§à¦¯à¦¾à¦Ÿà¦¾à¦—à¦°à¦¿ à¦¸à¦¿à¦²à§‡à¦•à§à¦Ÿ à¦•à¦°à§à¦¨!");
  }

  const collName = `${currentCategory}__${currentSubcategory}`;
  const quesEl = document.getElementById("question");
  const ques = quesEl ? quesEl.value.trim() : "";
  const opts = [1,2,3,4].map(i => {
    const el = document.getElementById("option"+i);
    return el ? el.value.trim() : "";
  });
  const correctRadio = document.querySelector('input[name="correct"]:checked');
  const correctIndex = correctRadio ? parseInt(correctRadio.value, 10) : NaN;
  const photoFile = document.getElementById("photo")?.files[0];

  if (!ques || opts.some(o => !o) || Number.isNaN(correctIndex)) {
    return alert("âš ï¸ à¦ªà§à¦°à¦¶à§à¦¨ à¦“ à¦¸à¦¬ à¦…à¦ªà¦¶à¦¨ à¦²à¦¿à¦–à§à¦¨ à¦à¦¬à¦‚ à¦¸à¦ à¦¿à¦• à¦‰à¦¤à§à¦¤à¦° à¦¸à¦¿à¦²à§‡à¦•à§à¦Ÿ à¦•à¦°à§à¦¨!");
  }

  let photoURL = "";
  try {
    if (photoFile) {
      const storageRef = ref(storage, `questions/${Date.now()}-${photoFile.name}`);
      await uploadBytes(storageRef, photoFile);
      photoURL = await getDownloadURL(storageRef);
    }

    const docRef = await addDoc(collection(db, collName), {
      id: Date.now(),
      category: currentCategory,
      subcategory: currentSubcategory,
      question: ques,
      options: opts,
      answer: opts[correctIndex],
      photo: photoURL || "",
      createdAt: new Date()
    });

    console.log("Question added:", docRef.id, "to", collName);
    alert("âœ… à¦ªà§à¦°à¦¶à§à¦¨ à¦¸à§‡à¦­ à¦¹à¦¯à¦¼à§‡à¦›à§‡!");
  } catch (e) {
    console.error("Add question failed:", e);
    alert("âŒ à¦ªà§à¦°à¦¶à§à¦¨ à¦¯à§‹à¦— à¦•à¦°à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿: " + (e.message || e));
    return;
  }

  // ğŸ‘‰ à¦«à¦°à§à¦® à¦°à¦¿à¦¸à§‡à¦Ÿ à¦¨à¦¾ à¦•à¦°à§‡ à¦¶à§à¦§à§ à¦‡à¦¨à¦ªà§à¦Ÿ à¦«à¦¿à¦²à§à¦¡ à¦•à§à¦²à¦¿à¦¯à¦¼à¦¾à¦°
  const qForm = document.getElementById("question-form");
  if (qForm) {
    const qEl = qForm.querySelector('#question');
    if (qEl) qEl.value = '';
    ['option1','option2','option3','option4'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    document.querySelectorAll('input[name="correct"]').forEach(r => r.checked = false);
    const photoInput = document.getElementById('photo');
    if (photoInput) photoInput.value = '';
  }

  // ğŸ‘‰ à¦¶à§‡à¦·à§‡ à¦Ÿà§‡à¦¬à¦¿à¦² à¦°à¦¿à¦«à§à¦°à§‡à¦¶
  loadQuestions(collName);
    }
    // ---- end additions ----

</script>

  <script>
    // Sidebar toggle
    document.getElementById("menu-btn").addEventListener("click",()=>{document.getElementById("sidebar").classList.remove("hidden");});
    document.getElementById("close-sidebar").addEventListener("click",()=>{document.getElementById("sidebar").classList.add("hidden");});

    // Background Animation
    const canvas=document.getElementById("bg-canvas");
    const ctx=canvas.getContext("2d");
    canvas.width=window.innerWidth; canvas.height=window.innerHeight;
    let stars=[], planes=[];
    for(let i=0;i<150;i++){stars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*2,dx:(Math.random()-0.5)*0.5,dy:(Math.random()-0.5)*0.5});}
    for(let i=0;i<2;i++){planes.push({x:-50,y:Math.random()*canvas.height/2,dx:2+Math.random()*2,size:20});}
    function draw(){
      ctx.fillStyle="rgba(0,0,30,0.4)"; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle="white"; stars.forEach(s=>{ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();s.x+=s.dx;s.y+=s.dy;if(s.x<0||s.x>canvas.width) s.dx*=-1;if(s.y<0||s.y>canvas.height) s.dy*=-1;});
      planes.forEach(p=>{ctx.fillStyle="lightblue";ctx.fillRect(p.x,p.y,p.size,3);ctx.fillStyle="white";ctx.fillRect(p.x-5,p.y+1,10,1);p.x+=p.dx;if(p.x>canvas.width+50){p.x=-50;p.y=Math.random()*canvas.height/2;}});
    }
    setInterval(draw,30);
  
    

</script>
      <div class="flex items-center gap-3">
  <!-- à¦¨à¦¤à§à¦¨ playlist audio -->
  <audio id="bg-music" autoplay muted></audio>
  <button id="music-btn" class="bg-green-500 px-3 py-1 rounded">ğŸ”Š Play Sound</button>
</div>

<script>
  const playlist = [
    "https://raw.githubusercontent.com/nibedansarkar12/Target/main/15_August_Song_Dance___Rakto_Nadir_Dhara___Independence_Day_Dance___Bengali_Patriotic_song_2022(256k).mp3",
    "https://raw.githubusercontent.com/nibedansarkar12/Target/main/Bangla_nonstop_romantic_song____Kumar_Sanu____adhunik_Bangla_gaan____à¦¬à¦¾à¦‚à¦²à¦¾_à¦—à¦¾à¦¨____90s_bengali_song(256k).mp3"
  ];

  let index = 0;
  const player = document.getElementById("bg-music");
  player.src = playlist[index];
  player.loop = false;

  // à¦—à¦¾à¦¨ à¦¶à§‡à¦· à¦¹à¦²à§‡ à¦ªà¦°à§‡à¦° à¦—à¦¾à¦¨ à¦¬à¦¾à¦œà¦¬à§‡
  player.addEventListener("ended", () => {
    index = (index + 1) % playlist.length;
    player.src = playlist[index];
    player.play();
  });

  // Play / Mute à¦¬à¦¾à¦Ÿà¦¨ à¦•à¦¾à¦œ à¦•à¦°à¦¬à§‡
  const musicBtn = document.getElementById("music-btn");
  musicBtn.addEventListener("click", () => {
    if (player.muted) {
      player.muted = false;
      player.play();
      musicBtn.textContent = "ğŸ”‡ Mute Sound";
    } else {
      player.muted = true;
      musicBtn.textContent = "ğŸ”Š Play Sound";
    }
  });
</script>
</body>
</html>
