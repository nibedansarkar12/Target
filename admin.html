<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h2>Student Reports</h2>
  <button onclick="generateReports()">Download All Reports</button>
  <div id="report-container"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCR5rqthBh0vX0yLOcOG3b9xJiKbYtzdxU",
      authDomain: "target-zone-8fffd.firebaseapp.com",
      projectId: "target-zone-8fffd",
      storageBucket: "target-zone-8fffd.appspot.com",
      messagingSenderId: "667579216123",
      appId: "1:667579216123:web:37bb1fcc724743073d005e",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function generateReports() {
      const { jsPDF } = window.jspdf;

      // Load all questions first
      const questionsSnapshot = await getDocs(collection(db, "questions"));
      const questions = questionsSnapshot.docs.map(doc => doc.data());

      // Load all results
      const resultsSnapshot = await getDocs(collection(db, "results"));

      if (resultsSnapshot.empty) {
        alert("⚠️ কোনো রেজাল্ট পাওয়া যায়নি। অন্তত একজন স্টুডেন্টকে কুইজ সাবমিট করতে দিন।");
        return;
      }

      resultsSnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const pdf = new jsPDF();

        // Header
        pdf.setFontSize(18);
        pdf.text("Quiz Report Card", 70, 20);

        // Student Info
        pdf.setFontSize(12);
        pdf.text(`Student Email: ${data.email}`, 20, 40);

        // Calculate correct, incorrect, unanswered
        let correctCount = 0;
        let incorrectCount = 0;
        let unansweredCount = 0;

        if (data.answers) {
          questions.forEach((q, index) => {
            if (data.answers[index] === undefined) {
              unansweredCount++;
            } else if (data.answers[index] === q.answer) {
              correctCount++;
            } else {
              incorrectCount++;
            }
          });
        } else {
          unansweredCount = questions.length;
        }

        // Score
        pdf.text(`Total Score: ${correctCount} / ${questions.length}`, 20, 50);
        pdf.text(`✅ Correct Answers: ${correctCount}`, 20, 60);
        pdf.text(`❌ Incorrect Answers: ${incorrectCount}`, 20, 70);
        pdf.text(`⚠️ Unanswered Questions: ${unansweredCount}`, 20, 80);

        // Detailed answers
        let y = 100;
        pdf.setFontSize(12);
        pdf.text("Detailed Answers:", 20, y);
        y += 10;

        questions.forEach((q, index) => {
          const studentAns = data.answers ? data.answers[index] : "Not Answered";
          const correctAns = q.answer;
          const status = studentAns === correctAns ? "✔ Correct" :
                         (studentAns === "Not Answered" ? "⚠ Unanswered" : "✘ Wrong");
          pdf.text(`${index + 1}. Q: ${q.question}`, 20, y);
          y += 8;
          pdf.text(`Your Ans: ${studentAns}`, 30, y);
          y += 8;
          pdf.text(`Correct Ans: ${correctAns}   [${status}]`, 30, y);
          y += 12;

          if (y > 270) { // New page if needed
            pdf.addPage();
            y = 20;
          }
        });

        pdf.save(`${data.email}_report.pdf`);
      });
    }
  </script>
</body>
</html>
