<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Target Zone ‚Äî Quiz</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg: #0b1220;
      --card: rgba(255,255,255,0.04);
      --card-border: rgba(255,255,255,0.1);
      --muted: #a5b4fc;
      --accent: #22d3ee;
      --accent-2: #22c55e;
      --unattempted: #fef08a;
      --attempted: #60a5fa;
      --review: #f97316;
    }
    *{box-sizing:border-box}
    html,body{margin:0; padding:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:radial-gradient(1200px 800px at 10% -10%,rgba(34,211,238,.15),transparent), radial-gradient(800px 600px at 100% 0%, rgba(99,102,241,.18), transparent), var(--bg); color:#e5e7eb;}
    .container{max-width:1024px; margin:0 auto; padding:18px;}
    .card{ background: linear-gradient(180deg, rgba(255,255,255,0.045), rgba(255,255,255,0.02)); border:1px solid var(--card-border); border-radius:16px; padding:14px; box-shadow: 0 12px 30px rgba(2,6,23,0.35);}
    .card-bordered{ border:1px solid rgba(255,255,255,0.14); }
    .muted{ color:var(--muted); }

    /* ===== Exam Cards (new style) ===== */
    #exam-cards{ display:grid; grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); gap:14px; }
    .exam-card{ position:relative; padding:16px; border-radius:16px; cursor:pointer; overflow:hidden; transition: transform .25s ease, box-shadow .25s ease; }
    .exam-card:hover{ transform: translateY(-4px); box-shadow:0 18px 40px rgba(2,6,23,.55); }
    .exam-card::before{ content:""; position:absolute; inset:-1px; padding:1px; border-radius:18px; background:linear-gradient(135deg, rgba(99,102,241,.6), rgba(34,211,238,.5), rgba(34,197,94,.45)); -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude; }
    .exam-card .top-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .exam-card h4{ margin:0; font-weight:800; font-size:1.02rem; display:flex; gap:10px; align-items:center; }
    .exam-card p{ margin:8px 0 0 0; color:var(--muted); font-size:0.95rem; }
    .exam-icon{ width:46px; height:46px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; font-weight:900; border:1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.04); }
    .exam-foot{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:12px; }
    .exam-meta{ display:flex; gap:8px; align-items:center; font-size:0.9rem; color:#cbd5e1; }
    .chip{ padding:4px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.04); font-weight:700; font-size:0.78rem; letter-spacing:.02em; }
    .start-btn{ border:none; border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer; background:#16a34a; color:white; }

    /* Progress ring */
    .ring{ --val: 0; width:44px; height:44px; border-radius:999px; display:grid; place-items:center; background:
      conic-gradient(#22c55e calc(var(--val)*1%), rgba(255,255,255,0.08) 0);
      border:1px solid rgba(255,255,255,0.08);
    }
    .ring .inner{ width:34px; height:34px; border-radius:999px; background:rgba(0,0,0,.35); display:grid; place-items:center; font-size:.8rem; font-weight:800; }

    /* ===== Quiz area visuals (kept + refined) ===== */
    #quiz-section { padding: 18px; }
    #question-card { background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(255,255,255,0.02)); border-radius:12px; padding:16px; box-shadow: 0 10px 30px rgba(2,6,23,0.45); border:1px solid var(--card-border); }
    #question-text { font-size:1.1rem; font-weight:800; margin-bottom:8px; color:#fff; word-break:break-word; }
    #options-list { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px; }
    #options-list li { background: rgba(255,255,255,0.04); padding:12px; border-radius:10px; display:flex; gap:12px; align-items:center; cursor:pointer; user-select:none; border:1px solid rgba(255,255,255,0.06); }
    #options-list li input[type="radio"]{ transform:scale(1.05); pointer-events:none; }
    #options-list li .opt-text{ flex:1; min-width:0; word-break:break-word; }

    /* Palette */
    #palette{ display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .palette-btn{ min-width:44px; min-height:44px; border-radius:8px; padding:6px 10px; display:flex; align-items:center; justify-content:center; font-weight:800; cursor:pointer; border:none; color: #0f172a; }
    .palette-un { background: var(--unattempted); color:#0f172a; }
    .palette-att { background: var(--attempted); color:white; }
    .palette-rev { background: var(--review); color:white; }
    .palette-legend{ display:flex; gap:14px; align-items:center; margin-top:8px; color:var(--muted); font-size:0.88rem; flex-wrap:wrap; }
    .legend-box{ display:flex; gap:10px; align-items:center; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background: rgba(0,0,0,0.04); }

    /* Controls */
    .controls-row{ display:flex; gap:10px; align-items:center; margin-top:12px; flex-wrap:wrap; }
    .controls-left{ display:flex; gap:8px; }
    #submit-btn{ background:#ef4444; color:white; padding:10px 18px; border-radius:10px; border:none; cursor:pointer; font-weight:800; }

    /* Mobile submit fixed */
    @media (max-width:640px){
      #submit-fixed{ position:fixed; left:50%; transform:translateX(-50%); bottom:14px; z-index:60; width:calc(100% - 40px); max-width:540px; display:flex; justify-content:center; }
    }

    /* Result simple card */
    #result-section .stat-row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
    .stat { background: rgba(255,255,255,0.04); padding:12px; border-radius:8px; min-width:120px; text-align:center; border:1px solid rgba(255,255,255,0.06); }
    .stat .num{ font-size:1.4rem; font-weight:900; color:#fff; }
    .stat .label{ color:var(--muted); font-size:0.95rem; }

    /* Profile & leaderboard */
    #profile-section .profile-area{ display:grid; grid-template-columns: 1fr 320px; gap:14px; align-items:start; margin-top:12px; }
    @media (max-width:880px){ #profile-section .profile-area{ grid-template-columns: 1fr; } }
    .profile-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); }
    .small-card{ background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); }

    button, input, select{ touch-action:manipulation; }
  </style>
</head>
<body>
  <div class="container">
    <header style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <h1 style="margin:0; font-weight:900; letter-spacing:.02em;">üéØ Target Zone</h1>
      <div id="auth-ui">
        <button id="login-btn">Login</button>
        <button id="profile-btn" class="hidden">Profile</button>
      </div>
    </header>

    <!-- Dashboard / Exam Cards -->
    <section id="dashboard" class="card" style="margin-top:16px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <h3 style="margin:0; font-weight:900;">‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¨‡¶æ‡¶õ‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
        <div class="muted">Best % ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</div>
      </div>
      <div id="exam-cards" style="margin-top:12px;"></div>
    </section>

    <!-- QUIZ -->
    <section id="quiz-section" class="hidden">
      <div id="quiz-header" class="card" style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <div style="display:flex; align-items:center; gap:10px;">
          <span id="exam-tag" class="chip">‚Äî</span>
          <strong id="quiz-title">‚Äî</strong>
        </div>
        <div class="exam-meta"><span id="timer">00:00</span><span id="progress">0/0</span></div>
      </div>

      <div id="question-card" style="margin-top:12px;">
        <div id="question-text">‚Äî</div>
        <div id="difficulty-tag" class="muted" style="font-size:.92rem; margin-bottom:8px;">‚Äî</div>
        <ol id="options-list"></ol>

        <div id="palette" aria-label="question palette" style="margin-top:10px;"></div>
        <div class="palette-legend">
          <div class="legend-box"><span class="palette-un" style="width:22px;height:22px;border-radius:6px;display:inline-block;"></span> Unattempted</div>
          <div class="legend-box"><span class="palette-att" style="width:22px;height:22px;border-radius:6px;display:inline-block;"></span> Attempted</div>
          <div class="legend-box"><span class="palette-rev" style="width:22px;height:22px;border-radius:6px;display:inline-block;"></span> Review</div>
        </div>

        <div class="controls-row">
          <div class="controls-left">
            <button id="prev-btn">‚üµ Prev</button>
            <button id="next-btn">Next ‚ü∂</button>
            <button id="mark-btn">‚≠ê Mark</button>
            <button id="tts-btn">üîä Read</button>
          </div>
          <div id="submit-fixed"><button id="submit-btn">Submit</button></div>
        </div>
      </div>
    </section>

    <!-- RESULT -->
    <section id="result-section" class="hidden card" style="margin-top:16px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <h3 style="margin:0; font-weight:900;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</h3>
        <button id="close-result">Close</button>
      </div>
      <div class="stat-row" id="result-stats"></div>
      <div style="margin-top:12px; display:grid; place-items:center;">
        <canvas id="result-pie" width="320" height="320"></canvas>
      </div>
    </section>

    <!-- PROFILE / HISTORY / LEADERBOARD (combined view) -->
    <section id="profile-section" class="hidden card" style="margin-top:16px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-weight:800;">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶ì ‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßç‡¶∞‡¶æ</h3>
        <div>
          <button id="logout-btn" class="bg-red-500 px-3 py-1 rounded text-white">Logout</button>
        </div>
      </div>

      <div class="profile-area">
        <div>
          <div class="profile-card" style="display:flex; gap:12px; align-items:center;">
            <div style="width:72px;height:72px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); display:flex; align-items:center; justify-content:center; font-weight:800; font-size:1.2rem; border:1px solid rgba(255,255,255,0.06);">
              <span id="profile-initial">U</span>
            </div>
            <div style="flex:1;">
              <div id="profile-name" style="font-weight:800; font-size:1.05rem;">User</div>
              <div id="profile-email" class="muted" style="font-size:0.95rem; margin-top:4px;"></div>
              <div style="margin-top:10px;">
                <button id="edit-name-btn" class="bg-white/6 px-3 py-1 rounded">Name ‡¶¨‡¶¶‡¶≤‡¶æ‡¶®</button>
              </div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <h4 style="margin:6px 0 8px 0; font-weight:800;">Past Attempts</h4>
            <div id="past-attempts" style="display:flex; flex-direction:column; gap:8px;"></div>
          </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:12px;">
          <div class="small-card">
            <div style="font-weight:700; font-size:0.95rem;">User Summary</div>
            <div id="user-summary" class="muted" style="margin-top:8px;">‚Äî</div>
          </div>

          <div class="small-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div style="font-weight:700;">Leaderboard</div>
              <select id="leaderboard-exam" class="bg-white/6 px-2 py-1 rounded"></select>
            </div>
            <ul id="leaderboard-list" style="margin-top:12px; list-style:none; padding:0;"></ul>
          </div>
        </div>
      </div>
    </section>

    <div style="padding: 0 1.5rem 1.5rem;">
      <footer id="site-footer" class="site-footer card" style="margin-top:18px; text-align:center;">
        üìå ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‚Äî SSC | Railways | TET | WB SET | WBJEE | Madhyamik ‚Äî ‡¶∏‡¶¨ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶è‡¶ï ‡¶ú‡¶æ‡¶Ø‡¶º‡¶ó‡¶æ‡¶Ø‡¶º
      </footer>
    </div>
  </div>

  <!-- ============================
       Firebase + App Script (updated)
       ============================ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, orderBy, addDoc, doc, setDoc, onSnapshot, updateDoc, getDoc, where, limit, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCR5rqthBh0vX0yLOcOG3b9xJiKbYtzdxU",
      authDomain: "target-zone-8fffd.firebaseapp.com",
      projectId: "target-zone-8fffd",
      storageBucket: "target-zone-8fffd.appspot.com",
      messagingSenderId: "667579216123",
      appId: "1:667579216123:web:37bb1fcc724743073d005e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // offline cache (best-effort)
    try{ enableIndexedDbPersistence(db); }catch(e){ console.warn('persistence', e.message) }

    // ===== Exam List =====
    const exams = [
      {id:"ssc", name:"SSC Exams", desc:"CGL, CHSL, GD, MTS", icon:"üìö"},
      {id:"railways", name:"Railways", desc:"NTPC, Group-D, JE", icon:"üöÜ"},
      {id:"tet", name:"TET Exams", desc:"Primary & Upper Primary", icon:"üè´"},
      {id:"wbset", name:"WB SET", desc:"Paper I & II", icon:"üéì"},
      {id:"wbjee", name:"WBJEE", desc:"Engineering & Medical", icon:"üß™"},
      {id:"madhyamik", name:"Madhyamik / HS", desc:"Board MCQ Practice", icon:"üìù"}
    ];

    // refs
    const examCards = document.getElementById("exam-cards");
    const dashboard = document.getElementById("dashboard");
    const quizSection = document.getElementById("quiz-section");
    const resultSection = document.getElementById("result-section");
    const profileSection = document.getElementById("profile-section");

    // render cards
    function renderExamCards(){
      examCards.innerHTML = exams.map(ex => `
        <div class="exam-card" data-id="${ex.id}">
          <div class="top-row">
            <div class="title-desc" style="display:flex;align-items:center;gap:12px;min-width:0;flex:1;">
              <div class="exam-icon">${ex.icon}</div>
              <div style="min-width:0;">
                <h4>${ex.name}</h4>
                <div class="desc muted" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${ex.desc}</div>
              </div>
            </div>
            <div class="ring" style="--val:0" id="ring-${ex.id}"><div class="inner" id="best-${ex.id}">‚Äì%</div></div>
          </div>
          <div class="exam-foot">
            <div class="exam-meta"><span class="chip" id="attempts-${ex.id}">Attempts: ‚Äì</span></div>
            <button class="start-btn" data-start="${ex.id}">Start ‚ñ∂</button>
          </div>
        </div>
      `).join('');

      // click handlers
      examCards.querySelectorAll('[data-start]').forEach(btn=>{
        btn.addEventListener('click', (e)=> startExam(e.currentTarget.getAttribute('data-start')));
      });
    }
    renderExamCards();

    // Decorate cards with personal stats
    async function decorateCardsForUser(user){
      if(!user) return;
      for(const ex of exams){
        try{
          const q = query(collection(db,'results'), where('uid','==',user.uid), where('exam','==',ex.id), orderBy('score','desc'), limit(1));
          const snap = await getDocs(q);
          let attempts = 0, bestPct = 0;
          const allQ = query(collection(db,'results'), where('uid','==',user.uid), where('exam','==',ex.id));
          const allSnap = await getDocs(allQ); attempts = allSnap.size || 0;
          if(!snap.empty){
            const r = snap.docs[0].data();
            if(r.total) bestPct = Math.round((r.score/r.total)*100);
          }
          const ring = document.getElementById(`ring-${ex.id}`);
          const bestEl = document.getElementById(`best-${ex.id}`);
          const attEl = document.getElementById(`attempts-${ex.id}`);
          if(ring) ring.style.setProperty('--val', bestPct);
          if(bestEl) bestEl.textContent = bestPct? `${bestPct}%` : '‚Äì%';
          if(attEl) attEl.textContent = `Attempts: ${attempts}`;
        }catch(e){ console.warn('card stats', ex.id, e.message); }
      }
    }

    onAuthStateChanged(auth, (user)=>{
      decorateCardsForUser(user);
    });

    // ===== Quiz Logic (kept & strengthened) =====
    let currentExam = null;
    let questions = [];
    let answers = {};
    let reviewed = {};
    let currentIndex = 0;
    let timeLeft = 0; // seconds
    let timerInterval = null;
    let ttsEnabled = false;
    let pieChartInstance = null;

    function updateProgress(){
      const progress = document.getElementById('progress');
      if(!progress) return;
      const total = questions.length||0;
      const att = Object.keys(answers).length;
      progress.textContent = `${att}/${total}`;
    }

    function startTimer(){
      const el = document.getElementById('timer');
      clearInterval(timerInterval);
      timerInterval = setInterval(()=>{
        if(timeLeft<=0){ clearInterval(timerInterval); submitExam(); return; }
        timeLeft--; const m = String(Math.floor(timeLeft/60)).padStart(2,'0'); const s = String(timeLeft%60).padStart(2,'0');
        el.textContent = `${m}:${s}`;
      },1000);
    }

    window.startExam = startExam;
    async function startExam(examId){
      currentExam = examId;
      dashboard.classList.add('hidden');
      quizSection.classList.remove('hidden');
      document.getElementById('quiz-title').textContent = exams.find(x=>x.id===examId).name;
      document.getElementById('exam-tag').textContent = examId.toUpperCase();

      // fetch questions from Firestore collection named by examId
      try {
        const q = query(collection(db, examId), orderBy('id'));
        const snap = await getDocs(q);
        questions = snap.docs.map(d => d.data());
      } catch(e){
        // fallback demo question if no firestore collection exists
        questions = [
          {id:1, question:"‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∞‡¶æ‡¶ú‡¶ß‡¶æ‡¶®‡ßÄ ‡¶ï‡ßã‡¶•‡¶æ?", options:["‡¶¢‡¶æ‡¶ï‡¶æ","‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ","‡¶∞‡¶æ‡¶ú‡¶∂‡¶æ‡¶π‡ßÄ","‡¶ñ‡ßÅ‡¶≤‡¶®‡¶æ"], answer:"‡¶¢‡¶æ‡¶ï‡¶æ", difficulty:"Easy", topic:"Geography"},
          {id:2, question:"2 + 2 = ?", options:["3","4","5","6"], answer:"4", difficulty:"Easy", topic:"Math"}
        ];
      }

      // fresh attempt (no auto-restore)
      answers = {}; reviewed = {};
      currentIndex = 0;
      timeLeft = (questions.length * 60) || 80*60;
      renderQuestion();
      buildPalette();
      startTimer();
      try { history.pushState({section:'quiz'}, ''); } catch(e){}
    }

    function renderQuestion(){
      const q = questions[currentIndex] || { question: 'No question', options:[] };
      document.getElementById('question-text').textContent = `Q${currentIndex+1}: ${q.question}`;
      document.getElementById('difficulty-tag').textContent = `Difficulty: ${q.difficulty || 'N/A'} ‚Ä¢ Topic: ${q.topic || 'General'}`;

      const ol = document.getElementById('options-list');
      ol.innerHTML = '';
      (q.options || []).forEach((opt, idx)=>{
        const li = document.createElement('li');
        li.setAttribute('data-opt', opt);
        li.setAttribute('role','button');
        li.setAttribute('tabindex','0');

        const input = document.createElement('input');
        input.type='radio'; input.name='option'; input.value=opt;
        input.checked = (answers[currentIndex] === opt);

        input.onchange = () => {
          answers[currentIndex] = opt;
          // autosave silently per attempt (not used to auto-restore at new exam start)
          if (auth.currentUser) {
            try {
              localStorage.setItem(`${currentExam}_answers_${auth.currentUser.uid}`, JSON.stringify(answers));
              localStorage.setItem(`${currentExam}_review_${auth.currentUser.uid}`, JSON.stringify(reviewed));
            } catch(e){}
          }
          updatePalette(); updateProgress();
        };

        const spanText = document.createElement('span');
        spanText.className = 'opt-text';
        spanText.textContent = opt;

        li.appendChild(input);
        li.appendChild(spanText);

        li.addEventListener('click', (e)=>{ input.checked = true; input.dispatchEvent(new Event('change', { bubbles:true })); });
        li.addEventListener('keydown', (ev)=>{ if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); input.checked = true; input.dispatchEvent(new Event('change', { bubbles:true })); } });
        ol.appendChild(li);
      });
      updatePalette(); updateProgress();
      if (ttsEnabled) speakQuestion(questions[currentIndex]);
    }

    function buildPalette(){
      const wrap = document.getElementById('palette');
      wrap.innerHTML = '';
      for(let i=0;i<questions.length;i++){
        const b = document.createElement('button');
        b.textContent = i+1; b.className = 'palette-btn palette-un';
        b.onclick = ()=>{ currentIndex=i; renderQuestion(); };
        wrap.appendChild(b);
      }
      updatePalette();
    }

    function updatePalette(){
      const wrap = document.getElementById('palette');
      const buttons = wrap.querySelectorAll('.palette-btn');
      buttons.forEach((btn, idx)=>{
        btn.classList.remove('palette-un','palette-att','palette-rev');
        if(reviewed[idx]) btn.classList.add('palette-rev');
        else if(answers[idx]) btn.classList.add('palette-att');
        else btn.classList.add('palette-un');
      });
    }

    document.getElementById('prev-btn').onclick = ()=>{ if(currentIndex>0){ currentIndex--; renderQuestion(); }};
    document.getElementById('next-btn').onclick = ()=>{ if(currentIndex<questions.length-1){ currentIndex++; renderQuestion(); }};
    document.getElementById('mark-btn').onclick = ()=>{ reviewed[currentIndex] = !reviewed[currentIndex]; updatePalette(); };
    document.getElementById('tts-btn').onclick = ()=>{ ttsEnabled = !ttsEnabled; if(ttsEnabled) speakQuestion(questions[currentIndex]); };

    document.getElementById('submit-btn').onclick = ()=> { if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) return; submitExam(); };

    async function submitExam(){
      if (!auth.currentUser) { alert("Please sign in"); return; }
      let correct=0, wrong=0, unattempted=0, attempted=0;
      const topicMap = {};
      for(let i=0;i<questions.length;i++){
        const q = questions[i] || {};
        const given = answers[i];
        const norm = v => (typeof v === 'string' ? v.trim() : v);
        if (!given) { unattempted++; }
        else {
          attempted++;
          let isCorrect = false;
          if (norm(given) === norm(q.answer)) isCorrect = true;
          else {
            if (Array.isArray(q.options)) {
              const optIdxGiven = q.options.findIndex(o => norm(o) === norm(given));
              const optIdxAnswer = q.options.findIndex(o => norm(o) === norm(q.answer));
              if (optIdxGiven !== -1 && optIdxAnswer !== -1 && optIdxGiven === optIdxAnswer) isCorrect = true;
            }
          }
          if (isCorrect) correct++; else { wrong++; const t = q.topic || 'General'; topicMap[t] = (topicMap[t]||0)+1; }
        }
      }
      const total = questions.length || 0;
      const percent = total ? Math.round((correct/total)*100) : 0;

      // save minimal result to Firestore (best-effort)
      try {
        await addDoc(collection(db,'results'), {
          uid: auth.currentUser.uid,
          email: auth.currentUser.email,
          displayName: auth.currentUser.displayName || null,
          exam: currentExam,
          score: correct,
          total,
          correct, wrong, unattempted,
          topicMap,
          submittedAt: new Date()
        });
      } catch(e){ console.warn("Firestore save failed (maybe offline or rules):", e.message); }

      // clear local storage for this exam so a fresh attempt won't auto-restore
      try { localStorage.removeItem(`${currentExam}_answers_${auth.currentUser.uid}`); localStorage.removeItem(`${currentExam}_review_${auth.currentUser.uid}`); } catch(e){}

      clearInterval(timerInterval);
      showResultChart({correct, wrong, unattempted, attempted, total, percent});
    }

    function showResultChart(data){
      quizSection.classList.add('hidden');
      resultSection.classList.remove('hidden');

      const holder = document.getElementById('result-stats');
      holder.innerHTML = '';
      function statHtml(label, num){ const div = document.createElement('div'); div.className = 'stat'; div.innerHTML = `<div class="num">${num}</div><div class="label">${label}</div>`; return div; }
      holder.appendChild(statHtml('Total Questions', data.total));
      holder.appendChild(statHtml('Attempted', data.attempted));
      holder.appendChild(statHtml('Unattempted', data.unattempted));
      holder.appendChild(statHtml('Correct', data.correct));
      holder.appendChild(statHtml('Wrong', data.wrong));
      holder.appendChild(statHtml('Percentage', data.percent + '%'));

      const ctx = document.getElementById('result-pie').getContext('2d');
      if (pieChartInstance) pieChartInstance.destroy();
      pieChartInstance = new Chart(ctx, {
        type: 'pie',
        data: { labels: ['Correct','Wrong','Unattempted'], datasets: [{ data: [data.correct, data.wrong, data.unattempted], backgroundColor: ['#10b981','#ef4444','#d1d5db'] }] },
        options: { responsive:true, plugins:{ legend:{ position: 'bottom', labels:{color:'#fff'} }, tooltip:{ callbacks:{ label: function(ctx){ return `${ctx.label}: ${ctx.parsed}`; } } } } }
      });
      try { history.pushState({section:'result'}, ''); } catch(e){}
    }

    document.getElementById('close-result').onclick = ()=> { resultSection.classList.add('hidden'); dashboard.classList.remove('hidden'); try { history.pushState({section:'dashboard'}, ''); } catch(e){} };

    // Leaderboard
    const lbExamSelect = document.getElementById('leaderboard-exam');
    lbExamSelect.innerHTML = exams.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
    lbExamSelect.onchange = loadLeaderboard;
    async function loadLeaderboard(){
      const exam = lbExamSelect.value; const ul = document.getElementById('leaderboard-list'); ul.innerHTML = '<li class="muted">Loading‚Ä¶</li>';
      try { const q = query(collection(db,'results'), where('exam','==',exam), orderBy('score','desc'), limit(20)); const snap = await getDocs(q); ul.innerHTML = ''; snap.forEach(d=>{ const r=d.data(); const li=document.createElement('li'); li.className='card'; li.style.padding='10px'; li.innerHTML = `<strong>${r.displayName||r.email||'User'}</strong> ‚Äî ${r.score}/${r.total}`; ul.appendChild(li); }); if(!ul.children.length) ul.innerHTML = '<li class="muted">No results yet</li>'; } catch(e){ ul.innerHTML='<li class="muted">Error</li>'; }
    }
    loadLeaderboard();

    // simple TTS
    function speakQuestion(q){ try{ const u = new SpeechSynthesisUtterance((q.question||'') + ' ' + (q.options||[]).join(', ')); speechSynthesis.cancel(); speechSynthesis.speak(u); }catch(e){} }
  </script>
</body>
</html>
