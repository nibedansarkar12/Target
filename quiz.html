<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <title>Target Zone Mock Tests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { background: linear-gradient(135deg, #6a11cb, #2575fc); font-family: 'Segoe UI', sans-serif; }
    .card { transition: transform 0.2s ease-in-out; }
    .card:hover { transform: scale(1.03); }
    .dark { background: #1e293b; color:white; }
  </style>
</head>
<body class="p-4 text-gray-900">

  <!-- Dashboard -->
  <div id="dashboard" class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold text-white text-center mb-6">ЁЯОп Target Zone Mock Tests</h1>
    <p id="student-email" class="text-center text-white mb-6">рж▓рзЛржб рж╣ржЪрзНржЫрзЗ...</p>
    <div class="flex justify-between mb-4">
      <button onclick="showStudentDashboard()" class="bg-yellow-500 text-white px-4 py-2 rounded">ЁЯУК My Results</button>
      <button onclick="toggleDarkMode()" class="bg-gray-700 text-white px-4 py-2 rounded">ЁЯМЩ Dark Mode</button>
    </div>
    <h2 class="text-xl text-white mb-4">ржПржХржЯрж┐ ржкрж░рзАржХрзНрж╖рж╛ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи:</h2>
    <div id="exam-cards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
  </div> <!-- Dashboard рж╢рзЗрж╖ -->

  <!-- Quiz Container -->
  <div id="quiz-container" class="hidden max-w-7xl mx-auto bg-white rounded-lg shadow p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 id="quiz-header" class="text-xl font-semibold"></h2>
      <span id="timer" class="bg-blue-600 text-white px-3 py-1 rounded font-bold">80:00</span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
      <div id="progress-bar" class="bg-green-500 h-3 rounded-full" style="width:0%"></div>
    </div>
    <div id="stats" class="flex justify-between text-sm text-gray-600 mb-4"></div>
    <div class="grid grid-cols-4 gap-6">
      <!-- Question Area -->
      <div class="col-span-3">
        <div id="section-tabs" class="flex gap-3 mb-4"></div>
        <p id="question-text" class="text-lg font-semibold mb-3"></p>
        <ul id="options-list" class="space-y-3"></ul>
        <div class="flex justify-between mt-6">
          <button id="clear-response-btn" class="bg-gray-500 text-white px-4 py-2 rounded">ЁЯЧС Clear</button>
          <button id="mark-review-btn" class="bg-yellow-500 text-white px-4 py-2 rounded">ЁЯФЦ Mark for Review</button>
          <div>
            <button id="prev-btn" class="bg-gray-400 text-white px-4 py-2 rounded">тмЕ ржкрзВрж░рзНржмржмрж░рзНрждрзА</button>
            <button id="next-btn" class="bg-blue-600 text-white px-4 py-2 rounded">ржкрж░ржмрж░рзНрждрзА тЮб</button>
          </div>
        </div>
        <button id="submit-btn" class="bg-red-600 text-white px-4 py-2 rounded mt-6 w-full">ЁЯУд Submit Test</button>
      </div>

      <!-- Question Palette -->
      <div class="bg-gray-100 rounded p-4">
        <h3 class="font-bold mb-2">ЁЯЧВя╕П Question Palette</h3>
        <div id="palette" class="grid grid-cols-5 gap-2"></div>
        <p class="text-xs text-gray-600 mt-2">ЁЯЯв Attempted | ЁЯЯа Review | тЪк Unattempted</p>
      </div>
    </div>
  </div> <!-- Quiz Container рж╢рзЗрж╖ -->

  <!-- Result -->
  <div id="result-box" class="hidden max-w-7xl mx-auto bg-white rounded-lg shadow p-6 mt-6">
    <h2 class="text-2xl font-bold mb-4">ЁЯУК ржЖржкржирж╛рж░ ржлрж▓рж╛ржлрж▓</h2>
    <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
      <div id="score-bar" class="bg-green-500 h-4 rounded-full" style="width:0%"></div>
    </div>
    <div id="result-summary" class="mb-4"></div>
    <canvas id="resultChart" width="400" height="200" class="mb-6"></canvas>
    <button onclick="downloadPDF()" class="bg-blue-600 text-white px-4 py-2 rounded mb-4">тмЗя╕П Download PDF</button>
    <h3 class="text-lg font-semibold">ЁЯФО ржкрзНрж░рж╢рзНржиржнрж┐рждрзНрждрж┐ржХ рж░рж┐ржнрж┐ржЙ</h3>
    <div id="review-questions" class="space-y-4 mt-2"></div>
  </div> <!-- Result рж╢рзЗрж╖ -->

  <!-- Student Dashboard -->
  <div id="student-dashboard" class="hidden max-w-7xl mx-auto bg-white rounded-lg shadow p-6 mt-6">
    <h2 class="text-2xl font-bold mb-4">ЁЯУЪ My Results</h2>
    <canvas id="progressGraph" width="400" height="200" class="mb-6"></canvas>
    <div id="results-list"></div>
    <button onclick="backToDashboard()" class="bg-gray-600 text-white px-4 py-2 rounded mt-4">тмЕ Back</button>
  </div> <!-- Student Dashboard рж╢рзЗрж╖ -->

  <!-- Firebase Config + Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // ЁЯФе Firebase Config (рждрзЛржорж╛рж░ ржЖржЧрзЗрж░ ржлрж╛ржЗрж▓рзЗрж░ ржорждрзЛ)
    const firebaseConfig = {
      apiKey: "AIzaSyCR5rqthBh0vX0yLOcOG3b9xJiKbYtzdxU",
      authDomain: "target-zone-8fffd.firebaseapp.com",
      projectId: "target-zone-8fffd",
      storageBucket: "target-zone-8fffd.appspot.com",
      messagingSenderId: "667579216123",
      appId: "1:667579216123:web:37bb1fcc724743073d005e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const studentEmail=document.getElementById("student-email");
    const examCards=document.getElementById("exam-cards");

    onAuthStateChanged(auth,user=>{
      if(user){ studentEmail.textContent=`ЁЯСд ${user.email}`; }
      else{ alert("ржЖржкржирж┐ рж▓ржЧржЗржи ржХрж░рзЗржиржирж┐!"); window.location.href="index.html"; }
    });

    // Exam Cards
    const exams=[
      {id:"ssc",name:"SSC Exams",desc:"CGL, CHSL, GD, MTS"},
      {id:"railways",name:"Railways",desc:"NTPC, Group-D, JE"},
      {id:"tet",name:"TET Exams",desc:"Primary & Upper Primary"},
      {id:"wbset",name:"WB SET",desc:"Paper I & II"},
      {id:"wbjee",name:"WBJEE",desc:"Engineering & Medical"},
      {id:"madhyamik",name:"Madhyamik / HS",desc:"Board MCQ Practice"}
    ];

    examCards.innerHTML=exams.map(ex=>`
      <div class="card bg-white rounded-lg shadow p-5 cursor-pointer" onclick="openExam('${ex.id}')">
        <h2 class="text-xl font-semibold">${ex.name}</h2>
        <p class="text-gray-600 mt-2">${ex.desc}</p>
      </div>
    `).join("");

    // Dark Mode
    window.toggleDarkMode=function(){document.body.classList.toggle("dark");}
    // ЁЯФ╣ Exam Marking Schemes
    const markingSchemes = {
      "ssc": { correct:2, wrong:0.5 },
      "railways": { correct:1, wrong:0.25 },
      "tet": { correct:1, wrong:0.25 },
      "wbset": { correct:2, wrong:0 },
      "wbjee": { correct:2, wrong:0.5 },
      "madhyamik": { correct:1, wrong:0 }
    };

    // ЁЯФ╣ DOM Elements
    const dashboard=document.getElementById("dashboard");
    const quizContainer=document.getElementById("quiz-container");
    const resultBox=document.getElementById("result-box");
    const studentDashboard=document.getElementById("student-dashboard");
    const quizHeader=document.getElementById("quiz-header");
    const timerElement=document.getElementById("timer");
    const progressBar=document.getElementById("progress-bar");
    const stats=document.getElementById("stats");
    const questionText=document.getElementById("question-text");
    const optionsList=document.getElementById("options-list");
    const palette=document.getElementById("palette");
    const prevBtn=document.getElementById("prev-btn");
    const nextBtn=document.getElementById("next-btn");
    const markReviewBtn=document.getElementById("mark-review-btn");
    const clearResponseBtn=document.getElementById("clear-response-btn");
    const submitBtn=document.getElementById("submit-btn");
    const resultSummary=document.getElementById("result-summary");
    const reviewQuestions=document.getElementById("review-questions");
    const scoreBar=document.getElementById("score-bar");
    const resultsList=document.getElementById("results-list");
    const sectionTabs=document.getElementById("section-tabs");

    // ЁЯФ╣ Quiz Variables
    let currentExam="",questions=[],currentQuestion=0,answers={},reviewed={},timeLeft=80*60,timer,currentUser=null;

    // ЁЯФ╣ User Check
    onAuthStateChanged(auth,user=>{
      if(user){ currentUser=user; studentEmail.textContent=`ЁЯСд ${user.email}`; }
      else{ alert("ржЖржкржирж┐ рж▓ржЧржЗржи ржХрж░рзЗржиржирж┐!"); window.location.href="index.html"; }
    });

    // ЁЯФ╣ Open Exam
    window.openExam=async function(exam){
      currentExam=exam;
      dashboard.classList.add("hidden");
      quizContainer.classList.remove("hidden");
      quizHeader.textContent=`${exam.toUpperCase()} Mock Test`;
      await loadQuestions();
    }

    // ЁЯФ╣ Load Questions from Firestore
    async function loadQuestions(){
      const { collection, getDocs, query, orderBy } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js");
      const q=query(collection(db,currentExam),orderBy("id"));
      const snapshot=await getDocs(q);
      questions=snapshot.docs.map(doc=>doc.data());
      buildPalette();
      buildSectionTabs();
      showQuestion();
      startTimer();
    }

    // ЁЯФ╣ Build Question Palette
    function buildPalette(){
      palette.innerHTML="";
      for(let i=0;i<questions.length;i++){
        const btn=document.createElement("button");
        btn.textContent=i+1;
        btn.className="palette-btn unattempted";
        btn.onclick=()=>{currentQuestion=i;showQuestion();};
        palette.appendChild(btn);
      }
    }

    // ЁЯФ╣ Build Section Tabs
    function buildSectionTabs(){
      sectionTabs.innerHTML="";
      const sections=[...new Set(questions.map(q=>q.section||"General"))];
      sections.forEach(section=>{
        const btn=document.createElement("button");
        btn.textContent=section;
        btn.className="bg-blue-500 text-white px-3 py-1 rounded";
        btn.onclick=()=>{questions=questions.filter(q=>q.section===section||!q.section);currentQuestion=0;showQuestion();};
        sectionTabs.appendChild(btn);
      });
    }

    // ЁЯФ╣ Timer
    function startTimer(){
      timer=setInterval(()=>{
        if(timeLeft<=0){clearInterval(timer);submitQuiz();}
        else{
          timeLeft--;
          const min=Math.floor(timeLeft/60);
          const sec=timeLeft%60;
          timerElement.textContent=`${min}:${sec.toString().padStart(2,"0")}`;
          if(timeLeft<=300) timerElement.classList.add("warning");
        }
      },1000);
    }

    // ЁЯФ╣ Update Stats + Progress Bar
    function updateStats(){
      const attempted=Object.keys(answers).length;
      const unattempted=questions.length-attempted;
      const progress=(attempted/questions.length)*100;
      progressBar.style.width=progress+"%";
      stats.innerHTML=`<span>тЬЕ Attempted: ${attempted}</span><span>тЪк Unattempted: ${unattempted}</span>`;
      [...palette.children].forEach((btn,i)=>{
        btn.className="palette-btn unattempted";
        if(answers[i]) btn.classList.add("attempted");
        if(reviewed[i]) btn.classList.add("review");
      });
    }

    // ЁЯФ╣ Show Question
    function showQuestion(){
      const q=questions[currentQuestion];
      if(!q)return;
      questionText.textContent=`ржкрзНрж░рж╢рзНржи ${currentQuestion+1}: ${q.question}`;
      optionsList.innerHTML="";
      q.options.forEach(option=>{
        const li=document.createElement("li");
        li.classList.add("p-2","rounded","border","cursor-pointer","hover:bg-gray-100");
        const input=document.createElement("input");
        input.type="radio";input.name="option";input.value=option;
        if(answers[currentQuestion]===option) input.checked=true;
        input.addEventListener("change",()=>{answers[currentQuestion]=option;updateStats();});
        li.appendChild(input);li.append(option);
        optionsList.appendChild(li);
      });
      updateStats();
    }

    // ЁЯФ╣ Navigation + Controls
    prevBtn.onclick=()=>{if(currentQuestion>0){currentQuestion--;showQuestion();}};
    nextBtn.onclick=()=>{if(currentQuestion<questions.length-1){currentQuestion++;showQuestion();}};
    markReviewBtn.onclick=()=>{reviewed[currentQuestion]=true;updateStats();};
    clearResponseBtn.onclick=()=>{delete answers[currentQuestion];showQuestion();};
    submitBtn.onclick=submitQuiz;

    // ЁЯФ╣ Submit Quiz
    async function submitQuiz(){
      clearInterval(timer);
      let correct=0,wrong=0,unattempted=0,score=0;
      const scheme = markingSchemes[currentExam] || {correct:1, wrong:0};
      questions.forEach((q,i)=>{
        const given=answers[i];
        if(!given) unattempted++;
        else if(given===q.answer){correct++;score+=scheme.correct;}
        else{wrong++;score-=scheme.wrong;}
      });

      // Save Result
      const { doc, setDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js");
      if(currentUser){
        await setDoc(doc(db,"results",`${currentUser.uid}-${currentExam}-${Date.now()}`),{
          exam:currentExam,email:currentUser.email,
          answers,correct,wrong,unattempted,
          score,total:questions.length*scheme.correct,
          submittedAt:serverTimestamp()
        });
      }

      // Show Result Page
      quizContainer.classList.add("hidden");
      resultBox.classList.remove("hidden");
      const percent=(score/(questions.length*scheme.correct))*100;
      scoreBar.style.width=percent+"%";
      resultSummary.innerHTML=`
        тЬЕ рж╕ржарж┐ржХ: ${correct}<br>
        тЭМ ржнрзБрж▓: ${wrong}<br>
        тЪк ржЕржирзБрждрзНрждрж░рж┐ржд: ${unattempted}<br>
        ЁЯПЖ ржкрзНрж░рж╛ржкрзНржд ржиржорзНржмрж░: ${score}/${questions.length*scheme.correct}
      `;
      reviewQuestions.innerHTML=questions.map((q,i)=>`
        <div class="p-3 border rounded ${answers[i]===q.answer?'bg-green-100':'bg-red-100'}">
          <b>ржкрзНрж░рж╢рзНржи ${i+1}: ${q.question}</b><br>
          ржЖржкржирж╛рж░ ржЙрждрзНрждрж░: ${answers[i]||"тЭМ ржжрзЗржУржпрж╝рж╛ рж╣ржпрж╝ржирж┐"}<br>
          рж╕ржарж┐ржХ ржЙрждрзНрждрж░: ${q.answer}
        </div>
      `).join("");

      // Chart
      new Chart(document.getElementById("resultChart"),{
        type:"pie",
        data:{labels:["Correct","Wrong","Unattempted"],
              datasets:[{data:[correct,wrong,unattempted],
                         backgroundColor:["#4caf50","#f44336","#9e9e9e"]}]}
      });
    }

    // ЁЯФ╣ Student Dashboard
    window.showStudentDashboard=async function(){
      dashboard.classList.add("hidden");
      studentDashboard.classList.remove("hidden");
      loadResults();
    }

    async function loadResults(){
      const { collection, getDocs, query, orderBy } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js");
      resultsList.innerHTML="рж▓рзЛржб рж╣ржЪрзНржЫрзЗ...";
      const q=query(collection(db,"results"),orderBy("submittedAt","desc"));
      const snapshot=await getDocs(q);
      let html="",scores=[];
      snapshot.forEach(docSnap=>{
        const res=docSnap.data();
        if(res.email===currentUser.email){
          const percent=((res.score/res.total)*100).toFixed(0);
          scores.push(percent);
          html+=`
            <div class="p-4 border rounded mb-3">
              <b>${res.exam.toUpperCase()}</b> - ЁЯПЖ ${res.score}/${res.total} (${percent}%)<br>
              тЬЕ ${res.correct}, тЭМ ${res.wrong}, тЪк ${res.unattempted}
            </div>
          `;
        }
      });
      resultsList.innerHTML=html||"<p>ржХрзЛржирзЛ ржЯрзЗрж╕рзНржЯ ржжрзЗржУржпрж╝рж╛ рж╣ржпрж╝ржирж┐ред</p>";

      new Chart(document.getElementById("progressGraph"),{
        type:"line",
        data:{labels:scores.map((_,i)=>`Test ${i+1}`),
              datasets:[{label:"Progress (%)",data:scores,borderColor:"#4caf50"}]}
      });
    }

    // ЁЯФ╣ Back to Dashboard
    window.backToDashboard=function(){
      studentDashboard.classList.add("hidden");
      dashboard.classList.remove("hidden");
    }

    // ЁЯФ╣ PDF Download
    window.downloadPDF=function(){
      const { jsPDF } = window.jspdf;
      const doc=new jsPDF();
      doc.text("Target Zone Mock Test Result",20,20);
      doc.text(resultSummary.innerText,20,40);
      doc.save("result.pdf");
          }
  </script>
</body>
</html>
