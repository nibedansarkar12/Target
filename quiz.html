<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <title>Target Zone ‚Äî Full Platform (Updated)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --glass: rgba(255,255,255,0.06);
      --muted: rgba(255,255,255,0.78);
      --accent: #10b981;
      --attempted: #10b981;
      --review: #f59e0b;
      --unattempted: #d1d5db;
    }
    body{
      font-family: 'Segoe UI', system-ui, -apple-system, "Noto Sans Bengali", sans-serif;
      margin:0; min-height:100vh;
      background: radial-gradient(circle at 10% 10%, #1e3c72 0%, #2a5298 60%, #0f172a 100%);
      color: #fff;
      overflow-x:hidden;
    }
    #stars,#planes{ position:fixed; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events:none; }

    main{ position:relative; z-index:10; padding-bottom:160px; max-width:1200px; margin:0 auto; }

    .card{ background:var(--glass); border-radius:12px; padding:16px; box-shadow: 0 8px 24px rgba(2,6,23,0.45); }
    .muted{ color:var(--muted); }
    header.sticky-top{ position:sticky; top:0; z-index:40; backdrop-filter: blur(6px); padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    header h1{ font-size:1.5rem; margin:0; font-weight:800; }

    /* Dashboard / exam cards */
    #exam-cards{ display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:16px; margin-top:12px; }
    .exam-card{ background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border-radius:12px; padding:14px; display:flex; flex-direction:column; gap:8px; min-height:110px; justify-content:space-between; }
    .exam-card h4{ margin:0; font-weight:700; }
    .exam-card p{ margin:0; color:var(--muted); font-size:0.95rem; }

    /* Quiz area visuals */
    #quiz-section { padding: 18px; }
    #question-card { background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(255,255,255,0.02)); border-radius:12px; padding:16px; box-shadow: 0 10px 30px rgba(2,6,23,0.45); }
    #question-text { font-size:1.1rem; font-weight:700; margin-bottom:8px; color:#fff; }
    #options-list li { background: rgba(255,255,255,0.04); padding:10px; border-radius:10px; display:flex; gap:12px; align-items:center; cursor:pointer; }
    #options-list li input[type="radio"]{ transform:scale(1.05); }

    /* Palette */
    #palette{ display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .palette-btn{ min-width:44px; min-height:44px; border-radius:8px; padding:6px 10px; display:flex; align-items:center; justify-content:center; font-weight:700; cursor:pointer; border:none; color: #0f172a; }
    .palette-un { background: var(--unattempted); color:#0f172a; }
    .palette-att { background: var(--attempted); color:white; }
    .palette-rev { background: var(--review); color:white; }
    .palette-legend{ display:flex; gap:10px; align-items:center; margin-top:8px; color:var(--muted); font-size:0.95rem; }

    /* Submit button repositioned: center & fixed on small screens */
    .controls-row{ display:flex; gap:10px; align-items:center; margin-top:12px; }
    .controls-left{ display:flex; gap:8px; }
    #submit-btn{ background:#ef4444; color:white; padding:10px 18px; border-radius:10px; border:none; cursor:pointer; font-weight:700; }

    /* On very small screens, make submit fixed bottom center */
    @media (max-width:640px){
      #submit-fixed{ position:fixed; left:50%; transform:translateX(-50%); bottom:14px; z-index:60; width:calc(100% - 40px); max-width:540px; display:flex; justify-content:center; }
    }

    /* Result simple card */
    #result-section .stat-row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
    .stat { background: rgba(255,255,255,0.04); padding:12px; border-radius:8px; min-width:120px; text-align:center; }
    .stat .num{ font-size:1.4rem; font-weight:800; color:#fff; }
    .stat .label{ color:var(--muted); font-size:0.95rem; }

    /* Profile */
    #profile-section .profile-card{ display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap; }

  </style>
</head>
<body>

  <canvas id="stars"></canvas>
  <canvas id="planes"></canvas>

  <header class="sticky-top card" role="banner">
    <div style="display:flex; align-items:center; gap:12px;">
      <h1>Target Zone</h1>
      <div class="muted" style="font-weight:600;">‚Äî Mock tests & analytics</div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <div id="auth-ui" style="display:flex; gap:8px; align-items:center;"></div>
    </div>
  </header>

  <main class="p-6">
    <!-- DASHBOARD -->
    <section id="dashboard" class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <div>
          <h2 style="font-size:1.25rem; margin:0; font-weight:800;">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</h2>
          <p class="muted" style="margin-top:6px;">‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡ßü‡ßá ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶® ‚Äî ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶•‡ßá‡¶ï‡ßá Start ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®</p>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="go-profile" class="bg-white/6 px-3 py-1 rounded">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</button>
          <button id="go-history" class="bg-white/6 px-3 py-1 rounded">‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</button>
          <button id="go-leaderboard" class="bg-white/6 px-3 py-1 rounded">Leaderboard</button>
        </div>
      </div>

      <div id="exam-cards" class="mt-4">
        <!-- JS injects cards -->
      </div>
    </section>

    <!-- QUIZ AREA -->
    <section id="quiz-section" class="hidden card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="back-to-dashboard" class="bg-white/6 px-2 py-1 rounded">‚Üê Back</button>
          <div>
            <h3 id="quiz-title" style="margin:0; font-weight:800;">Mock Test</h3>
            <div id="exam-tag" class="muted" style="font-size:0.95rem;">‚Äî</div>
          </div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="tts-toggle" class="bg-white/6 px-2 py-1 rounded">üîä Play Voice</button>
          <div id="timer" class="muted" style="background:rgba(255,255,255,0.04); padding:6px 10px; border-radius:8px;">80:00</div>
        </div>
      </div>

      <div id="question-card" class="mt-4">
        <p id="question-text">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
        <div id="difficulty-tag" class="muted" style="font-size:0.95rem;">Difficulty: -</div>

        <ul id="options-list" class="mt-4 space-y-2"></ul>

        <div class="controls-row" style="margin-top:14px;">
          <div class="controls-left">
            <button id="prev-btn" class="bg-white/6 px-3 py-1 rounded">‚¨Ö ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ</button>
            <button id="next-btn" class="bg-white/6 px-3 py-1 rounded">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‚û°</button>
            <button id="mark-review-btn" class="bg-yellow-500 px-3 py-1 rounded text-white">üîñ Review</button>
          </div>

          <div style="flex:1;">
            <div style="width:100%; background:rgba(255,255,255,0.06); height:10px; border-radius:8px; overflow:hidden;">
              <div id="progress-bar" style="width:0%; height:100%; background:var(--accent);"></div>
            </div>
          </div>

        </div>

        <!-- Palette -->
        <div id="palette" class="mt-4"></div>
        <div class="palette-legend">
          <div style="display:flex; gap:6px; align-items:center;"><div style="width:18px;height:18px;background:var(--attempted);border-radius:4px;"></div> ‚úî Attempted</div>
          <div style="display:flex; gap:6px; align-items:center;"><div style="width:18px;height:18px;background:var(--review);border-radius:4px;"></div> ‚öë Review</div>
          <div style="display:flex; gap:6px; align-items:center;"><div style="width:18px;height:18px;background:var(--unattempted);border-radius:4px;"></div> ‚Äî Unattempted</div>
        </div>

        <!-- Submit button centered; small screens fixed via #submit-fixed -->
        <div id="submit-fixed" style="margin-top:14px;">
          <button id="submit-btn">‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</button>
        </div>

      </div>
    </section>

    <!-- RESULT / ANALYSIS (Simplified counts only) -->
    <section id="result-section" class="hidden card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-weight:800;">Result</h3>
        <div>
          <button id="download-cert" class="bg-blue-600 px-3 py-1 rounded text-white">Download Certificate</button>
          <button id="close-result" class="bg-white/6 px-2 py-1 rounded">Close</button>
        </div>
      </div>

      <div class="stat-row" id="result-stats">
        <!-- injected simple stats -->
      </div>

      <div style="margin-top:12px;" id="result-note" class="muted">‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®, ‡¶ï‡¶§‡¶ü‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®, ‡¶ï‡¶§‡¶ü‡¶ø ‡¶ï‡¶∞‡ßá‡¶®‡¶®‡¶ø, ‡¶ï‡¶§‡¶ü‡¶ø ‡¶†‡¶ø‡¶ï ‡¶ì ‡¶≠‡ßÅ‡¶≤ ‚Äî ‡¶è ‡¶∑‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü ‡¶¶‡¶ø‡ßü‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§</div>
    </section>

    <!-- PROFILE / HISTORY (single card; user-only view) -->
    <section id="profile-section" class="hidden card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-weight:800;">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</h3>
        <div>
          <button id="logout-btn" class="bg-red-500 px-3 py-1 rounded text-white">Logout</button>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="profile-card">
          <div style="flex:1;">
            <div id="profile-email" class="muted"></div>
            <div style="margin-top:8px;">
              <h4 style="margin:0; font-weight:700;">Past Attempts</h4>
              <ul id="past-attempts" style="margin-top:8px; list-style:none; padding:0;"></ul>
            </div>
          </div>
          <div style="min-width:220px;">
            <div class="card" style="background:rgba(255,255,255,0.03);">
              <div style="font-weight:700; font-size:0.95rem;">User Summary</div>
              <div id="user-summary" class="muted" style="margin-top:8px;"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- LEADERBOARD -->
    <section id="leaderboard-section" class="hidden card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-weight:800;">Leaderboard</h3>
        <select id="leaderboard-exam" class="bg-white/6 px-2 py-1 rounded"></select>
      </div>
      <ul id="leaderboard-list" style="margin-top:12px; list-style:none; padding:0;"></ul>
    </section>

  </main>

  <div style="padding: 0 1.5rem 1.5rem;">
    <footer id="site-footer" class="site-footer card" style="margin-top:18px; text-align:center;">
      üìå ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‚Äî SSC | Railways | TET | WB SET | WBJEE | Madhyamik ‚Äî ‡¶∏‡¶¨ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶è‡¶ï ‡¶ú‡¶æ‡¶Ø‡¶º‡¶ó‡¶æ‡¶Ø‡¶º
    </footer>
  </div>

  <!-- ============================
       Firebase + App Script (updated per requests)
       ============================ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, orderBy, addDoc, doc, setDoc, onSnapshot, updateDoc, getDoc, where
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCR5rqthBh0vX0yLOcOG3b9xJiKbYtzdxU",
      authDomain: "target-zone-8fffd.firebaseapp.com",
      projectId: "target-zone-8fffd",
      storageBucket: "target-zone-8fffd.appspot.com",
      messagingSenderId: "667579216123",
      appId: "1:667579216123:web:37bb1fcc724743073d005e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // exams
    const exams = [
      {id:"ssc", name:"SSC Exams", desc:"CGL, CHSL, GD, MTS"},
      {id:"railways", name:"Railways", desc:"NTPC, Group-D, JE"},
      {id:"tet", name:"TET Exams", desc:"Primary & Upper Primary"},
      {id:"wbset", name:"WB SET", desc:"Paper I & II"},
      {id:"wbjee", name:"WBJEE", desc:"Engineering & Medical"},
      {id:"madhyamik", name:"Madhyamik / HS", desc:"Board MCQ Practice"}
    ];

    // refs
    const examCards = document.getElementById("exam-cards");
    const dashboard = document.getElementById("dashboard");
    const quizSection = document.getElementById("quiz-section");
    const resultSection = document.getElementById("result-section");
    const profileSection = document.getElementById("profile-section");
    const leaderboardSection = document.getElementById("leaderboard-section");
    const authUi = document.getElementById("auth-ui");

    // populate exam cards as neat cards
    examCards.innerHTML = exams.map(ex => `
      <div class="exam-card" data-id="${ex.id}">
        <div>
          <h4>${ex.name}</h4>
          <p class="muted">${ex.desc}</p>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div class="muted" style="font-size:0.9rem;">MCQ Practice</div>
          <div><button class="start-exam" data-id="${ex.id}" style="background:#2563eb;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;">Start</button></div>
        </div>
      </div>
    `).join("");

    // app state
    let currentExam = null, questions = [], currentIndex = 0;
    let answers = {}, reviewed = {}, timeLeft = 80*60, timerInterval = null;
    let currentUser = null;
    let ttsEnabled = false;

    // auth UI
    function renderAuthUI(){
      authUi.innerHTML = '';
      if (!currentUser) {
        authUi.innerHTML = `
          <button id="btn-signin" class="bg-white/6 px-3 py-1 rounded">Sign In</button>
          <button id="btn-signup" class="bg-white/6 px-3 py-1 rounded">Sign Up</button>
        `;
        document.getElementById("btn-signin").onclick = showSignIn;
        document.getElementById("btn-signup").onclick = showSignUp;
      } else {
        authUi.innerHTML = `<div class="muted" style="font-weight:700;">Hi, ${currentUser.email}</div>`;
      }
    }
    function showSignUp(){
      const email = prompt("Email:");
      const pass = prompt("Password (6+):");
      if (!email || !pass) return alert("Invalid");
      createUserWithEmailAndPassword(auth,email,pass)
        .then(cred => { alert("Registered"); })
        .catch(err => alert(err.message));
    }
    function showSignIn(){
      const email = prompt("Email:");
      const pass = prompt("Password:");
      if (!email || !pass) return alert("Invalid");
      signInWithEmailAndPassword(auth,email,pass)
        .then(u => alert("Signed in"))
        .catch(err => alert(err.message));
    }

    document.getElementById("go-profile").onclick = () => showSection('profile');
    document.getElementById("go-history").onclick = () => showSection('profile');
    document.getElementById("go-leaderboard").onclick = () => showSection('leaderboard');

    function showSection(name){
      dashboard.classList.toggle('hidden', name !== 'dashboard');
      quizSection.classList.toggle('hidden', name !== 'quiz');
      resultSection.classList.toggle('hidden', name !== 'result');
      profileSection.classList.toggle('hidden', name !== 'profile');
      leaderboardSection.classList.toggle('hidden', name !== 'leaderboard');
      if (name === 'dashboard') dashboard.classList.remove('hidden');
    }

    onAuthStateChanged(auth, user => {
      currentUser = user;
      renderAuthUI();
      if (user) loadUserHistory();
    });

    // start exam
    document.querySelectorAll('.start-exam').forEach(btn => {
      btn.onclick = async (e) => {
        if (!auth.currentUser) return alert("Please sign in first.");
        const examId = e.target.dataset.id;
        await startExam(examId);
      };
    });

    async function startExam(examId){
      currentExam = examId;
      dashboard.classList.add('hidden');
      quizSection.classList.remove('hidden');
      document.getElementById('quiz-title').textContent = exams.find(x=>x.id===examId).name;
      document.getElementById('exam-tag').textContent = examId.toUpperCase();

      // fetch questions (same approach)
      const q = query(collection(db, examId), orderBy('id'));
      const snap = await getDocs(q);
      questions = snap.docs.map(d => d.data());
      answers = JSON.parse(localStorage.getItem(`${examId}_answers_${auth.currentUser.uid}`) || '{}');
      reviewed = JSON.parse(localStorage.getItem(`${examId}_review_${auth.currentUser.uid}`) || '{}');
      currentIndex = 0;
      timeLeft = (questions.length * 60) || 80*60;
      renderQuestion();
      buildPalette();
      startTimer();
    }

    function renderQuestion(){
      const q = questions[currentIndex] || { question: 'No question', options:[] };
      document.getElementById('question-text').textContent = `Q${currentIndex+1}: ${q.question}`;
      document.getElementById('difficulty-tag').textContent = `Difficulty: ${q.difficulty || 'N/A'} ‚Ä¢ Topic: ${q.topic || 'General'}`;

      const ol = document.getElementById('options-list');
      ol.innerHTML = '';
      (q.options || []).forEach(opt=>{
        const li = document.createElement('li');
        li.className = '';
        const input = document.createElement('input');
        input.type='radio'; input.name='option'; input.value=opt;
        input.checked = (answers[currentIndex] === opt);
        input.onchange = () => {
          answers[currentIndex] = opt;
          localStorage.setItem(`${currentExam}_answers_${auth.currentUser.uid}`, JSON.stringify(answers));
          updatePalette(); updateProgress();
        };
        li.appendChild(input);
        const span = document.createElement('span');
        span.style.marginLeft='6px';
        span.textContent = opt;
        li.appendChild(span);
        ol.appendChild(li);
      });
      updatePalette(); updateProgress();
      if (ttsEnabled) speakQuestion(questions[currentIndex]);
    }

    document.getElementById('prev-btn').onclick = ()=>{ if(currentIndex>0){ currentIndex--; renderQuestion(); } };
    document.getElementById('next-btn').onclick = ()=>{ if(currentIndex<questions.length-1){ currentIndex++; renderQuestion(); } };
    document.getElementById('mark-review-btn').onclick = ()=>{ reviewed[currentIndex]=true; localStorage.setItem(`${currentExam}_review_${auth.currentUser.uid}`, JSON.stringify(reviewed)); updatePalette(); };

    // palette build & update (clear icons & colors)
    function buildPalette(){
      const pal = document.getElementById('palette');
      pal.innerHTML = '';
      for(let i=0;i<questions.length;i++){
        const b = document.createElement('button');
        b.className = 'palette-btn palette-un';
        b.title = `Question ${i+1}`;
        b.innerHTML = `${i+1}<span style="font-size:0.7rem;margin-left:6px;"></span>`;
        b.onclick = ()=>{ currentIndex = i; renderQuestion(); };
        pal.appendChild(b);
      }
      updatePalette();
    }
    function updatePalette(){
      const children = [...document.getElementById('palette').children];
      children.forEach((btn,i)=>{
        btn.className = 'palette-btn palette-un';
        btn.innerHTML = `${i+1}`;
        if (answers[i]) { btn.classList.remove('palette-un'); btn.classList.add('palette-att'); btn.innerHTML = `${i+1} ‚úî`; btn.title = `Attempted ‚Ä¢ Q${i+1}`; }
        if (reviewed[i]) { btn.classList.remove('palette-att','palette-un'); btn.classList.add('palette-rev'); btn.innerHTML = `${i+1} ‚öë`; btn.title = `Marked for review ‚Ä¢ Q${i+1}`; }
      });
    }
    function updateProgress(){
      const attempted = Object.keys(answers).length;
      const percent = Math.round((attempted / questions.length)*100) || 0;
      document.getElementById('progress-bar').style.width = percent + '%';
    }

    // timer
    function startTimer(){
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(()=>{
        if (timeLeft<=0){ clearInterval(timerInterval); submitExam(); return; }
        timeLeft--;
        const m = Math.floor(timeLeft/60), s = timeLeft%60;
        document.getElementById('timer').textContent = `${m}:${String(s).padStart(2,'0')}`;
      },1000);
    }

    // submit -> compute simplified counts -> save -> show minimal result view
    document.getElementById('submit-btn').onclick = ()=> {
      if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) return;
      submitExam();
    };

    async function submitExam(){
      if (!auth.currentUser) { alert("Please sign in"); return; }
      let correct=0, wrong=0, unattempted=0, attempted=0;
      const topicMap = {};
      for(let i=0;i<questions.length;i++){
        const q = questions[i];
        const given = answers[i];
        if (!given) { unattempted++; }
        else {
          attempted++;
          if (given === q.answer) correct++;
          else { wrong++; const t = q.topic || 'General'; topicMap[t] = (topicMap[t]||0)+1; }
        }
      }
      const total = questions.length;
      const percent = Math.round((correct/total)*100);

      // save minimal result to Firestore
      await addDoc(collection(db,'results'), {
        uid: auth.currentUser.uid,
        email: auth.currentUser.email,
        exam: currentExam,
        score: correct,
        total,
        correct, wrong, unattempted,
        topicMap,
        submittedAt: new Date()
      });

      // clear local storage
      localStorage.removeItem(`${currentExam}_answers_${auth.currentUser.uid}`);
      localStorage.removeItem(`${currentExam}_review_${auth.currentUser.uid}`);
      clearInterval(timerInterval);

      // show minimal result
      showMinimalResult({correct, wrong, unattempted, attempted, total, percent});
    }

    function showMinimalResult(data){
      quizSection.classList.add('hidden');
      resultSection.classList.remove('hidden');
      const holder = document.getElementById('result-stats');
      holder.innerHTML = '';
      function statHtml(label, num){
        const div = document.createElement('div');
        div.className = 'stat';
        div.innerHTML = `<div class="num">${num}</div><div class="label">${label}</div>`;
        return div;
      }
      holder.appendChild(statHtml('Total Questions', data.total));
      holder.appendChild(statHtml('Attempted', data.attempted));
      holder.appendChild(statHtml('Unattempted', data.unattempted));
      holder.appendChild(statHtml('Correct', data.correct));
      holder.appendChild(statHtml('Wrong', data.wrong));
      holder.appendChild(statHtml('Percentage', data.percent + '%'));

      document.getElementById('download-cert').onclick = async ()=>{
        const q = query(collection(db,'results'), where('uid','==',auth.currentUser.uid), where('exam','==',currentExam), orderBy('submittedAt','desc'));
        const snap = await getDocs(q);
        if (snap.empty) return alert("No result found to create certificate.");
        const r = snap.docs[0].data();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(22); doc.text("Certificate of Achievement", 20, 30);
        doc.setFontSize(14); doc.text(`This certifies that ${auth.currentUser.email}`, 20, 50);
        doc.text(`has scored ${r.score}/${r.total} in ${r.exam.toUpperCase()}`, 20, 60);
        doc.text(`Date: ${new Date(r.submittedAt?.toDate?.() || r.submittedAt).toLocaleDateString()}`, 20, 80);
        doc.save(`certificate_${currentExam}_${auth.currentUser.uid}.pdf`);
      };
    }

    document.getElementById('close-result').onclick = ()=> {
      resultSection.classList.add('hidden');
      dashboard.classList.remove('hidden');
    };

    // leaderboard
    const lbExamSelect = document.getElementById('leaderboard-exam');
    lbExamSelect.innerHTML = exams.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
    lbExamSelect.onchange = loadLeaderboard;
    async function loadLeaderboard(){
      const exam = lbExamSelect.value;
      // query results for selected exam ordered by score desc
      // Note: Firestore requires composite index for combined where+order; keep minimal for demo
      const q = query(collection(db,'results'), where('exam','==',exam), orderBy('score','desc'));
      const snap = await getDocs(q);
      const ul = document.getElementById('leaderboard-list');
      ul.innerHTML = '';
      snap.forEach(d=>{
        const r = d.data();
        const li = document.createElement('li');
        li.style.marginBottom='8px';
        li.className = 'card';
        li.innerText = `${r.email} ‚Äî ${r.score}/${r.total} ‚Äî ${new Date(r.submittedAt?.toDate?.() || r.submittedAt).toLocaleString()}`;
        ul.appendChild(li);
      });
    }
    lbExamSelect.value = exams[0].id;
    loadLeaderboard();

    // user history & profile summary
    async function loadUserHistory(){
      if (!auth.currentUser) return;
      document.getElementById('profile-email').textContent = auth.currentUser.email;
      const q = query(collection(db,'results'), where('uid','==',auth.currentUser.uid), orderBy('submittedAt','asc'));
      const snap = await getDocs(q);
      const arr = snap.docs.map(d=>d.data());
      const ul = document.getElementById('past-attempts'); ul.innerHTML='';
      let totalAttempts = 0, bestPercent = 0;
      arr.forEach(r=>{
        totalAttempts++;
        const li = document.createElement('li');
        li.style.marginBottom='8px';
        li.className = 'card';
        li.innerText = `${r.exam} ‚Äî ${r.score}/${r.total} ‚Äî ${new Date(r.submittedAt?.toDate?.() || r.submittedAt).toLocaleDateString()}`;
        ul.appendChild(li);
        const p = Math.round((r.score / r.total)*100);
        if (p > bestPercent) bestPercent = p;
      });
      document.getElementById('user-summary').textContent = `Attempts: ${totalAttempts} ‚Ä¢ Best: ${bestPercent}%`;
    }

    document.getElementById('logout-btn').onclick = ()=>{ signOut(auth); };

    // tts
    document.getElementById('tts-toggle').onclick = ()=> {
      ttsEnabled = !ttsEnabled;
      document.getElementById('tts-toggle').innerText = ttsEnabled ? 'üîä Stop Voice' : 'üîä Play Voice';
      if (!ttsEnabled) speechSynthesis.cancel();
      else speakQuestion(questions[currentIndex]);
    };
    function speakQuestion(q){
      if (!q || !ttsEnabled) return;
      speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance();
      utter.lang = 'bn-BD';
      utter.text = `‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: ${q.question}. `;
      (q.options || []).forEach((opt,i)=>{ utter.text += `‡¶¨‡¶ø‡¶ï‡¶≤‡ßç‡¶™ ${i+1}: ${opt}. `; });
      speechSynthesis.speak(utter);
    }

    // autosave on unload
    window.addEventListener('beforeunload', ()=>{
      if (currentExam && auth.currentUser) {
        localStorage.setItem(`${currentExam}_answers_${auth.currentUser.uid}`, JSON.stringify(answers));
        localStorage.setItem(`${currentExam}_review_${auth.currentUser.uid}`, JSON.stringify(reviewed));
      }
    });

    // initial
    renderAuthUI();

    // background animation (kept simple)
    const starsCanvas = document.getElementById("stars");
    const planesCanvas = document.getElementById("planes");
    const starsCtx = starsCanvas.getContext("2d");
    const planesCtx = planesCanvas.getContext("2d");
    function resizeCanvases(){ starsCanvas.width = planesCanvas.width = window.innerWidth; starsCanvas.height = planesCanvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvases);
    resizeCanvases();
    let stars = [], planes = [];
    function initBackground(){
      stars = []; planes = [];
      const count = Math.max(80, Math.floor((window.innerWidth * window.innerHeight) / 8000));
      for (let i = 0; i < count; i++) stars.push({ x: Math.random()*starsCanvas.width, y: Math.random()*starsCanvas.height, r: Math.random()*1.5, twinkle: Math.random()*1.5 });
      for (let i = 0; i < 2; i++) planes.push({ x: -50, y: Math.random()*starsCanvas.height*0.4, dx: 2+Math.random()*2 });
    }
    initBackground();
    function drawBackground() {
      starsCtx.clearRect(0,0,starsCanvas.width,starsCanvas.height);
      stars.forEach(s => {
        starsCtx.beginPath();
        const alpha = 0.6 + 0.4*Math.sin((Date.now()/500) * s.twinkle);
        starsCtx.fillStyle = `rgba(255,255,255,${alpha})`;
        starsCtx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
        starsCtx.fill();
      });
      planesCtx.clearRect(0,0,planesCanvas.width,planesCanvas.height);
      planes.forEach(p => {
        planesCtx.fillStyle = "rgba(173,216,230,0.07)";
        planesCtx.fillRect(p.x, p.y, 40, 3);
        p.x += p.dx;
        if (p.x > planesCanvas.width + 100) { p.x = -50; p.y = Math.random()*planesCanvas.height*0.4; p.dx = 2 + Math.random()*3; }
      });
    }
    setInterval(drawBackground, 30);

  </script>
</body>
</html>
