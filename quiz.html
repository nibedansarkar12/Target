<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <title>Target Zone ‚Äî Full Platform (Category-only)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* (same styles as before; trimmed for brevity in this snippet) */
    :root{ --glass: rgba(255,255,255,0.06); --muted: rgba(255,255,255,0.78); --accent:#10b981; }
    body{ font-family: 'Segoe UI', "Noto Sans Bengali", sans-serif; margin:0; min-height:100vh; background: radial-gradient(circle at 12% 12%, rgba(255,214,102,0.07) 0%, transparent 18%), radial-gradient(circle at 10% 10%, #1e3c72 0%, #2a5298 60%, #0f172a 100%); color:#fff; }
    .card{ background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border-radius:12px; padding:16px; border:1px solid rgba(255,255,255,0.06); }
    /* rest of styles kept similar to original file */
  </style>
</head>
<body>
  <header class="sticky-top card" role="banner">
    <div style="display:flex; align-items:center; gap:12px;">
      <h1>Target Zone</h1>
      <div class="muted" style="font-weight:600;">‚Äî Mock tests & analytics</div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <div id="auth-ui" role="button" aria-pressed="false" tabindex="0" title="‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®"></div>
    </div>
  </header>

  <main class="p-6">
    <!-- DASHBOARD -->
    <section id="dashboard" class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <div>
          <h2 style="font-size:1.25rem; margin:0; font-weight:800;">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</h2>
          <p class="muted" style="margin-top:6px;">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡ßü‡ßá ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶® ‚Äî Start ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®</p>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <div id="profile-card-dashboard" class="card card-bordered border-teal" role="button" tabindex="0" aria-pressed="false" style="display:flex; gap:12px; align-items:center; cursor:pointer;">
          <div style="width:64px;height:64px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); display:flex; align-items:center; justify-content:center; font-weight:800; font-size:1.2rem; border:1px solid rgba(255,255,255,0.06);">
            <span id="dash-profile-initial">U</span>
          </div>
          <div class="meta">
            <div class="name" id="dash-profile-name">Guest</div>
            <div class="sub" id="dash-profile-sub">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‚Ä¢ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶ì ‡¶≤‡¶ø‡¶°‡¶æ‡¶∞‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶∏‡¶π</div>
          </div>
        </div>
      </div>

      <div id="exam-cards" class="mt-4">
        <!-- injected by JS -->
      </div>
    </section>

    <!-- QUIZ AREA -->
    <section id="quiz-section" class="hidden card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="back-to-dashboard" class="bg-white/6 px-2 py-1 rounded">‚Üê Back</button>
          <div>
            <h3 id="quiz-title" style="margin:0; font-weight:800;">Mock Test</h3>
            <div id="exam-tag" class="muted" style="font-size:0.95rem;">‚Äî</div>
          </div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="tts-toggle" class="bg-white/6 px-2 py-1 rounded">üîä Play Voice</button>
          <div id="timer" class="muted" style="background:rgba(255,255,255,0.04); padding:6px 10px; border-radius:8px;">80:00</div>
        </div>
      </div>

      <div id="question-card" class="mt-4">
        <p id="question-text">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
        <div id="difficulty-tag" class="muted" style="font-size:0.95rem;">Difficulty: -</div>

        <ul id="options-list" class="mt-4"></ul>

        <div class="controls-row" style="margin-top:14px; align-items:center;">
          <div class="controls-left">
            <button id="prev-btn" class="bg-white/6 px-3 py-1 rounded">‚¨Ö ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ</button>
            <button id="mark-review-btn" class="bg-yellow-500 px-3 py-1 rounded text-white">üîñ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï</button>
            <button id="next-btn" class="bg-white/6 px-3 py-1 rounded">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‚û°</button>
          </div>

          <div style="flex:1; margin-left:12px;">
            <div style="width:100%; background:rgba(255,255,255,0.06); height:10px; border-radius:8px; overflow:hidden;">
              <div id="progress-bar" style="width:0%; height:100%; background:var(--accent);"></div>
            </div>
          </div>
        </div>

        <div id="palette" class="mt-4"></div>

        <div id="submit-fixed" style="margin-top:14px;">
          <button id="submit-btn">‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</button>
        </div>
      </div>
    </section>

    <!-- RESULT / ANALYSIS -->
    <section id="result-section" class="hidden card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-weight:800;">Result</h3>
        <div>
          <button id="close-result" class="bg-white/6 px-2 py-1 rounded">Close</button>
        </div>
      </div>

      <div class="stat-row" id="result-stats"></div>
      <div style="margin-top:12px; display:flex; gap:16px; flex-wrap:wrap; align-items:center;">
        <div style="flex:1; min-width:240px;">
          <canvas id="result-pie" style="max-width:480px;"></canvas>
        </div>
        <div id="result-note" class="muted" style="flex-basis:240px;">‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü‡ßá ‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®, Attempted, Unattempted, Correct ‡¶ì Wrong ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá‡•§</div>
      </div>
    </section>

    <!-- PROFILE / HISTORY -->
    <section id="profile-section" class="hidden card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-weight:800;">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶ì ‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßç‡¶∞‡¶æ</h3>
        <div>
          <button id="logout-btn" class="bg-red-500 px-3 py-1 rounded text-white">Logout</button>
        </div>
      </div>
      <div class="profile-area">
        <div>
          <div class="profile-card" style="display:flex; gap:12px; align-items:center;">
            <div style="width:72px;height:72px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); display:flex; align-items:center; justify-content:center; font-weight:800; font-size:1.2rem; border:1px solid rgba(255,255,255,0.06);">
              <span id="profile-initial">U</span>
            </div>
            <div style="flex:1;">
              <div id="profile-name" style="font-weight:800; font-size:1.05rem;">User</div>
              <div id="profile-email" class="muted" style="font-size:0.95rem; margin-top:4px;"></div>
              <div style="margin-top:10px;">
                <button id="edit-name-btn" class="bg-white/6 px-3 py-1 rounded">Name ‡¶¨‡¶¶‡¶≤‡¶æ‡¶®</button>
              </div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <h4 style="margin:6px 0 8px 0; font-weight:800;">Past Attempts</h4>
            <div id="past-attempts" style="display:flex; flex-direction:column; gap:8px;"></div>
          </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:12px;">
          <div class="small-card">
            <div style="font-weight:700; font-size:0.95rem;">User Summary</div>
            <div id="user-summary" class="muted" style="margin-top:8px;">‚Äî</div>
          </div>
          <div class="small-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div style="font-weight:700;">Leaderboard</div>
              <select id="leaderboard-exam" class="bg-white/6 px-2 py-1 rounded"></select>
            </div>
            <ul id="leaderboard-list" style="margin-top:12px; list-style:none; padding:0;"></ul>
          </div>
        </div>
      </div>
    </section>

  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCR5rqthBh0vX0yLOcOG3b9xJiKbYtzdxU",
      authDomain: "target-zone-8fffd.firebaseapp.com",
      projectId: "target-zone-8fffd",
      storageBucket: "target-zone-8fffd.appspot.com",
      messagingSenderId: "667579216123",
      appId: "1:667579216123:web:37bb1fcc724743073d005e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // categories (these are collection names)
    const exams = [
      {id:"ssc", name:"SSC Exams", desc:"CGL, CHSL, GD, MTS", icon:"üìö"},
      {id:"railways", name:"Railways", desc:"NTPC, Group-D, JE", icon:"üöÜ"},
      {id:"tet", name:"TET Exams", desc:"Primary & Upper Primary", icon:"üè´"},
      {id:"wbset", name:"WB SET", desc:"Paper I & II", icon:"üéì"},
      {id:"wbjee", name:"WBJEE", desc:"Engineering & Medical", icon:"üß™"},
      {id:"madhyamik", name:"Madhyamik / HS", desc:"Board MCQ Practice", icon:"üìù"}
    ];

    const examCards = document.getElementById("exam-cards");
    const dashboard = document.getElementById("dashboard");
    const quizSection = document.getElementById("quiz-section");
    const resultSection = document.getElementById("result-section");
    const profileSection = document.getElementById("profile-section");
    const authUi = document.getElementById("auth-ui");

    function renderExamCards(){
      examCards.innerHTML = exams.map((ex,i) => `
        <div class="card" style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center; padding:12px;">
          <div>
            <div style="font-weight:800;">${ex.icon} ${ex.name}</div>
            <div class="muted" style="font-size:0.95rem;">${ex.desc}</div>
          </div>
          <div>
            <button class="start-btn" data-id="${ex.id}" style="background:#2563eb;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;">Start</button>
          </div>
        </div>
      `).join("");
    }
    renderExamCards();

    // click listener for Start buttons
    examCards.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('.start-btn');
      if (!btn) return;
      const catId = btn.dataset.id;
      if (!catId) return;
      await startExam(catId);
    });

    // app state
    let currentExam = null, questions = [], currentIndex = 0;
    let answers = {}, reviewed = {}, timeLeft = 80*60, timerInterval = null;
    let currentUser = null, pieChartInstance = null, ttsEnabled = false;

    onAuthStateChanged(auth, user => {
      currentUser = user;
      renderAuthUI();
      if (user) loadUserHistory();
    });

    function renderAuthUI(){
      authUi.innerHTML = '';
      if (!currentUser) {
        authUi.innerHTML = `<div style="display:flex; flex-direction:column; align-items:flex-end;"><div class="greet">Sign In</div><div class="greet-sub">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</div></div>`;
        authUi.onclick = showSignIn;
      } else {
        const display = currentUser.displayName || (currentUser.email ? currentUser.email.split('@')[0] : 'User');
        authUi.innerHTML = `
          <div style="display:flex; gap:8px; align-items:center;">
            <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); display:flex; align-items:center; justify-content:center; font-weight:800; font-size:1rem; border:1px solid rgba(255,255,255,0.06);">
              <span id="header-initial">${(display[0]||'U').toUpperCase()}</span>
            </div>
            <div style="display:flex; flex-direction:column; align-items:flex-start;">
              <div class="greet">Hi, ${display}</div>
              <div class="greet-sub">${currentUser.email || ''}</div>
            </div>
          </div>
        `;
        authUi.onclick = ()=> showSection('profile');
      }
    }

    function showSignIn(){
      const email = prompt("Email:");
      const pass = prompt("Password:");
      if (!email || !pass) return alert("Invalid");
      signInWithEmailAndPassword(auth,email,pass).then(()=>alert("Signed in")).catch(e=>alert(e.message));
    }

    function showSection(name){
      dashboard.classList.toggle('hidden', name !== 'dashboard');
      quizSection.classList.toggle('hidden', name !== 'quiz');
      resultSection.classList.toggle('hidden', name !== 'result');
      profileSection.classList.toggle('hidden', name !== 'profile');
    }

    async function startExam(examId){
      currentExam = examId;
      questions = [];
      try {
        console.log("Loading questions from collection:", examId);
        // try to order by id if exists, otherwise just get
        let q;
        try {
          q = query(collection(db, examId), orderBy('id'));
        } catch(e) {
          q = query(collection(db, examId));
        }
        const snap = await getDocs(q);
        if (snap.empty) {
          alert(`‡¶è‡¶á ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶§‡ßá ‡¶ï‡ßã‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡ßá‡¶á: ${examId}`);
          return;
        }
        questions = snap.docs.map(d => d.data());
      } catch(e){
        console.error("Error loading questions:", e);
        alert("‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ ‡¶ï‡¶®‡¶∏‡ßã‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§");
        return;
      }

      // start UI
      dashboard.classList.add('hidden');
      quizSection.classList.remove('hidden');
      document.getElementById('quiz-title').textContent = examId;
      document.getElementById('exam-tag').textContent = examId.toUpperCase();

      answers = {}; reviewed = {}; currentIndex = 0;
      timeLeft = (questions.length * 60) || 80*60;
      renderQuestion();
      buildPalette();
      startTimer();
    }

    function renderQuestion(){
      const q = questions[currentIndex] || { question: 'No question', options:[] };
      document.getElementById('question-text').textContent = `Q${currentIndex+1}: ${q.question || ''}`;
      document.getElementById('difficulty-tag').textContent = `Difficulty: ${q.difficulty || 'N/A'}`;

      const ol = document.getElementById('options-list');
      ol.innerHTML = '';
      (q.options || []).forEach((opt, idx)=>{
        const li = document.createElement('li');
        li.setAttribute('data-opt', opt);
        li.setAttribute('role','button');
        li.setAttribute('tabindex','0');

        const input = document.createElement('input');
        input.type='radio'; input.name='option'; input.value=opt;
        input.checked = (answers[currentIndex] === opt);

        input.onchange = () => {
          answers[currentIndex] = opt;
          if (auth.currentUser) {
            try {
              localStorage.setItem(`${currentExam}_answers_${auth.currentUser.uid}`, JSON.stringify(answers));
              localStorage.setItem(`${currentExam}_review_${auth.currentUser.uid}`, JSON.stringify(reviewed));
            } catch(e){}
          }
          updatePalette(); updateProgress();
        };

        const spanText = document.createElement('span');
        spanText.className = 'opt-text';
        spanText.textContent = opt;

        li.appendChild(input);
        li.appendChild(spanText);

        li.addEventListener('click', (e)=>{
          input.checked = true;
          input.dispatchEvent(new Event('change', { bubbles: true }));
        });

        ol.appendChild(li);
      });
      updatePalette(); updateProgress();
      if (ttsEnabled) speakQuestion(questions[currentIndex]);
    }

    document.getElementById('back-to-dashboard').onclick = ()=> { showSection('dashboard'); };

    document.getElementById('prev-btn').onclick = ()=>{ if(currentIndex>0){ currentIndex--; renderQuestion(); } };
    document.getElementById('next-btn').onclick = ()=>{ if(currentIndex<questions.length-1){ currentIndex++; renderQuestion(); } };
    document.getElementById('mark-review-btn').onclick = ()=>{ reviewed[currentIndex]=true; if (auth.currentUser) localStorage.setItem(`${currentExam}_review_${auth.currentUser.uid}`, JSON.stringify(reviewed)); updatePalette(); };

    function buildPalette(){
      const pal = document.getElementById('palette');
      pal.innerHTML = '';
      for(let i=0;i<questions.length;i++){
        const b = document.createElement('button');
        b.className = 'palette-btn';
        b.style.minWidth='44px';
        b.style.minHeight='44px';
        b.style.borderRadius='8px';
        b.style.background = '#d1d5db';
        b.style.color='#0f172a';
        b.title = `Question ${i+1}`;
        b.innerText = `${i+1}`;
        b.onclick = ()=>{ currentIndex = i; renderQuestion(); };
        pal.appendChild(b);
      }
      updatePalette();
    }
    function updatePalette(){
      const children = [...document.getElementById('palette').children];
      children.forEach((btn,i)=>{
        btn.style.background = '#d1d5db'; btn.innerText = `${i+1}`;
        if (answers[i]) { btn.style.background = '#10b981'; btn.innerText = `${i+1} ‚úî`; }
        if (reviewed[i]) { btn.style.background = '#f59e0b'; btn.innerText = `${i+1} ‚öë`; }
      });
    }
    function updateProgress(){
      const attempted = Object.keys(answers).filter(k=>answers[k]).length;
      const percent = Math.round((attempted / questions.length)*100) || 0;
      document.getElementById('progress-bar').style.width = percent + '%';
    }

    function startTimer(){
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(()=>{
        if (timeLeft<=0){ clearInterval(timerInterval); submitExam(); return; }
        timeLeft--;
        const m = Math.floor(timeLeft/60), s = timeLeft%60;
        document.getElementById('timer').textContent = `${m}:${String(s).padStart(2,'0')}`;
      },1000);
    }

    document.getElementById('submit-btn').onclick = ()=> {
      if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) return;
      submitExam();
    };

    async function submitExam(){
      if (!auth.currentUser) { alert("Please sign in"); return; }
      let correct=0, wrong=0, unattempted=0, attempted=0;
      const topicMap = {};
      for(let i=0;i<questions.length;i++){
        const q = questions[i] || {};
        const given = answers[i];
        const norm = v => (typeof v === 'string' ? v.trim() : v);
        if (!given) { unattempted++; }
        else {
          attempted++;
          let isCorrect = false;
          if (norm(given) === norm(q.answer)) isCorrect = true;
          else {
            if (Array.isArray(q.options)) {
              const optIdxGiven = q.options.findIndex(o => norm(o) === norm(given));
              const optIdxAnswer = q.options.findIndex(o => norm(o) === norm(q.answer));
              if (optIdxGiven !== -1 && optIdxAnswer !== -1 && optIdxGiven === optIdxAnswer) isCorrect = true;
            }
          }
          if (isCorrect) correct++;
          else { wrong++; const t = q.topic || 'General'; topicMap[t] = (topicMap[t]||0)+1; }
        }
      }
      const total = questions.length || 0;
      const percent = total ? Math.round((correct/total)*100) : 0;

      try {
        await addDoc(collection(db,'results'), {
          uid: auth.currentUser.uid,
          email: auth.currentUser.email,
          displayName: auth.currentUser.displayName || null,
          exam: currentExam,
          score: correct,
          total,
          correct, wrong, unattempted,
          topicMap,
          submittedAt: new Date()
        });
      } catch(e){
        console.warn("Firestore save failed:", e.message);
      }

      try {
        localStorage.removeItem(`${currentExam}_answers_${auth.currentUser.uid}`);
        localStorage.removeItem(`${currentExam}_review_${auth.currentUser.uid}`);
      } catch(e){}

      clearInterval(timerInterval);
      showResultChart({correct, wrong, unattempted, attempted, total, percent});
    }

    function showResultChart(data){
      quizSection.classList.add('hidden');
      resultSection.classList.remove('hidden');
      const holder = document.getElementById('result-stats');
      holder.innerHTML = '';
      function statHtml(label, num){
        const div = document.createElement('div');
        div.className = 'stat';
        div.innerHTML = `<div class="num">${num}</div><div class="label">${label}</div>`;
        return div;
      }
      holder.appendChild(statHtml('Correct', data.correct));
      holder.appendChild(statHtml('Wrong', data.wrong));
      holder.appendChild(statHtml('Unattempted', data.unattempted));
      holder.appendChild(statHtml('Total', data.total));
      const ctx = document.getElementById('result-pie').getContext('2d');
      if (pieChartInstance) pieChartInstance.destroy();
      pieChartInstance = new Chart(ctx, {
        type: 'pie',
        data: { labels: ['Correct','Wrong','Unattempted'], datasets:[{data:[data.correct,data.wrong,data.unattempted]}] }
      });
    }

    // helpers: loadUserHistory, updateProfilePanel left minimal for brevity.
  </script>
</body>
</html>
