<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <title>Target Zone Mock Tests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: radial-gradient(#1e3c72, #2a5298);
      font-family: 'Segoe UI', sans-serif;
      color: white;
      transition: background 0.5s, color 0.5s;
    }
    body.light-mode {
      background: #f9fafb;
      color: #111827;
    }
    #stars, #planes {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 0;
      pointer-events: none;
    }
    .floating-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    #quiz-container input[type="radio"] {
      margin-right: 8px;
    }
    /* Question fade-in animation */
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* Palette button colors */
    .palette-btn {
      border-radius: 6px;
      padding: 4px 6px;
      font-size: 0.8rem;
    }
    .attempted { background: #10b981; color: white; }
    .review { background: #f59e0b; color: white; }
    .unattempted { background: #d1d5db; color: black; }
    /* Sticky header */
    #sticky-header {
      position: sticky;
      top: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      z-index: 20;
      padding: 8px;
    }
  </style>
</head>
<body class="relative min-h-screen overflow-x-hidden overflow-y-auto">
  <canvas id="stars"></canvas>
  <canvas id="planes"></canvas>

  <!-- Dashboard -->
  <div id="dashboard" class="relative z-10 text-center py-10 px-4">
    <h1 class="text-4xl font-extrabold mb-4 text-white">Target Zone Mock Tests</h1>
    <p class="mb-6 text-gray-200">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡ßã‡¶® ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®:</p>
    <div id="exam-cards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 px-6 max-w-6xl mx-auto pb-24"></div>
  </div>

  <!-- Quiz Container -->
  <div id="quiz-container" class="hidden max-w-4xl mx-auto bg-white rounded-lg shadow p-6 relative z-10 text-gray-800">
    <!-- Sticky Header -->
    <div id="sticky-header" class="flex justify-between items-center">
      <button id="dark-mode-toggle" class="bg-gray-700 text-white px-3 py-1 rounded">üåó Mode</button>
      <span id="timer" class="bg-blue-700 text-white px-4 py-1 rounded text-lg font-semibold">80:00</span>
      <div class="flex-1 mx-4">
        <div class="w-full bg-gray-300 h-2 rounded">
          <div id="progress-bar" class="bg-green-500 h-2 rounded" style="width: 0%;"></div>
        </div>
        <p id="progress-text" class="text-sm text-center text-white mt-1">0% ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£</p>
      </div>
    </div>

    <h2 id="quiz-header" class="text-2xl font-bold text-center mb-6">Mock Test</h2>
    <div class="mb-6 fade-in" id="question-area">
      <p id="question-text" class="text-lg font-semibold">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® 1: ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
      <ul id="options-list" class="space-y-3 mt-4"></ul>
    </div>
    <div class="flex justify-center gap-4 mb-6">
      <button id="mark-review-btn" class="bg-yellow-500 text-white px-4 py-2 rounded shadow">üîñ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶ï‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡ßã</button>
      <button id="prev-btn" class="bg-gray-600 text-white px-4 py-2 rounded shadow">‚¨Ö ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ</button>
      <button id="next-btn" class="bg-blue-600 text-white px-4 py-2 rounded shadow">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‚û°</button>
    </div>
    <div id="palette" class="grid grid-cols-8 sm:grid-cols-10 gap-2 justify-center mb-6"></div>
    <div class="flex justify-center mb-6">
      <button id="submit-btn" class="bg-red-600 text-white px-6 py-2 rounded shadow">üì§ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶ü‡¶ø ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-gradient-to-r from-indigo-600 to-purple-600 py-3 text-center text-white text-sm fixed bottom-0 w-full z-10 shadow-lg">
    üìå ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‚Äî SSC | Railways | TET | WB SET | WBJEE | Madhyamik ‚Äî ‡¶∏‡¶¨ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶è‡¶ï ‡¶ú‡¶æ‡¶Ø‡¶º‡¶ó‡¶æ‡¶Ø‡¶º
  </footer>

  <!-- ‚úÖ Result Modal -->
  <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white text-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full text-center">
      <h2 class="text-2xl font-bold mb-4 text-green-600">üìä ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</h2>
      <canvas id="result-chart" class="mb-4"></canvas>
      <div id="result-text" class="text-md font-semibold space-y-1 mb-4"></div>
      <h3 class="text-lg font-bold mb-2">üèÜ Leaderboard</h3>
      <ul id="leaderboard" class="mb-4 text-sm"></ul>
      <button id="close-modal-btn" class="bg-blue-600 text-white px-4 py-2 rounded shadow">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCR5rqthBh0vX0yLOcOG3b9xJiKbYtzdxU",
      authDomain: "target-zone-8fffd.firebaseapp.com",
      projectId: "target-zone-8fffd",
      storageBucket: "target-zone-8fffd.appspot.com",
      messagingSenderId: "667579216123",
      appId: "1:667579216123:web:37bb1fcc724743073d005e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const exams = [
      {id:"ssc", name:"SSC Exams", desc:"CGL, CHSL, GD, MTS"},
      {id:"railways", name:"Railways", desc:"NTPC, Group-D, JE"},
      {id:"tet", name:"TET Exams", desc:"Primary & Upper Primary"},
      {id:"wbset", name:"WB SET", desc:"Paper I & II"},
      {id:"wbjee", name:"WBJEE", desc:"Engineering & Medical"},
      {id:"madhyamik", name:"Madhyamik / HS", desc:"Board MCQ Practice"}
    ];

    const dashboard = document.getElementById("dashboard");
    const quizContainer = document.getElementById("quiz-container");
    const examCards = document.getElementById("exam-cards");

    examCards.innerHTML = exams.map(ex => `
      <div class="bg-white text-gray-800 rounded-lg shadow-lg p-5 cursor-pointer transform transition-transform duration-300 hover:scale-105 hover:bg-indigo-100 floating-btn"
           onclick="startExam('${ex.id}', '${ex.name}')">
        <h2 class="text-xl font-bold">${ex.name}</h2>
        <p class="text-sm mt-2 text-gray-600">${ex.desc}</p>
      </div>
    `).join("");

    let currentExam = "", questions = [], currentQuestion = 0, answers = {}, reviewed = {}, timeLeft = 80*60;

    // üåó Dark Mode Toggle
    document.getElementById("dark-mode-toggle").onclick = () => {
      document.body.classList.toggle("light-mode");
    };

    window.startExam = async function(examId, examName) {
      currentExam = examId;
      dashboard.classList.add("hidden");
      quizContainer.classList.remove("hidden");
      document.getElementById("quiz-header").textContent = examName + " Mock Test";
      await loadQuestions();
    }

    async function loadQuestions() {
      const q = query(collection(db, currentExam), orderBy("id"));
      const snapshot = await getDocs(q);
      questions = snapshot.docs.map(doc => doc.data());
      answers = JSON.parse(localStorage.getItem(currentExam + "_answers") || "{}");
      reviewed = JSON.parse(localStorage.getItem(currentExam + "_review") || "{}");
      buildPalette();
      showQuestion();
      startTimer();
    }

    function buildPalette() {
      const palette = document.getElementById("palette");
      palette.innerHTML = "";
      for (let i = 0; i < questions.length; i++) {
        const btn = document.createElement("button");
        btn.textContent = i + 1;
        btn.className = "palette-btn unattempted";
        btn.onclick = () => { currentQuestion = i; showQuestion(); };
        palette.appendChild(btn);
      }
      updatePalette();
    }

    function showQuestion() {
      const q = questions[currentQuestion];
      const questionArea = document.getElementById("question-area");
      questionArea.classList.remove("fade-in");
      void questionArea.offsetWidth;
      questionArea.classList.add("fade-in");

      document.getElementById("question-text").textContent = `‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${currentQuestion + 1}: ${q.question}`;
      const optionsList = document.getElementById("options-list");
      optionsList.innerHTML = "";
      q.options.forEach(option => {
        const li = document.createElement("li");
        li.classList.add("p-2", "rounded", "border", "cursor-pointer", "hover:bg-gray-100");
        const input = document.createElement("input");
        input.type = "radio";
        input.name = "option";
        input.value = option;
        if (answers[currentQuestion] === option) input.checked = true;
        input.addEventListener("change", () => {
          answers[currentQuestion] = option;
          localStorage.setItem(currentExam + "_answers", JSON.stringify(answers));
          updatePalette();
          updateProgress();
        });
        li.appendChild(input);
        li.append(option);
        optionsList.appendChild(li);
      });
      updatePalette();
      updateProgress();
    }

    function updatePalette() {
      [...document.getElementById("palette").children].forEach((btn, i) => {
        btn.className = "palette-btn unattempted";
        if (answers[i]) btn.classList.add("attempted");
        if (reviewed[i]) btn.classList.add("review");
      });
    }

    function updateProgress() {
      const attempted = Object.keys(answers).length;
      const percent = Math.round((attempted / questions.length) * 100);
      document.getElementById("progress-bar").style.width = percent + "%";
      document.getElementById("progress-text").textContent = `${percent}% ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£`;
    }

    function startTimer() {
      setInterval(() => {
        if (timeLeft <= 0) return;
        timeLeft--;
        const min = Math.floor(timeLeft / 60);
        const sec = timeLeft % 60;
        document.getElementById("timer").textContent = `${min}:${sec.toString().padStart(2, "0")}`;
      }, 1000);
    }

    document.getElementById("prev-btn").onclick = () => {
      if (currentQuestion > 0) currentQuestion--;
      showQuestion();
    };
    document.getElementById("next-btn").onclick = () => {
      if (currentQuestion < questions.length - 1) currentQuestion++;
      showQuestion();
    };
    document.getElementById("mark-review-btn").onclick = () => {
      reviewed[currentQuestion] = true;
      localStorage.setItem(currentExam + "_review", JSON.stringify(reviewed));
      updatePalette();
    };

    // ‚úÖ Submit with Result Visualization & Leaderboard
    document.getElementById("submit-btn").onclick = async () => {
      const confirmSubmit = confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®?");
      if (!confirmSubmit) return;

      let correct = 0;
      let wrong = 0;
      let unattempted = 0;

      questions.forEach((q, i) => {
        if (answers[i] === undefined) {
          unattempted++;
        } else if (answers[i] === q.answer) {
          correct++;
        } else {
          wrong++;
        }
      });

      const total = questions.length;
      const percentage = Math.round((correct / total) * 100);

      await addDoc(collection(db, "results"), {
        exam: currentExam,
        score: correct,
        total,
        correct,
        wrong,
        unattempted,
        submittedAt: new Date()
      });

      // Chart.js Pie Chart
      new Chart(document.getElementById("result-chart"), {
        type: "pie",
        data: {
          labels: ["‡¶∏‡¶†‡¶ø‡¶ï", "‡¶≠‡ßÅ‡¶≤", "‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶®‡¶æ‡¶á"],
          datasets: [{
            data: [correct, wrong, unattempted],
            backgroundColor: ["#10b981", "#ef4444", "#9ca3af"]
          }]
        }
      });

      const resultText = document.getElementById("result-text");
      resultText.innerHTML = `
        <p>‚úÖ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞: ${correct}‡¶ü‡¶ø</p>
        <p>‚ùå ‡¶≠‡ßÅ‡¶≤ ‡¶â‡¶§‡ßç‡¶§‡¶∞: ${wrong}‡¶ü‡¶ø</p>
        <p>‚ö™ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡¶®‡¶ø: ${unattempted}‡¶ü‡¶ø</p>
        <p>üìä ‡¶Æ‡ßã‡¶ü ‡¶∏‡ßç‡¶ï‡ßã‡¶∞: ${percentage}%</p>
      `;

      // Leaderboard fetch
      const lbSnapshot = await getDocs(query(collection(db, "results"), orderBy("score", "desc")));
      const lbList = document.getElementById("leaderboard");
      lbList.innerHTML = "";
      lbSnapshot.forEach(doc => {
        const data = doc.data();
        lbList.innerHTML += `<li>${data.exam.toUpperCase()} - ${data.score}/${data.total}</li>`;
      });

      document.getElementById("result-modal").classList.remove("hidden");
    };

    document.getElementById("close-modal-btn").onclick = () => {
      document.getElementById("result-modal").classList.add("hidden");
      localStorage.removeItem(currentExam + "_answers");
      localStorage.removeItem(currentExam + "_review");
      window.location.reload();
    };

    // Background animation (same as before)
    const starsCanvas = document.getElementById("stars");
    const planesCanvas = document.getElementById("planes");
    const starsCtx = starsCanvas.getContext("2d");
    const planesCtx = planesCanvas.getContext("2d");
    starsCanvas.width = planesCanvas.width = window.innerWidth;
    starsCanvas.height = planesCanvas.height = window.innerHeight;
    let stars = [], planes = [];
    for (let i = 0; i < 120; i++) {
      stars.push({ x: Math.random()*starsCanvas.width, y: Math.random()*starsCanvas.height, r: Math.random()*2 });
    }
    for (let i = 0; i < 2; i++) {
      planes.push({ x: -50, y: Math.random()*starsCanvas.height/2, dx: 2+Math.random()*2 });
    }
    function drawBackground() {
      starsCtx.clearRect(0,0,starsCanvas.width,starsCanvas.height);
      starsCtx.fillStyle = "white";
      stars.forEach(s => {
        starsCtx.beginPath();
        starsCtx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
        starsCtx.fill();
      });
      planesCtx.clearRect(0,0,planesCanvas.width,planesCanvas.height);
      planes.forEach(p => {
        planesCtx.fillStyle = "lightblue";
        planesCtx.fillRect(p.x, p.y, 40, 3);
        p.x += p.dx;
        if (p.x > planesCanvas.width + 100) {
          p.x = -50;
          p.y = Math.random()*planesCanvas.height/2;
        }
      });
    }
    setInterval(drawBackground, 30);
  </script>
</body>
</html>
