<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Target Zone - Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(135deg,#071A52,#09203F); color:#fff; font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .container { max-width:1100px; margin:24px auto; padding:20px; }
    .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); padding:16px; border-radius:12px; margin-bottom:16px; }
    .muted { color: rgba(255,255,255,0.6); }
    .exam-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:16px; }
    .exam-card { padding:16px; border-radius:10px; position:relative; overflow:hidden; }
    .start-btn, .view-subcats { background:#10b981; color:#fff; padding:8px 10px; border-radius:8px; border:none; cursor:pointer; }
    .start-btn:disabled { opacity:0.6; cursor:not-allowed; }
    #quiz-section { display:none; }
    #dashboard { display:block; }
    #options-list li { list-style:none; margin-bottom:8px; padding:8px; border-radius:8px; background: rgba(255,255,255,0.03); cursor:pointer; }
    #options-list li.selected { outline: 2px solid #60a5fa; background: rgba(96,165,250,0.08); }
    .palette { display:flex; gap:6px; flex-wrap:wrap; margin-top:10px; }
    .pal-item { width:28px; height:28px; border-radius:6px; display:flex;align-items:center;justify-content:center;font-size:12px;color:#000; cursor:pointer; }
    .progress-bar { height:10px; background: rgba(255,255,255,0.06); border-radius:6px; overflow:hidden; }
    .progress { height:100%; background:linear-gradient(90deg,#60a5fa,#a78bfa); width:0%; }
    .top-controls { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
    .small-btn { background:rgba(255,255,255,0.05); padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); color:#fff; cursor:pointer; }
    .timer { font-weight:700; }
    /* responsive */
    @media (max-width:640px){ .top-controls{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <div class="container">
    <header class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1 style="margin:0; font-size:1.4rem;">🎯 Target Zone — Quiz</h1>
        <div>
          <span id="user-email" class="muted">Not signed in</span>
          <button id="sign-btn" class="small-btn">Sign In</button>
        </div>
      </div>
      <p class="muted" style="margin-top:8px;">Choose a category, then a subcategory, then press Start to begin practice MCQs.</p>
    </header>

    <!-- Dashboard / Categories -->
    <div id="dashboard">
      <section class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2 style="margin:0">Categories</h2>
          <div class="muted">Auto-loaded from Firestore</div>
        </div>
        <div id="examCards" class="exam-grid" style="margin-top:12px;"></div>
      </section>

      <section class="card" id="subcat-list-section" style="display:none;">
        <h3 style="margin:0 0 8px 0;">Subcategories for <span id="subcat-for"></span></h3>
        <div id="subcatCards" class="exam-grid"></div>
      </section>
    </div>

    <!-- Quiz Section -->
    <section id="quiz-section" class="card">
      <div class="top-controls">
        <div>
          <h3 id="quiz-title" style="margin:0">Exam</h3>
          <div class="muted" id="exam-tag">TAG</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <div class="muted">Time left: <span id="timer" class="timer">00:00</span></div>
          <button id="end-btn" class="small-btn">End & Submit</button>
          <button id="back-btn" class="small-btn">Back to Categories</button>
        </div>
      </div>

      <div id="question-area">
        <h4 id="question-text">Q1: ...</h4>
        <div class="muted" id="difficulty-tag">Difficulty</div>
        <ol id="options-list" style="padding-left:0; margin-top:12px;"></ol>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px;">
          <div>
            <button id="prev-btn" class="small-btn">Previous</button>
            <button id="next-btn" class="small-btn">Next</button>
            <button id="review-btn" class="small-btn">Mark Review</button>
          </div>
          <div style="width:240px;">
            <div class="progress-bar"><div id="prog" class="progress"></div></div>
            <div style="display:flex; justify-content:space-between; margin-top:6px;">
              <small class="muted" id="progress-text">0 / 0</small>
              <small class="muted" id="answered-count">Answered: 0</small>
            </div>
          </div>
        </div>

        <div class="palette" id="palette"></div>
      </div>
    </section>

    <!-- Result summary modal-like -->
    <div id="result-card" class="card" style="display:none; margin-top:12px;">
      <h3>Result Summary</h3>
      <div id="result-body"></div>
      <div style="margin-top:8px;">
        <button id="close-result" class="small-btn">Close</button>
        <button id="download-result" class="small-btn">Download</button>
      </div>
    </div>
  </div>

  <!-- Firebase + Script -->
  <script type="module">
    // Firebase v9 modular imports (match admin)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // === Firebase config (same as admin) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCR5rqthBh0vX0yLOcOG3b9xJiKbYtzdxU",
      authDomain: "target-zone-8fffd.firebaseapp.com",
      projectId: "target-zone-8fffd",
      storageBucket: "target-zone-8fffd.appspot.com",
      messagingSenderId: "667579216123",
      appId: "1:667579216123:web:37bb1fcc724743073d005e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // DOM refs
    const examCards = document.getElementById('examCards');
    const subcatCards = document.getElementById('subcatCards');
    const subcatSection = document.getElementById('subcat-list-section');
    const subcatFor = document.getElementById('subcat-for');
    const dashboard = document.getElementById('dashboard');
    const quizSection = document.getElementById('quiz-section');
    const questionText = document.getElementById('question-text');
    const difficultyTag = document.getElementById('difficulty-tag');
    const optionsList = document.getElementById('options-list');
    const progBar = document.getElementById('prog');
    const progressText = document.getElementById('progress-text');
    const answeredCountEl = document.getElementById('answered-count');
    const paletteEl = document.getElementById('palette');
    const timerEl = document.getElementById('timer');
    const quizTitle = document.getElementById('quiz-title');
    const examTag = document.getElementById('exam-tag');
    const resultCard = document.getElementById('result-card');
    const resultBody = document.getElementById('result-body');

    // state
    let currentExam = "";
    let questions = [];
    let answers = {};
    let reviewed = {};
    let currentIndex = 0;
    let timeLeft = 0;
    let timerInterval = null;
    let user = null;

    // Auth UI simplified
    const userEmailEl = document.getElementById('user-email');
    const signBtn = document.getElementById('sign-btn');
    signBtn.addEventListener('click', async () => {
      if (user) {
        // no sign-out flow here (kept simple)
        alert('Already signed in as ' + (user.email||''));
        return;
      }
      try {
        await signInWithPopup(auth, provider);
      } catch(e){ console.error(e); alert('Sign in failed'); }
    });
    onAuthStateChanged(auth, (u) => {
      user = u;
      if (u) userEmailEl.textContent = u.email;
      else userEmailEl.textContent = 'Not signed in';
    });

    // --------- Load Categories ----------
    async function loadCategories(){
      examCards.innerHTML = `<div class="muted">Loading categories...</div>`;
      try {
        const snap = await getDocs(collection(db, "categories"));
        if (snap.empty) {
          examCards.innerHTML = `<div class="muted">No categories found.</div>`;
          return;
        }
        let html = "";
        let i = 0;
        snap.forEach(docSnap => {
          const cat = docSnap.data();
          // fallback id if doc didn't have id field
          const cid = cat.id || (cat.name ? cat.name.toLowerCase().replace(/\s+/g,"_") : docSnap.id);
          html += `
            <div class="exam-card card" style="border:1px solid rgba(255,255,255,0.04)">
              <h4 style="margin:0 0 6px 0;">${cat.name || cid}</h4>
              <div class="muted" style="margin-bottom:8px;">Main Category</div>
              <div style="display:flex; gap:8px;">
                <button class="view-subcats small-btn" data-id="${cid}">View Subcategories</button>
              </div>
            </div>
          `;
          i++;
        });
        examCards.innerHTML = html;
      } catch (err) {
        console.error('Error loading categories', err);
        examCards.innerHTML = `<div class="muted">Error loading categories</div>`;
      }
    }
    window.loadCategories = loadCategories;
    window.addEventListener('load', loadCategories);

    // --------- Load Subcategories ----------
    async function loadSubcategories(categoryId){
      if(!categoryId) return;
      subcatSection.style.display = 'block';
      subcatFor.textContent = categoryId;
      subcatCards.innerHTML = `<div class="muted">Loading ${categoryId} subcategories...</div>`;
      try {
        const q = query(collection(db, "subcategories"), where("category","==", categoryId));
        const snap = await getDocs(q);
        if (snap.empty) {
          subcatCards.innerHTML = `<div class="muted">No subcategories found for ${categoryId}</div>`;
          return;
        }
        let html = "";
        let i=0;
        snap.forEach(docSnap=>{
          const sub = docSnap.data();
          const sid = sub.id || (sub.name ? sub.name.toLowerCase().replace(/\s+/g,"_") : docSnap.id);
          html += `
            <div class="exam-card card" style="border:1px solid rgba(255,255,255,0.04)">
              <h4 style="margin:0 0 6px 0;">${sub.name || sid}</h4>
              <div class="muted" style="margin-bottom:8px;">${categoryId} Subcategory</div>
              <div style="display:flex; gap:8px;">
                <button class="start-btn" data-id="${sid}">Start</button>
                <button class="small-btn view-questions" data-id="${sid}">View Questions</button>
              </div>
            </div>
          `;
          i++;
        });
        subcatCards.innerHTML = html;
        // scroll to subcat
        subcatSection.scrollIntoView({behavior:'smooth'});
      } catch (err) {
        console.error('Error loading subcategories', err);
        subcatCards.innerHTML = `<div class="muted">Error loading subcategories</div>`;
      }
    }
    window.loadSubcategories = loadSubcategories;

    // --------- Event delegation on examCards & subcatCards ----------
    examCards.addEventListener('click', (ev) => {
      const viewBtn = ev.target.closest('.view-subcats');
      if(viewBtn){
        const catId = viewBtn.dataset.id;
        loadSubcategories(catId);
        return;
      }
    });
    subcatCards.addEventListener('click', async (ev) => {
      const startBtn = ev.target.closest('.start-btn');
      if(startBtn){
        if (!auth.currentUser) {
          if(!confirm('You need to sign in to track results. Continue as guest?')) return;
        }
        const examId = startBtn.dataset.id;
        await startExam(examId);
        return;
      }
      const viewQ = ev.target.closest('.view-questions');
      if(viewQ){
        const sid = viewQ.dataset.id;
        // quick preview: open subcategory question count
        try {
          const qSnap = await getDocs(collection(db, sid));
          alert(`Questions in ${sid}: ${qSnap.size}`);
        } catch(e){ console.error(e); alert('Failed to fetch questions'); }
      }
    });

    // --------- startExam (FULL) ----------
    async function startExam(examId){
      currentExam = examId;
      questions = [];

      try {
        console.log("▶ Trying to load from collection:", examId);

        let q;
        try {
          // চেষ্টা করবে id অনুযায়ী সাজাতে
          q = query(collection(db, examId), orderBy('id'));
        } catch (err) {
          console.warn("⚠️ orderBy('id') ফেল করেছে, তাই orderBy ছাড়া লোড করা হবে", err);
          q = query(collection(db, examId));
        }

        const snap = await getDocs(q);

        if (snap.empty) {
          alert(`No questions found in subcategory: ${examId}`);
          return;
        }

        // include document-id also
        questions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        console.log("✅ Loaded questions:", questions.length);

      } catch(e){
        console.error("❌ Error loading questions:", e);
        alert("Error loading questions. Check console for details.");
        return;
      }

      // UI হ্যান্ডলিং
      dashboard.style.display = 'none';
      quizSection.style.display = 'block';
      quizTitle.textContent = examId;
      examTag.textContent = examId.toUpperCase();

      // reset state
      answers = {};
      reviewed = {};
      currentIndex = 0;
      timeLeft = (questions.length * 60) || (20*60);
      clearInterval(timerInterval);

      renderQuestion();
      buildPalette();
      updateProgress();
      startTimer();

      try { history.pushState({section:'quiz'}, ''); } catch(e){}
    }
    window.startExam = startExam;

    // --------- renderQuestion (FULL) ----------
    function renderQuestion(){
      const q = questions[currentIndex] || { question: 'No question', options: [] };

      questionText.textContent = `Q${currentIndex+1}: ${q.question || 'No question text'}`;
      difficultyTag.textContent = `Difficulty: ${q.difficulty || 'N/A'} • Topic: ${q.topic || 'General'}`;

      // Options
      optionsList.innerHTML = '';
      (q.options || []).forEach((opt, idx)=>{
        const li = document.createElement('li');
        li.setAttribute('data-opt', opt);
        li.setAttribute('role','button');
        li.tabIndex = 0;

        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'option';
        radio.value = opt;
        radio.style.marginRight = '8px';
        radio.checked = (answers[currentIndex] === opt);

        radio.addEventListener('change', ()=>{
          answers[currentIndex] = opt;
          updatePalette();
          updateProgress();
          // try persist to localstorage
          try {
            if (auth.currentUser) {
              localStorage.setItem(`${currentExam}_answers_${auth.currentUser.uid}`, JSON.stringify(answers));
            }
          } catch(e){}
        });

        li.appendChild(radio);
        const span = document.createElement('span');
        span.textContent = opt;
        li.appendChild(span);

        // click whole li to check radio
        li.addEventListener('click', (ev)=>{
          const r = li.querySelector('input[type=radio]');
          if (r) { r.checked = true; r.dispatchEvent(new Event('change')); }
        });

        if (answers[currentIndex] === opt) li.classList.add('selected');

        optionsList.appendChild(li);
      });

      // update palette & progress
      updatePalette();
      updateProgress();
    }

    // --------- palette (question index buttons) ----------
    function buildPalette(){
      paletteEl.innerHTML = '';
      for(let i=0;i<questions.length;i++){
        const btn = document.createElement('div');
        btn.className = 'pal-item';
        btn.textContent = (i+1);
        btn.style.background = answers[i] ? '#86efac' : (reviewed[i] ? '#fef08a' : '#e2e8f0');
        btn.addEventListener('click', ()=> {
          currentIndex = i;
          renderQuestion();
          window.scrollTo({top:0,behavior:'smooth'});
        });
        paletteEl.appendChild(btn);
      }
    }

    function updatePalette(){
      const items = paletteEl.children;
      for(let i=0;i<items.length;i++){
        const el = items[i];
        const isAnswered = !!answers[i];
        const isReviewed = !!reviewed[i];
        el.style.background = isAnswered ? '#86efac' : (isReviewed ? '#fef08a' : '#e2e8f0');
        el.style.color = '#000';
        el.style.fontWeight = '700';
      }
      // update answered count
      const answeredCount = Object.keys(answers).length;
      answeredCountEl.textContent = `Answered: ${answeredCount}`;
    }

    function updateProgress(){
      const total = questions.length;
      const answered = Object.keys(answers).length;
      const percent = total ? Math.round((answered/total)*100) : 0;
      progBar.style.width = percent + '%';
      progressText.textContent = `${Math.min(currentIndex+1,total)} / ${total}`;
      answeredCountEl.textContent = `Answered: ${answered}`;
    }

    // --------- timer ----------
    function startTimer(){
      updateTimerDisplay();
      timerInterval = setInterval(()=>{
        timeLeft--;
        if(timeLeft<=0){
          clearInterval(timerInterval);
          alert('Time up! Submitting exam.');
          submitExam();
          return;
        }
        updateTimerDisplay();
      },1000);
    }

    function updateTimerDisplay(){
      const mm = String(Math.floor(timeLeft/60)).padStart(2,'0');
      const ss = String(timeLeft%60).padStart(2,'0');
      timerEl.textContent = `${mm}:${ss}`;
    }

    // --------- navigation buttons ----------
    document.getElementById('next-btn').addEventListener('click', ()=>{
      if(currentIndex < questions.length-1) currentIndex++;
      renderQuestion();
    });
    document.getElementById('prev-btn').addEventListener('click', ()=>{
      if(currentIndex > 0) currentIndex--;
      renderQuestion();
    });
    document.getElementById('review-btn').addEventListener('click', ()=>{
      reviewed[currentIndex] = !reviewed[currentIndex];
      updatePalette();
    });

    document.getElementById('back-btn').addEventListener('click', ()=>{
      clearInterval(timerInterval);
      quizSection.style.display = 'none';
      dashboard.style.display = 'block';
      resultCard.style.display = 'none';
      // reset some UI
    });

    document.getElementById('end-btn').addEventListener('click', ()=>{
      if(confirm('Are you sure you want to submit the exam now?')) submitExam();
    });

    // --------- submitExam ----------
    async function submitExam(){
      clearInterval(timerInterval);
      // basic scoring: compare answers to questions.answer if present
      let correct=0, wrong=0, unattempted=0;
      for(let i=0;i<questions.length;i++){
        const q = questions[i];
        const a = answers[i];
        if(!a){ unattempted++; continue; }
        if(q.answer !== undefined && String(q.answer).trim() === String(a).trim()){ correct++; } else { wrong++; }
      }
      const total = questions.length;
      const score = correct;

      // show result
      resultBody.innerHTML = `
        <p>Total Questions: ${total}</p>
        <p>Correct: ${correct}</p>
        <p>Wrong: ${wrong}</p>
        <p>Unattempted: ${unattempted}</p>
        <p>Score: ${score}</p>
      `;
      resultCard.style.display = 'block';

      // save result to Firestore (if signed-in)
      if (user) {
        try {
          await addDoc(collection(db, 'results'), {
            email: user.email,
            uid: user.uid,
            exam: currentExam,
            correct,
            wrong,
            unattempted,
            score,
            total,
            submittedAt: new Date()
          });
        } catch(e){ console.error('Failed to save result', e); }
      }

      // scroll to result
      resultCard.scrollIntoView({behavior:'smooth'});
    }

    document.getElementById('close-result').addEventListener('click', ()=>{
      resultCard.style.display = 'none';
    });

    document.getElementById('download-result').addEventListener('click', ()=>{
      // simple text download
      const txt = resultBody.innerText;
      const blob = new Blob([txt], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${currentExam}_result.txt`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // safety: expose to console for debugging
    window._debug = { startExam, renderQuestion, loadCategories, loadSubcategories, db };

  </script>
</body>
</html>
