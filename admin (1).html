<!DOCTYPE html>

<html lang="bn">
<head>
<meta charset="utf-8"/>
<title>Target Zone - Admin Panel</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { background: linear-gradient(135deg,#0f2027,#203a43,#2c5364); color:white; font-family:'Segoe UI',sans-serif; overflow:hidden; }
    .sidebar { background: linear-gradient(180deg,#1e3c72,#2a5298); transition: transform 0.4s ease; }
    .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); color:black; animation: glow 4s infinite alternate; }
    @keyframes glow { from {box-shadow:0 0 5px #6a11cb;} to {box-shadow:0 0 25px #2575fc;} }
    .rainbow { background: linear-gradient(90deg,#ff7e5f,#feb47b,#ff6a00,#ee0979,#6a11cb,#2575fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight:bold; }
    .nav-btn { display:flex; align-items:center; gap:10px; transition:all 0.3s; background:rgba(255,255,255,0.1); }
    .nav-btn:hover { background:linear-gradient(90deg,#ff7e5f,#feb47b,#6a11cb); color:white; transform:translateX(5px); }
    .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:999; }
    .modal img { max-width:90%; max-height:90%; border:5px solid white; border-radius:10px; }
    .finance-bg {
  background: linear-gradient(135deg, #ff7e5f, #feb47b, #6a11cb, #2575fc);
  animation: gradientShift 10s ease infinite;
}
@keyframes gradientShift {
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}
    /* ---------- Salary & More Text Fix ---------- */
#section-finance .glass {
  color: black !important;
}
#section-finance input,
#section-finance select,
#section-finance textarea {
  color: black !important;
}
  
/* === Finance Section Text Color Fix === */
#section-finance, 
#section-finance * {
  color: black !important;
}

</style>
</head>
<body class="h-screen flex overflow-hidden">
<!-- Background Animation -->
<canvas class="fixed top-0 left-0 w-full h-full -z-10" id="bg-canvas"></canvas>
<!-- Sidebar -->
<aside class="sidebar fixed md:static w-64 h-full text-white z-50 hidden md:flex flex-col" id="sidebar">
<div class="p-5 flex justify-between items-center border-b border-white/20">
<div>
<h1 class="rainbow text-2xl">🌈 Target Zone</h1>
<p class="text-sm" id="admin-email"></p>
</div>
<button class="md:hidden text-xl" id="close-sidebar">❌</button>
</div>
<nav class="p-4 space-y-3 flex-1">
<button class="nav-btn w-full py-2 px-3 rounded" onclick="showSection('add')">➕ Add Question</button>
<button class="nav-btn w-full py-2 px-3 rounded" onclick="showSection('results')">📊 View Results</button>
<button class="nav-btn w-full py-2 px-3 rounded" onclick="showSection('users')">👥 Manage Users</button>
<!-- add this inside <nav class="p-4 space-y-3 flex-1">, after Manage Users button -->
<button class="nav-btn w-full py-2 px-3 rounded" onclick="showSection('notes')">📚 Manage Notes</button>
<button class="nav-btn w-full py-2 px-3 rounded" onclick="showSection('finance')">💼 Salary &amp; More</button>
<button class="nav-btn w-full py-2 px-3 rounded" onclick="showSection('submissions')">💰 Payments &amp; Forms</button>
</nav>
<div class="p-4 border-t border-white/20">
<button class="w-full bg-red-600 py-2 rounded" onclick="logout()">🚪 Logout</button>
</div>
</aside>
<!-- Main -->
<main class="flex-1 p-6 overflow-y-auto">
<div class="flex justify-between items-center mb-6">
<button class="md:hidden bg-yellow-400 px-3 py-2 rounded" id="menu-btn">☰</button>
<h2 class="rainbow text-3xl">🛠️ Admin Panel</h2>
<div class="flex items-center gap-3">
<audio autoplay="" id="bg-music" loop="" muted="">
<source src="Bangla_nonstop_romantic_song____Kumar_Sanu____adhunik_Bangla_gaan____বাংলা_গান____90s_bengali_song(256k).mp3" type="audio/mp3"/>
</audio>
<button class="bg-green-500 px-3 py-1 rounded" id="music-btn">🔊 Play Sound</button>
</div>
</div>
<!-- Add Question -->
<section class="glass p-6 rounded-lg shadow-lg hidden" id="section-add">
<form id="question-form">
<h3 class="text-xl font-bold mb-4">➕ Add New Question</h3>
<select class="w-full border rounded px-3 py-2 mb-3" id="category" onchange="loadSubcategories(this.value)">
<option value="">--Select Category--</option>
<option value="ssc">SSC</option>
<option value="railways">Railways</option>
<option value="tet">TET</option>
</select>
<!-- নতুন Subcategory dropdown -->
<div class="flex gap-2 mb-3">
<select class="w-full border rounded px-3 py-2" id="subcategory"></select>
<input class="border rounded px-3 py-2" id="new-subcat" placeholder="➕ New Subcategory" type="text"/>
<button class="bg-green-500 text-white px-3 rounded" onclick="addSubcategory()" type="button">Add</button>
</div>
<textarea class="w-full border rounded px-3 py-2 mb-3" id="question" placeholder="প্রশ্ন লিখুন..." rows="3"></textarea>
<input accept="image/*" class="w-full mb-3" id="photo" type="file"/>
<div class="grid grid-cols-2 gap-3">
<label><input name="correct" type="radio" value="0"/> <input class="w-full border rounded px-3 py-2" id="option1" placeholder="Option A"/></label>
<label><input name="correct" type="radio" value="1"/> <input class="w-full border rounded px-3 py-2" id="option2" placeholder="Option B"/></label>
<label><input name="correct" type="radio" value="2"/> <input class="w-full border rounded px-3 py-2" id="option3" placeholder="Option C"/></label>
<label><input name="correct" type="radio" value="3"/> <input class="w-full border rounded px-3 py-2" id="option4" placeholder="Option D"/></label>
</div>
<button class="bg-blue-500 text-white px-4 py-2 rounded" onclick="addQuestion()" type="button">Add</button>
</form>
<h3 class="text-lg font-semibold mt-6">📋 Added Questions</h3>
<div class="max-h-64 overflow-y-auto border rounded mt-3">
<table class="w-full text-left border">
<thead><tr><th>Question</th><th>Answer</th><th>Delete</th></tr></thead>
<tbody id="questions-list"></tbody>
</table>
</div>
</section>
<!-- Results -->
<section class="glass p-6 rounded-lg shadow-lg hidden" id="section-results">
<h3 class="text-xl font-bold mb-4">📊 View Results</h3>
<canvas class="mb-6" id="resultsChart"></canvas>
<table class="w-full text-left border">
<thead><tr><th>Email</th><th>Exam</th><th>Score</th><th>Submitted</th></tr></thead>
<tbody id="results-list"></tbody>
</table>
</section>
<!-- Users -->
<section class="glass p-6 rounded-lg shadow-lg hidden" id="section-users">
<h3 class="text-xl font-bold mb-4">👥 Manage Users</h3>
<table class="w-full text-left border">
<thead><tr><th>Name</th><th>Email</th><th>WhatsApp</th><th>Education</th><th>Status</th></tr></thead>
<tbody id="users-list"></tbody>
</table>
</section>
<!-- Payments & Forms Section -->
<section class="glass p-6 rounded-lg shadow-lg hidden" id="section-submissions">
<h3 class="text-xl font-bold mb-4 flex items-center gap-2">💰 Payment Proofs</h3>
<table class="w-full text-left border mb-6">
<thead class="bg-gray-200">
<tr><th class="p-2">Name</th><th>Phone</th><th>Proof</th><th>Date</th></tr>
</thead>
<tbody id="payments-list"></tbody>
</table>
<h3 class="text-xl font-bold mb-4 flex items-center gap-2">📄 Admission Forms</h3>
<table class="w-full text-left border">
<thead class="bg-gray-200">
<tr><th class="p-2">Name</th><th>Phone</th><th>Course</th><th>Address</th><th>Message</th><th>Date</th></tr>
</thead>
<tbody id="admissions-list"></tbody>
</table>
</section>
<!-- Finance Section -->
<section aria-label="finance-section" class="glass p-6 rounded-lg shadow-lg hidden" id="section-finance">
<h3 class="text-2xl font-bold rainbow mb-6">💼 Salary, Birthdays &amp; More</h3>
<div class="grid grid-cols-1 md:grid-cols-4 gap-6">
<!-- Batches -->
<div class="glass p-4 rounded-lg">
<h4 class="font-semibold mb-3">Batches</h4>
<div class="space-y-2 max-h-64 overflow-y-auto text-white" id="tz-batch-list">Loading...</div>
<div class="mt-3">
<button class="w-full bg-indigo-600 text-white py-2 rounded" id="tz-show-add-batch">➕ Add Batch</button>
</div>
<div class="hidden mt-3 glass p-3" id="tz-batch-form">
<input class="border rounded px-2 py-2 w-full mb-2 bg-transparent text-white" id="tz-new-batch-name" placeholder="Batch Name"/>
<button class="w-full bg-green-600 py-2 rounded text-white" id="tz-save-batch">Save Batch</button>
</div>
</div>
<!-- Students -->
<div class="col-span-2 glass p-4 rounded-lg">
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
<h4 class="font-semibold">Students</h4>
<div class="flex gap-2 w-full md:w-auto">
<input class="border rounded px-3 py-2 w-full md:w-72 bg-transparent text-white" id="tz-student-search" placeholder="Search by name or phone"/>
<button class="bg-green-600 text-white px-4 py-2 rounded" id="tz-show-add-student">+ Add Student</button>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-96 overflow-y-auto" id="tz-student-list"></div>
</div>
<!-- Profile -->
<div class="glass p-4 rounded-lg" id="tz-student-panel">
<h4 class="font-semibold mb-2">Profile</h4>
<div class="text-sm glass p-3 rounded-lg text-white" id="tz-profile-area">
          Select a student to view profile
        </div>
</div>
</div>
<!-- Student Modal -->
<div class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" id="tz-student-modal" class="hidden">
<div class="w-full max-w-lg glass p-6 rounded-2xl">
<div class="flex justify-between items-center mb-3">
<h5 class="font-semibold text-lg">Add Student</h5>
<button class="text-xl" id="tz-close-student-form">✖</button>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-2">
<input class="border rounded px-2 py-2 bg-transparent text-white" id="tz-student-name" placeholder="নাম"/>
<input class="border rounded px-2 py-2 bg-transparent text-white" id="tz-student-phone" placeholder="Mobile Number"/>
<input class="border rounded px-2 py-2 bg-transparent text-white" id="tz-student-whatsapp" placeholder="WhatsApp Number"/>
<input class="border rounded px-2 py-2 bg-transparent text-white" id="tz-student-email" placeholder="Email (optional)" type="email"/>
<input class="border rounded px-2 py-2 bg-transparent text-white" id="tz-student-father" placeholder="বাবার নাম"/>
<input class="border rounded px-2 py-2 bg-transparent text-white" id="tz-student-address" placeholder="ঠিকানা"/>
<input class="border rounded px-2 py-2 bg-transparent text-white" id="tz-student-education" placeholder="Education level"/>
<select class="border rounded px-2 py-2 bg-transparent text-white" id="tz-student-batch-select"><option value="">-- Select Batch --</option></select>
<input class="border rounded px-2 py-2 bg-transparent text-white" id="tz-student-dob" type="date"/>

</div>
<div class="mt-4 flex gap-2">
<button class="bg-blue-600 text-white px-4 py-2 rounded" id="tz-save-student-btn">Save</button>
<button class="bg-gray-600 text-white px-4 py-2 rounded" id="tz-cancel-student-btn">Cancel</button>
</div>
</div>
</div>
</section>
<!-- Manage Notes Section -->
<section class="glass p-6 rounded-lg shadow-lg hidden" id="section-notes">
<h3 class="text-xl font-bold mb-4">📚 Manage Notes (Google Drive links)</h3>
<div class="flex gap-2 mb-4">
<input class="border rounded px-3 py-2 flex-1" id="noteTitle" placeholder="Note Title (e.g. SSC GD - Set A)"/>
<input class="border rounded px-3 py-2 flex-1" id="noteLink" placeholder="Google Drive share link (paste here)"/>
<button class="bg-green-500 text-white px-3 rounded" onclick="addNote()">➕ Add</button>
</div>
<table class="w-full text-left border">
<thead><tr><th>Title</th><th>Link</th><th>Delete</th></tr></thead>
<tbody id="notes-list"></tbody>
</table>
</section>
</main>
<!-- Firebase & Scripts -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, where, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
    import { getDatabase, ref as dbRef, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCR5rqthBh0vX0yLOcOG3b9xJiKbYtzdxU",
      authDomain: "target-zone-8fffd.firebaseapp.com",
      projectId: "target-zone-8fffd",
      storageBucket: "target-zone-8fffd.appspot.com",
      messagingSenderId: "667579216123",
      appId: "1:667579216123:web:37bb1fcc724743073d005e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const rtdb = getDatabase(app);

    let currentCategory="";

    onAuthStateChanged(auth,user=>{
      if(!user){ window.location.href="index.html"; }
      else{ document.getElementById("admin-email").textContent="👤 "+user.email; }
    });

    window.logout=async()=>{ await signOut(auth); window.location.href="index.html"; };

    

    // Load Questions
    
// --- প্রতিস্থাপন করুন: window.loadQuestions = async (...) {...} ---
window.loadQuestions = async (categoryOrColl) => {
  if (!categoryOrColl) return;
  const table = document.getElementById("questions-list");
  table.innerHTML = "<tr><td colspan='3'>লোড হচ্ছে...</td></tr>";

  // নোট: caller কখনও base category (e.g. "ssc"), কখনও composite (e.g. "ssc__math") পাঠাতে পারে
  let collToQuery = categoryOrColl;

  if (typeof categoryOrColl === "string" && categoryOrColl.includes("__")) {
    // composite এসেছে: split করে globals sync করে নাও
    const parts = categoryOrColl.split("__");
    currentCategory = parts[0] || "";
    currentSubcategory = parts[1] || "";
    collToQuery = categoryOrColl;
    const subSelect = document.getElementById("subcategory");
    if (subSelect) subSelect.value = currentSubcategory;
    const catSelect = document.getElementById("category");
    if (catSelect) catSelect.value = currentCategory;
  } else {
    // base category এসেছে
    currentCategory = categoryOrColl;
    // যদি আগে থেকে currentSubcategory থাকে, তখন composite collection থেকে লোড করো
    if (currentSubcategory) {
      collToQuery = `${currentCategory}__${currentSubcategory}`;
    } else {
      collToQuery = currentCategory;
    }
    const catSelect = document.getElementById("category");
    if (catSelect) catSelect.value = currentCategory;
  }

  try {
    const snapshot = await getDocs(collection(db, collToQuery));
    let rows = "";
    snapshot.forEach(docSnap => {
      const q = docSnap.data();
      rows += `
        <tr>
          <td>${q.question || ""}${q.photo?`<br><img src="${q.photo}" class="w-20 cursor-pointer" onclick="openModal('${q.photo}')">`:""}</td>
          <td>${q.answer || ""}</td>
          <td><button onclick="deleteQuestion('${collToQuery}','${docSnap.id}')" class="bg-red-500 text-white px-2 py-1 rounded">🗑</button></td>
        </tr>
      `;
    });
    table.innerHTML = rows || "<tr><td colspan='3'>কোনো প্রশ্ন নেই</td></tr>";
  } catch (err) {
    console.error("loadQuestions error:", err);
    table.innerHTML = `<tr><td colspan='3'>লোডে সমস্যা: ${err.message || err}</td></tr>`;
  }
};
// --- end loadQuestions replacement ---
    // Delete Question
    window.deleteQuestion=async(cat,id)=>{ await deleteDoc(doc(db,cat,id)); loadQuestions(cat); };

    // Modal Preview
    window.openModal=(url)=>{
      const modal=document.createElement("div");
      modal.className="modal";
      modal.innerHTML=`<img src="${url}" onclick="this.parentElement.remove()">`;
      document.body.appendChild(modal);
    }

    // Show Section
    window.showSection = async (id) => {
  document.querySelectorAll("section").forEach(sec => sec.classList.add("hidden"));
  const el = document.getElementById("section-" + id);
  if (el) el.classList.remove("hidden");
  // load hooks
  if (id === "notes") await loadNotes();
  if (id === "results") await loadResults();
  if (id === "users") await loadUsers();
  if (id === "submissions") await loadSubmissions();
  // finance handled elsewhere by click cards
};

    // Load Results with Pie Chart
    async function loadResults(){
      const table=document.getElementById("results-list");
      table.innerHTML="<tr><td colspan='4'>লোড হচ্ছে...</td></tr>";
      const q=query(collection(db,"results"),orderBy("submittedAt","desc"));
      const snapshot=await getDocs(q);
      let rows="",correct=0,wrong=0,unattempted=0;
      snapshot.forEach(docSnap=>{
        const r=docSnap.data();
        correct+=r.correct||0;
        wrong+=r.wrong||0;
        unattempted+=r.unattempted||0;
        rows+=`<tr><td>${r.email}</td><td>${r.exam}</td><td>${r.score}/${r.total}</td><td>${r.submittedAt ? new Date(r.submittedAt.seconds*1000).toLocaleString():"N/A"}</td></tr>`;
      });
      table.innerHTML=rows||"<tr><td colspan='4'>কোনো রেজাল্ট নেই</td></tr>";
      new Chart(document.getElementById("resultsChart"),{
        type:"pie",
        data:{labels:["Correct","Wrong","Unattempted"],datasets:[{data:[correct,wrong,unattempted],backgroundColor:["#4caf50","#f44336","#9e9e9e"]}]}
      });
    }

    // Load Users
    
    
      

    // Music Toggle
    const music=document.getElementById("bg-music");
    const musicBtn=document.getElementById("music-btn");
    musicBtn.addEventListener("click",()=>{
      if(music.muted){ music.muted=false; music.play(); musicBtn.textContent="🔇 Mute Sound"; }
      else{ music.muted=true; musicBtn.textContent="🔊 Play Sound"; }
    });
  
    



    // ---- Admin additions: clean loadUsers & loadSubmissions ----
    async function loadUsers(){
      const table = document.getElementById("users-list");
      if(!table) return;
      table.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
      try {
        const querySnapshot = await getDocs(collection(db, "users"));
        let rows = "";
        querySnapshot.forEach(docSnap => {
          const d = docSnap.data() || {};
          rows += `<tr>
            <td>${d.name || ""}</td>
            <td>${d.email || ""}</td>
            <td>${d.whatsapp || ""}</td>
            <td>${d.education || ""}</td>
            <td>${d.status || ""}</td>
          </tr>`;
        });
        table.innerHTML = rows || "<tr><td colspan='5'>No users found</td></tr>";
      } catch (error) {
        console.error("Error loading users: ", error);
        table.innerHTML = "<tr><td colspan='5'>Error loading users</td></tr>";
      }
    }

    function formatTimestamp(ts){
      if(!ts) return "";
      try{
        if(typeof ts === 'number') return new Date(ts).toLocaleString();
        if(ts.seconds) return new Date(ts.seconds*1000).toLocaleString();
        return new Date(ts).toLocaleString();
      }catch(e){
        return "";
      }
    }

    async function loadSubmissions(){
      const paymentsTable = document.getElementById("payments-list");
      const admissionsTable = document.getElementById("admissions-list");
      if(paymentsTable) paymentsTable.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";
      if(admissionsTable) admissionsTable.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";

      try{
        const paySnap = await get(dbRef(rtdb, "paymentProofs"));
        let payRows = "";
        if(paySnap.exists && paySnap.exists()){
          paySnap.forEach(item=>{
            const d = item.val() || {};
            payRows += `<tr>
              <td>${d.name || ""}</td>
              <td>${d.phone || ""}</td>
              <td><img src="${d.url || ""}" class="w-16 h-16 object-cover cursor-pointer" onclick="openModal('${d.url || ""}')"></td>
              <td>${formatTimestamp(d.createdAt)}</td>
            </tr>`;
          });
        } else {
          payRows = "<tr><td colspan='4'>No Data</td></tr>";
        }
        if(paymentsTable) paymentsTable.innerHTML = payRows;
      }catch(e){
        console.error("Error loading payments:", e);
        if(paymentsTable) paymentsTable.innerHTML = "<tr><td colspan='4'>Error loading payments</td></tr>";
      }

      try{
        const admSnap = await get(dbRef(rtdb, "admissions"));
        let admRows = "";
        if(admSnap.exists && admSnap.exists()){
          admSnap.forEach(item=>{
            const d = item.val() || {};
            admRows += `<tr>
              <td>${d.name || ""}</td>
              <td>${d.phone || ""}</td>
              <td>${d.course || ""}</td>
              <td>${d.address||""}</td>
              <td>${d.message||""}</td>
              <td>${formatTimestamp(d.createdAt)}</td>
            </tr>`;
          });
        } else {
          admRows = "<tr><td colspan='6'>No Data</td></tr>";
        }
        if(admissionsTable) admissionsTable.innerHTML = admRows;
      }catch(e){
        console.error("Error loading admissions:", e);
        if(admissionsTable) admissionsTable.innerHTML = "<tr><td colspan='6'>Error loading admissions</td></tr>";
      }
    }
    // === Finance Section Logic ===

  // ---------------- Salary Module ----------------

  window.openSalary = async () => {
    hideFinancePanels();
    const panel = document.getElementById("salary-panel");
    panel.classList.remove("hidden");
    panel.innerHTML = `
      <div class="flex justify-between items-center">
        <h3 class="text-2xl font-bold">🪙 Student & Salary Management</h3>
        <div class="flex gap-2">
          <button id="export-csv" class="bg-indigo-600 px-3 py-1 rounded">Export CSV</button>
          <button id="add-student-top" class="bg-green-600 px-3 py-1 rounded">+ New Student</button>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="col-span-1 bg-white/5 p-4 rounded-lg">
          <h4 class="font-semibold mb-3">Batches</h4>
          <div id="batch-list" class="space-y-2 max-h-64 overflow-y-auto">Loading...</div>
          <div class="mt-3">
            <button onclick="showAddBatchForm()" class="w-full bg-blue-600 py-2 rounded">➕ Add Batch</button>
          </div>
        </div>

        <div class="col-span-2 bg-white/5 p-4 rounded-lg">
          <div class="flex justify-between items-center mb-3">
            <h4 class="font-semibold">Students</h4>
            <div class="flex gap-2">
              <input id="student-search" placeholder="Search by name or phone" class="border rounded px-3 py-2" />
              <button id="show-add-student" class="bg-green-600 px-3 py-1 rounded">+ Add</button>
            </div>
          </div>

          <div id="student-list" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-96 overflow-y-auto">Select a batch</div>

          <div id="student-form" class="hidden mt-4 bg-white/10 p-4 rounded">
            <h5 class="font-semibold mb-2">Add Student</h5>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
              <select id="student-batch-select" class="border rounded px-2 py-2"><option value="">-- Select Batch --</option></select>
              <input id="student-name" placeholder="নাম" class="border rounded px-2 py-2" />
              <input id="student-dob" type="date" class="border rounded px-2 py-2" />
              <input id="student-phone" placeholder="Mobile Number" class="border rounded px-2 py-2" />
              <input id="student-whatsapp" placeholder="WhatsApp Number" class="border rounded px-2 py-2" />
              <input id="student-father" placeholder="বাবার নাম" class="border rounded px-2 py-2" />
              <input id="student-address" placeholder="ঠিকানা" class="border rounded px-2 py-2" />
              <input id="student-extra" placeholder="অতিরিক্ত তথ্য (optional)" class="border rounded px-2 py-2" />
            </div>
            <div class="mt-3 flex gap-2">
              <button id="save-student-btn" class="bg-blue-600 px-3 py-1 rounded">Save</button>
              <button onclick="document.getElementById('student-form').classList.add('hidden')" class="bg-gray-600 px-3 py-1 rounded">Cancel</button>
            </div>
          </div>
        </div>

        <div id="student-panel" class="col-span-1 bg-white/5 p-4 rounded-lg">
          <h4 class="font-semibold mb-2">Profile</h4>
          <div id="profile-area" class="text-sm">Select a student to view profile</div>
        </div>
      </div>
    `;

    document.getElementById("export-csv").addEventListener("click", exportCurrentViewCSV);
    document.getElementById("show-add-student").addEventListener("click", ()=> document.getElementById("student-form").classList.toggle("hidden"));
    document.getElementById("add-student-top").addEventListener("click", ()=> document.getElementById("student-form").classList.remove("hidden"));

    loadBatches();
    await populateStudentBatchSelect();
  };

  async function loadBatches() {
    try {
      const q = query(collection(db, "batches"), orderBy("name"));
      const snap = await getDocs(q);
      const container = document.getElementById("batch-list");
      container.innerHTML = "";
      if (snap.empty) { container.innerHTML = "No batches found"; return; }
      snap.forEach(docSnap => {
        const b = docSnap.data();
        const btn = document.createElement("button");
        btn.className = "w-full text-left px-3 py-2 bg-white/5 rounded hover:bg-white/10 flex justify-between";
        btn.innerHTML = `<span>${b.name || docSnap.id}</span>`;
        btn.onclick = () => loadStudents(docSnap.id);
        container.appendChild(btn);
      });
    } catch (e) { console.error(e); }
  }

  async function populateStudentBatchSelect() {
    try {
      const q = query(collection(db, "batches"), orderBy("name"));
      const snap = await getDocs(q);
      const sel = document.getElementById("student-batch-select");
      sel.innerHTML = '<option value="">-- Select Batch --</option>';
      snap.forEach(docSnap => {
        const d = docSnap.data();
        const opt = document.createElement("option");
        opt.value = docSnap.id;
        opt.textContent = d.name || docSnap.id;
        sel.appendChild(opt);
      });
    } catch (e) { console.error(e); }
  }

  window.loadStudents = async (batchId) => {
    const list = document.getElementById("student-list");
    list.innerHTML = "Loading...";
    try {
      const q = query(collection(db,"students"), where("batch","==",batchId));
      const snap = await getDocs(q);
      list.innerHTML = "";
      if (snap.empty) { list.innerHTML = "No students"; return; }
      snap.forEach(docSnap => {
        const s = docSnap.data();
        const el = document.createElement("div");
        el.className = "p-3 bg-white/5 rounded flex justify-between";
        el.innerHTML = `<div><div class="font-semibold">${s.name||"(No name)"}</div><div class="text-xs">${s.phone||""}</div></div><button class="bg-green-600 px-2 py-1 rounded text-sm" onclick="openStudentFinance('${docSnap.id}')">Open</button>`;
        list.appendChild(el);
      });
    } catch (e) { console.error(e); list.innerHTML="Error"; }
  };

  window.openStudentFinance = async (studentId) => {
    const area = document.getElementById("profile-area");
    area.innerHTML = "Loading...";
    try {
      const docRef = doc(db, "students", studentId);
      const sDoc = await getDoc(docRef);
      if (!sDoc.exists()) { area.innerHTML="Not found"; return; }
      const s = sDoc.data();
      area.innerHTML = `
        <div>
          <div class="font-semibold text-lg">${s.name||"(No name)"}</div>
          <div class="text-sm">${s.phone||""} ${s.whatsapp?("• "+s.whatsapp):""}</div>
          <div class="text-xs">${s.address||""}</div>
          <hr class="my-2"/>
          <h5 class="font-semibold">Monthly Account</h5>
          <table class="w-full text-sm border mt-2"><thead><tr><th>Month</th><th>Amount</th><th>Note</th><th>Action</th></tr></thead><tbody id="finance-rows"><tr><td colspan="4">Loading...</td></tr></tbody></table>
          <div class="mt-2 flex gap-2">
            <select id="pay-month" class="border px-2 py-1">${generateLast12MonthsOptions()}</select>
            <input id="pay-amount" type="number" placeholder="Amount (₹)" class="border px-2 py-1"/>
            <input id="pay-note" placeholder="Note" class="border px-2 py-1"/>
            <button onclick="addPayment('${studentId}')" class="bg-blue-600 px-3 py-1 rounded">Add</button>
          </div>
        </div>`;
      loadFinance(studentId);
    } catch (e) { console.error(e); area.innerHTML="Error"; }
  };

  async function loadFinance(studentId) {
    const tbody=document.getElementById("finance-rows");
    tbody.innerHTML="<tr><td colspan='4'>Loading...</td></tr>";
    try {
      const q=query(collection(db,"salaries"),where("studentId","==",studentId),orderBy("month","desc"));
      const snap=await getDocs(q);
      tbody.innerHTML="";
      if(snap.empty){tbody.innerHTML="<tr><td colspan='4'>No records</td></tr>";return;}
      snap.forEach(docSnap=>{
        const d=docSnap.data();
        tbody.innerHTML+=`<tr><td>${d.month}</td><td>${d.amount}</td><td>${d.note||""}</td><td><button class="bg-red-600 px-2 py-1 rounded text-sm" onclick="deleteSalary('${docSnap.id}','${studentId}')">Del</button></td></tr>`;
      });
    } catch(e){console.error(e);tbody.innerHTML="<tr><td colspan='4'>Error</td></tr>";}
  }

  async function addPayment(studentId){
    const month=document.getElementById("pay-month").value;
    const amount=Number(document.getElementById("pay-amount").value);
    const note=document.getElementById("pay-note").value;
    if(!month||!amount){alert("Enter valid");return;}
    try{
      await addDoc(collection(db,"salaries"),{studentId,month,amount,note,createdAt:Date.now()});
      loadFinance(studentId);
      document.getElementById("pay-amount").value="";document.getElementById("pay-note").value="";
    }catch(e){console.error(e);alert("Error");}
  }

  function exportCurrentViewCSV(){
    const rows=[["Month","Amount","Note"]];
    document.querySelectorAll("#finance-rows tr").forEach(tr=>{
      const cols=Array.from(tr.querySelectorAll("td")).map(td=>td.textContent.trim());
      if(cols.length>=3)rows.push([cols[0],cols[1],cols[2]]);
    });
    const csv=rows.map(r=>r.join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");a.href=url;a.download="salary.csv";a.click();URL.revokeObjectURL(url);
  }

// === Add Batch & Student Management ===

window.showAddBatchForm = () => {
  document.getElementById("batch-form").classList.toggle("hidden");
};

window.addBatch = async () => {
  const name = document.getElementById("new-batch-name").value.trim();
  if (!name) return alert("⚠️ ব্যাচের নাম লিখুন!");
  await addDoc(collection(db, "batches"), { name, createdAt: Date.now() });
  document.getElementById("new-batch-name").value = "";
  document.getElementById("batch-form").classList.add("hidden");
  loadBatches();
  alert("✅ নতুন ব্যাচ তৈরি হয়েছে");
};

let currentBatchId = null;

window.showAddStudentForm = () => {
  document.getElementById("student-form").classList.toggle("hidden");
};

window.addStudent = async () => {
  if (!currentBatchId) return alert("⚠️ আগে একটি ব্যাচ সিলেক্ট করুন!");
  const name = document.getElementById("student-name").value.trim();
  const phone = document.getElementById("student-phone").value.trim();
  if (!name || !phone) return alert("⚠️ নাম ও ফোন লিখুন!");

  await addDoc(collection(db, "students"), {
    name, phone, batch: currentBatchId, createdAt: Date.now()
  });

  document.getElementById("student-name").value = "";
  document.getElementById("student-phone").value = "";
  document.getElementById("student-form").classList.add("hidden");
  loadStudents(currentBatchId);
  alert("✅ স্টুডেন্ট অ্যাড হয়েছে");
};

// patch loadStudents to remember batchId
const _oldLoadStudents = window.loadStudents;
window.loadStudents = async (batchId) => {
  currentBatchId = batchId;
  return _oldLoadStudents(batchId);
};
// === end Add Batch & Student ===

// Birthday
window.openBirthday = async () => {
  hideFinancePanels();
  const panel = document.getElementById("birthday-panel");
  panel.classList.remove("hidden");
  const today = new Date().toISOString().slice(5,10); // MM-DD
  // Demo birthday list
  const students = [
    {name:"Student One",dob:"08-17",phone:"1234567890"},
    {name:"Student Two",dob:"12-25",phone:"9876543210"}
  ];
  let html = `<h3 class="text-xl font-bold mb-4">🎉 Today’s Birthdays</h3>`;
  const todays = students.filter(s=>s.dob===today);
  if(todays.length===0) html += `<p>No birthdays today</p>`;
  todays.forEach(s=>{
    const msg = `শুভ জন্মদিন ${s.name}! 🎉 তোমার জীবন আনন্দে ভরে উঠুক।`;
    html += `
      <div class="p-4 bg-pink-200 rounded mb-3 text-black">
        🎂 ${s.name} 
        <div class="mt-2 flex gap-3">
          <a href="https://wa.me/${s.phone}?text=${encodeURIComponent(msg)}" target="_blank" class="bg-green-500 text-white px-3 py-1 rounded">WhatsApp</a>
          <a href="sms:${s.phone}?body=${encodeURIComponent(msg)}" class="bg-blue-500 text-white px-3 py-1 rounded">SMS</a>
        </div>
      </div>
    `;
  });
  panel.innerHTML = html;
};

// Attendance
window.openAttendance = async () => {
  hideFinancePanels();
  const panel = document.getElementById("attendance-panel");
  panel.classList.remove("hidden");
  panel.innerHTML = `
    <h3 class="text-xl font-bold mb-4">📅 Attendance</h3>
    <table class="w-full border">
      <thead><tr><th>Name</th><th>Status</th></tr></thead>
      <tbody>
        <tr><td>Student One</td><td><button class="bg-green-500 px-2 py-1 rounded">Present</button></td></tr>
        <tr><td>Student Two</td><td><button class="bg-red-500 px-2 py-1 rounded">Absent</button></td></tr>
      </tbody>
    </table>
  `;
};

// Reports (future)
window.openReports = async () => {
  hideFinancePanels();
  const panel = document.getElementById("reports-panel");
  panel.classList.remove("hidden");
  panel.innerHTML = `<h3 class="text-xl">📊 Reports Coming Soon</h3>`;
};

// Helper to hide all
function hideFinancePanels(){
  ["salary-panel","birthday-panel","attendance-panel","reports-panel"]
  .forEach(id=>document.getElementById(id).classList.add("hidden"));
}
    let currentSubcategory = "";

// সাবক্যাটাগরি লোড
window.loadSubcategories = async (category) => {
  currentCategory = category;
  const subSelect = document.getElementById("subcategory");
  subSelect.innerHTML = "<option value=''>--Select Subcategory--</option>";
  if (!category) return;

  const q = query(collection(db, "subcategories"), where("category", "==", category));
  const snapshot = await getDocs(q);

  snapshot.forEach(docSnap => {
    const sub = docSnap.data();
    const opt = document.createElement("option");
    opt.value = sub.id;          // ✅ সাবক্যাটাগরির id হবে কালেকশন নাম
    opt.textContent = sub.name;
    subSelect.appendChild(opt);
  });
};

// নতুন সাবক্যাটাগরি যোগ
window.addSubcategory = async () => {
  const name = document.getElementById("new-subcat").value.trim();
  if (!name || !currentCategory) {
    return alert("⚠️ ক্যাটাগরি ও সাবক্যাটাগরি নাম দিন!");
  }

  const id = name.toLowerCase().replace(/\s+/g, "_");

  await addDoc(collection(db, "subcategories"), { 
    id, 
    name, 
    category: currentCategory 
  });

  alert("✅ সাবক্যাটাগরি তৈরি হয়েছে!");
  document.getElementById("new-subcat").value = "";
  await loadSubcategories(currentCategory);

  // auto-select
  // auto-select the new subcategory and immediately load its questions
  document.getElementById("subcategory").value = id;
  currentSubcategory = id;
  // load questions for the newly created subcategory
  loadQuestions(`${currentCategory}__${currentSubcategory}`);
}

// সাবক্যাটাগরি সিলেক্ট করলে মনে রাখা
document.getElementById("subcategory").addEventListener("change", (e) => {
  currentSubcategory = e.target.value;
  if (!currentCategory || !currentSubcategory) return;

  // নতুন কম্পোজিট কালেকশন নাম বানাও
  const collName = `${currentCategory}__${currentSubcategory}`;
  
  // এখন ওই কম্পোজিট কালেকশন থেকে প্রশ্ন লোড হবে
  loadQuestions(collName);
});

// প্রশ্ন যোগ করা (সরাসরি সাবক্যাটাগরি কালেকশনে যাবে)
window.addQuestion = async () => {
  if (!currentCategory || !currentSubcategory) {
    return alert("⚠️ আগে ক্যাটাগরি ও সাবক্যাটাগরি সিলেক্ট করুন!");
  }

  const collName = `${currentCategory}__${currentSubcategory}`;
  const quesEl = document.getElementById("question");
  const ques = quesEl ? quesEl.value.trim() : "";
  const opts = [1,2,3,4].map(i => {
    const el = document.getElementById("option"+i);
    return el ? el.value.trim() : "";
  });
  const correctRadio = document.querySelector('input[name="correct"]:checked');
  const correctIndex = correctRadio ? parseInt(correctRadio.value, 10) : NaN;
  const photoFile = document.getElementById("photo")?.files[0];

  if (!ques || opts.some(o => !o) || Number.isNaN(correctIndex)) {
    return alert("⚠️ প্রশ্ন ও সব অপশন লিখুন এবং সঠিক উত্তর সিলেক্ট করুন!");
  }

  let photoURL = "";
  try {
    if (photoFile) {
      const storageRef = ref(storage, `questions/${Date.now()}-${photoFile.name}`);
      await uploadBytes(storageRef, photoFile);
      photoURL = await getDownloadURL(storageRef);
    }

    const docRef = await addDoc(collection(db, collName), {
      id: Date.now(),
      category: currentCategory,
      subcategory: currentSubcategory,
      question: ques,
      options: opts,
      answer: opts[correctIndex],
      photo: photoURL || "",
      createdAt: new Date()
    });

    console.log("Question added:", docRef.id, "to", collName);
    alert("✅ প্রশ্ন সেভ হয়েছে!");
  } catch (e) {
    console.error("Add question failed:", e);
    alert("❌ প্রশ্ন যোগ করা যায়নি: " + (e.message || e));
    return;
  }

  // 👉 ফর্ম রিসেট না করে শুধু ইনপুট ফিল্ড ক্লিয়ার
  const qForm = document.getElementById("question-form");
  if (qForm) {
    const qEl = qForm.querySelector('#question');
    if (qEl) qEl.value = '';
    ['option1','option2','option3','option4'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    document.querySelectorAll('input[name="correct"]').forEach(r => r.checked = false);
    const photoInput = document.getElementById('photo');
    if (photoInput) photoInput.value = '';
  }

  // 👉 শেষে টেবিল রিফ্রেশ
  loadQuestions(collName);
    }
    // ---- end additions ----
// ================= Manage Notes (Drive links) ===================
window.addNote = async () => {
  try {
    const title = document.getElementById("noteTitle").value.trim();
    const url = document.getElementById("noteLink").value.trim();
    if (!title || !url) return alert("⚠️ Title এবং Drive link দিন!");

    // OPTIONAL: শুধু admin কে allow করতে চান তাহলে নিচের চেক আনকমেন্ট করুন এবং admin-email পরিবর্তন করুন
    // const user = auth.currentUser;
    // if (!user || user.email !== "youradmin@example.com") return alert("আপনার অনুমতি নেই।");

    await addDoc(collection(db, "driveLinks"), {
      title,
      url,
      createdAt: Date.now()
    });

    document.getElementById("noteTitle").value = "";
    document.getElementById("noteLink").value = "";
    loadNotes();
    alert("✅ Note added");
  } catch (e) {
    console.error("addNote error:", e);
    alert("Error: " + (e.message || e));
  }
};

window.loadNotes = async () => {
  const table = document.getElementById("notes-list");
  if (!table) return;
  table.innerHTML = "<tr><td colspan='3'>লোড হচ্ছে...</td></tr>";
  try {
    const qSnap = await getDocs(query(collection(db, "driveLinks"), orderBy("createdAt", "desc")));
    let rows = "";
    qSnap.forEach(docSnap => {
      const d = docSnap.data() || {};
      rows += `<tr>
        <td>${(d.title)||""}</td>
        <td><a href="${(d.url)||"#"}" target="_blank" class="text-blue-500 underline">Open</a></td>
        <td><button onclick="deleteNote('${docSnap.id}')" class="bg-red-500 text-white px-2 py-1 rounded">🗑</button></td>
      </tr>`;
    });
    table.innerHTML = rows || "<tr><td colspan='3'>কোনো Note নাই</td></tr>";
  } catch (e) {
    console.error("loadNotes error:", e);
    table.innerHTML = `<tr><td colspan='3'>লোডে সমস্যা: ${e.message || e}</td></tr>`;
  }
};

window.deleteNote = async (id) => {
  if(!confirm("Are you sure to delete this note?")) return;
  try {
    await deleteDoc(doc(db, "driveLinks", id));
    loadNotes();
  } catch (e) {
    console.error("deleteNote error:", e);
    alert("Delete failed: " + (e.message || e));
  }
};
// ==============================================================

// ===== TZ FINANCE FUNCTIONS (scoped, module) =====

async function tz_loadBatches(){
  try{
    const q = query(collection(db,"batches"), orderBy("name"));
    const snap = await getDocs(q);
    const container = document.getElementById("tz-batch-list");
    if(!container){ console.error('tz-batch-list element not found'); return; }
    container.innerHTML = "";
    if(snap.empty){ container.innerHTML = "No batches"; return; }
    snap.forEach(docSnap=>{
      const b = docSnap.data();
      const batchId = docSnap.id; // capture id to avoid closure pitfalls
      const wrapper = document.createElement("div");
      wrapper.className = "w-full text-left px-3 py-2 tz-glass hover:bg-white/10 flex justify-between items-center text-white";
      const nameBtn = document.createElement("button");
      nameBtn.className = "flex-1 text-left";
      nameBtn.innerHTML = `<span>${b.name||batchId}</span>`;
      nameBtn.addEventListener('click', async (e)=>{ 
        e.stopPropagation(); 
        try{
          await tz_loadStudents(batchId);
        }catch(err){
          console.error('tz_loadStudents failed:', err);
          const list = document.getElementById('tz-student-list');
          if(list) list.innerHTML = `<div class="p-3 text-red-400">Error loading students: ${err.message||err}</div>`;
        }
      });
      const delBtn = document.createElement("button");
      delBtn.className = "bg-red-600 px-2 py-1 rounded ml-2 text-sm";
      delBtn.title = "Delete batch";
      delBtn.innerHTML = "🗑";
      delBtn.addEventListener('click', async (e)=>{ 
        e.stopPropagation();
        if(!confirm('Delete this batch?')) return;
        try{ 
          await deleteDoc(doc(db,'batches',batchId)); 
          alert('Batch deleted'); 
          await tz_loadBatches(); 
        } catch(err){ 
          console.error('delete batch', err); 
          alert('Delete failed: '+(err.message||err)); 
        } 
      });
      wrapper.appendChild(nameBtn);
      wrapper.appendChild(delBtn);
      container.appendChild(wrapper);
    });
    await tz_populateBatchSelect();
  }catch(e){ console.error('tz_loadBatches', e); const el=document.getElementById('tz-batch-list'); if(el) el.innerText='Error'; }
}


async function tz_populateBatchSelect(){
  try{
    const sel = document.getElementById("tz-student-batch-select");
    if(!sel) return;
    sel.innerHTML = '<option value="">-- Select Batch --</option>';
    const snap = await getDocs(query(collection(db,"batches"), orderBy("name")));
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const opt = document.createElement("option");
      opt.value = docSnap.id;
      opt.textContent = d.name || docSnap.id;
      sel.appendChild(opt);
    });
  }catch(e){ console.error("tz_populateBatchSelect", e); }
}

// show/hide batch form
document.getElementById("tz-show-add-batch")?.addEventListener("click", ()=>{
  const f = document.getElementById("tz-batch-form");
  if(f) f.classList.toggle("hidden");
});

// save batch
document.getElementById("tz-save-batch")?.addEventListener("click", async ()=>{
  const name = document.getElementById("tz-new-batch-name").value.trim();
  if(!name){ alert("Enter batch name"); return; }
  try{
    await addDoc(collection(db,"batches"), { name, createdAt: Date.now() });
    document.getElementById("tz-new-batch-name").value = "";
    await tz_loadBatches();
    alert("Batch created");
  }catch(e){ console.error(e); alert("Error creating batch"); }
});

// load students for a batch

async function tz_loadStudents(batchId){
  const list = document.getElementById("tz-student-list");
  if(!list){ console.error('tz-student-list not found'); return; }
  list.innerHTML = "Loading...";
  try{
    const q = query(collection(db,"students"), where("batch","==",batchId), orderBy("createdAt"));
    const snap = await getDocs(q);
    list.innerHTML = "";
    if(!snap || snap.empty){ list.innerHTML = "No students"; return; }
    snap.forEach(docSnap=>{
      const s = docSnap.data();
      const studentId = docSnap.id;
      const el = document.createElement("div");
      el.className = "p-3 tz-glass flex justify-between items-center text-white";
      const infoDiv = document.createElement("div");
      infoDiv.innerHTML = `<div class="font-semibold">${s.name||"(No name)"}</div><div class="text-xs">${s.phone||""}</div>`;
      const btnsDiv = document.createElement("div");
      btnsDiv.className = "flex gap-2";
      const openBtn = document.createElement("button");
      openBtn.className = "bg-blue-500 px-2 py-1 rounded text-white";
      openBtn.textContent = "Open";
      openBtn.addEventListener('click', ()=> tz_openStudentFinance(studentId));
      const delBtn = document.createElement("button");
      delBtn.className = "bg-red-600 px-2 py-1 rounded text-white";
      delBtn.textContent = "🗑";
      delBtn.title = "Delete student";
      delBtn.addEventListener('click', async ()=>{
        if(!confirm('Delete this student?')) return;
        try{ 
          await deleteDoc(doc(db,'students',studentId)); 
          alert('Student deleted'); 
          await reorderRolls(batchId); 
          await tz_loadStudents(batchId); 
        }catch(err){ 
          console.error('deleteStudent', err); 
          alert('Delete failed: '+(err.message||err)); 
        } 
      });
      btnsDiv.appendChild(openBtn);
      btnsDiv.appendChild(delBtn);
      el.appendChild(infoDiv);
      el.appendChild(btnsDiv);
      list.appendChild(el);
    });
  }catch(e){ console.error('tz_loadStudents', e); list.innerHTML = `<div class="p-3 text-red-400">Error loading students: ${e.message||e}</div>`; }
}


// show student modal
document.getElementById("tz-show-add-student")?.addEventListener("click", async ()=>{
  await tz_populateBatchSelect();
  const modal = document.getElementById("tz-student-modal");
  if(modal) modal.classList.remove("hidden");
});
document.getElementById("tz-close-student-form")?.addEventListener("click", ()=>{ const m=document.getElementById("tz-student-modal"); if(m) m.classList.add("hidden"); });
document.getElementById("tz-cancel-student-btn")?.addEventListener("click", ()=>{ const m=document.getElementById("tz-student-modal"); if(m) m.classList.add("hidden"); });

// save student
document.getElementById("tz-save-student-btn")?.addEventListener("click", async ()=>{
  const name = document.getElementById("tz-student-name").value.trim();
  const phone = document.getElementById("tz-student-phone").value.trim();
  const whatsapp = document.getElementById("tz-student-whatsapp").value.trim();
  const email = document.getElementById("tz-student-email").value.trim();
  const father = document.getElementById("tz-student-father").value.trim();
  const address = document.getElementById("tz-student-address").value.trim();
  const education = document.getElementById("tz-student-education").value.trim();
  const batch = document.getElementById("tz-student-batch-select").value;
  const dob = document.getElementById("tz-student-dob").value;
  // photo upload removed
    // const photoFile = document.getElementById("tz-student-photo").files[0];
  if(!name||!phone||!batch){ alert("Name, phone and batch required"); return; }
  try{
    let photoURL = "";
    if(false){ // photo disabled
      const storageRef = ref(storage, `students/${Date.now()}-${photoFile.name}`);
      await uploadBytes(storageRef, photoFile);
      photoURL = await getDownloadURL(storageRef);
    }
    const docRef = await addDoc(collection(db,"students"), { name, phone, whatsapp, email, father, address, education, batch, dob, photoURL, createdAt: Date.now() });
    await updateDoc(doc(db,"students",docRef.id), { studentAutoId: "STU-"+docRef.id.slice(-6).toUpperCase() });
    alert("Student added");
    const modal = document.getElementById("tz-student-modal"); if(modal) modal.classList.add("hidden");
    await tz_loadStudents(batch);
  }catch(e){ console.error("tz_saveStudent", e); alert("Error adding student: " + (e.message || e)); }
});

// open student finance/profile (expose on window so onclick can call)
window.tz_openStudentFinance = async function(studentId){
  try{
    const docRef = doc(db,"students",studentId);
    const snap = await getDoc(docRef);
    if(!snap.exists()){ alert("Student not found"); return; }
    const data = snap.data();
    const area = document.getElementById("tz-profile-area");
    let photo = ""; // photo disabled
    let info = `<div class="flex items-center gap-3"><div><div class="font-bold text-lg">${data.name||""}</div><div class="text-sm">${data.studentAutoId||studentId}</div><div class="text-sm">${data.batch||""}</div></div></div>
    <div class="mt-2 text-sm"><p><b>Phone:</b> ${data.phone||""}</p><p><b>WhatsApp:</b> ${data.whatsapp||""}</p><p><b>Email:</b> ${data.email||""}</p><p><b>DOB:</b> ${data.dob||""}</p></div>
    <hr class="my-2"/><h5 class="font-semibold">Monthly Payments</h5>
    <table class="w-full text-sm"><thead><tr><th>Month</th><th>Amount</th><th>Action</th></tr></thead><tbody id="tz-finance-rows"></tbody></table>
    <div class="mt-2 flex gap-2"><select id="tz-pay-month" class="border px-2 py-1"></select><input id="tz-pay-amount" type="number" placeholder="Amount" class="border px-2 py-1"/><button id="tz-pay-add" class="bg-blue-600 text-white px-3 py-1 rounded">Add</button></div>`;
    area.innerHTML = info;
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const sel = document.getElementById("tz-pay-month"); sel.innerHTML = months.map(m=>`<option value="${m}">${m}</option>`).join('');
    const tbody = document.getElementById("tz-finance-rows");
    tbody.innerHTML = "";
    months.forEach(m=>{
      const amt = data[m]||"";
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${m}</td><td>${amt}</td><td>${amt?'<button class="bg-red-600 text-white px-2 py-1 rounded" data-month="'+m+'">Del</button>':'-'}</td>`;
      tbody.appendChild(tr);
    });
    // bind add and delete
    document.getElementById("tz-pay-add")?.addEventListener("click", async ()=>{
      const month = document.getElementById("tz-pay-month").value;
      const amount = Number(document.getElementById("tz-pay-amount").value);
      if(!month||!amount){ alert("Enter month and amount"); return; }
      await updateDoc(doc(db,"students",studentId),{[month]:amount});
      document.getElementById("tz-pay-amount").value='';
      tz_openStudentFinance(studentId);
    });
    tbody.querySelectorAll('button[data-month]').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const month = e.target.getAttribute('data-month');
        await updateDoc(doc(db,"students",studentId),{[month]:""});
        tz_openStudentFinance(studentId);
      });
    });
  }catch(e){ console.error("tz_openStudentFinance", e); alert("Error opening profile"); }
}

// load batches when finance section is shown (attach to existing showSection calls via nav buttons)
document.querySelectorAll("button[onclick^=\"showSection('\"]").forEach(btn=>{
  const onclick = btn.getAttribute('onclick') || '';
  if(onclick.includes("showSection('finance')")){
    btn.addEventListener('click', ()=>{ setTimeout(()=>{ tz_loadBatches(); }, 200); });
  }
});

// initial no-op
// ===== end tz helpers =====
// === Custom Deletion Functions ===
window.deleteBatch = async (id)=>{
  if(!confirm("Delete this batch?")) return;
  await deleteDoc(doc(db,"batches",id));
  alert("Batch deleted");
  tz_loadBatches?.();
};


window.deleteStudent = async (id, batchId)=>{
  if(!confirm("Delete this student?")) return;
  try{
    await deleteDoc(doc(db,"students",id));
    alert("Student deleted");
    if(batchId){
      await reorderRolls(batchId);
      tz_loadStudents?.(batchId);
    } else if(typeof currentBatchId!=='undefined' && currentBatchId){
      await reorderRolls(currentBatchId);
      tz_loadStudents?.(currentBatchId);
    }
  }catch(e){ console.error("deleteStudent", e); alert("Student delete failed: "+(e.message||e)); }
};

async function reorderRolls(batchId){
  try{
    const q = query(collection(db,"students"), where("batch","==",batchId), orderBy("createdAt"));
    const snap = await getDocs(q);
    let i=1;
    for(const docSnap of snap.docs){
      await updateDoc(doc(db,"students",docSnap.id), { roll: i });
      i++;
    }
  }catch(e){ console.error("reorderRolls", e); }
}
;

</script>
<script>
    // Sidebar toggle
    document.getElementById("menu-btn").addEventListener("click",()=>{document.getElementById("sidebar").classList.remove("hidden");});
    document.getElementById("close-sidebar").addEventListener("click",()=>{document.getElementById("sidebar").classList.add("hidden");});

    // Background Animation
    const canvas=document.getElementById("bg-canvas");
    const ctx=canvas.getContext("2d");
    canvas.width=window.innerWidth; canvas.height=window.innerHeight;
    let stars=[], planes=[];
    for(let i=0;i<150;i++){stars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*2,dx:(Math.random()-0.5)*0.5,dy:(Math.random()-0.5)*0.5});}
    for(let i=0;i<2;i++){planes.push({x:-50,y:Math.random()*canvas.height/2,dx:2+Math.random()*2,size:20});}
    function draw(){
      ctx.fillStyle="rgba(0,0,30,0.4)"; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle="white"; stars.forEach(s=>{ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();s.x+=s.dx;s.y+=s.dy;if(s.x<0||s.x>canvas.width) s.dx*=-1;if(s.y<0||s.y>canvas.height) s.dy*=-1;});
      planes.forEach(p=>{ctx.fillStyle="lightblue";ctx.fillRect(p.x,p.y,p.size,3);ctx.fillStyle="white";ctx.fillRect(p.x-5,p.y+1,10,1);p.x+=p.dx;if(p.x>canvas.width+50){p.x=-50;p.y=Math.random()*canvas.height/2;}});
    }
    setInterval(draw,30);
  
    


// Student Modal Toggle
document.getElementById("show-add-student")?.addEventListener("click", ()=>{
  document.getElementById("student-modal").classList.remove("hidden");
  populateStudentBatchSelect();
});
document.getElementById("close-student-modal")?.addEventListener("click", ()=>{
  document.getElementById("student-modal").classList.add("hidden");
});
document.getElementById("student-form")?.addEventListener("submit", async (e)=>{
  e.preventDefault();
  await addStudent();
  document.getElementById("student-modal").classList.add("hidden");
});
</script>
<!-- Student Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" id="student-modal">
<div class="bg-white p-6 rounded-xl shadow-lg max-w-lg w-full overflow-y-auto max-h-screen">
<h3 class="text-xl font-bold mb-4">Add Student</h3>
<form class="space-y-3" id="student-form">
<input class="w-full border p-2 rounded" id="student-name" placeholder="Name" required="">
<input class="w-full border p-2 rounded" id="student-phone" placeholder="Phone" required="">
<input class="w-full border p-2 rounded" id="student-whatsapp" placeholder="WhatsApp"/>
<input class="w-full border p-2 rounded" id="student-email" placeholder="Email"/>
<input class="w-full border p-2 rounded" id="student-father" placeholder="Father/Mother Name"/>
<input class="w-full border p-2 rounded" id="student-address" placeholder="Address"/>
<input class="w-full border p-2 rounded" id="student-education" placeholder="Education Level"/>
<input class="w-full border p-2 rounded" id="student-dob" type="date"/>
<input class="w-full border p-2 rounded" id="student-photo" type="file"/>
<select class="w-full border p-2 rounded" id="student-batch-select"></select>
<div class="flex justify-end space-x-2">
<button class="px-4 py-2 bg-gray-300 rounded" id="close-student-modal" type="button">Cancel</button>
<button class="px-4 py-2 bg-green-500 text-white rounded" type="submit">Save</button>
</div>
</input></input></form>
</div>
</div>
</body>
</html>
